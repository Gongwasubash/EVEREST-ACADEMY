{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>School Calendar - {{ school.school_name|default:"School Management System" }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #1e3a8a;
            --secondary-color: #3b82f6;
            --accent-color: #f59e0b;
            --text-dark: #1f2937;
            --text-light: #6b7280;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: white;
            min-height: 100vh;
            padding-top: 80px;
        }
        
        .navbar {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 1rem 0;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(0,0,0,0.08);
            box-shadow: 0 2px 20px rgba(0,0,0,0.05);
        }
        
        .navbar-brand {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1a202c !important;
            display: flex;
            align-items: center;
            text-decoration: none;
            letter-spacing: -0.025em;
        }
        
        .navbar-brand img {
            width: 48px;
            height: 48px;
            object-fit: contain;
            margin-right: 12px;
        }
        
        .navbar-nav .nav-link {
            color: #4a5568 !important;
            margin: 0 0.5rem;
            padding: 0.75rem 1.25rem !important;
            font-weight: 500;
            font-size: 1rem;
            transition: all 0.2s ease;
            border-radius: 6px;
        }
        
        .navbar-nav .nav-link:hover {
            color: #1a202c !important;
            background: rgba(26, 32, 44, 0.05);
        }
        .calendar-wrapper {
            max-width: 1000px;
            margin: 120px auto 50px;
            padding: 0 20px;
        }
        .calendar-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .calendar-header {
            background: linear-gradient(135deg, #1e3a8a, #3b82f6);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .calendar-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        .calendar-subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }
        .month-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: #f8fafc;
            border-bottom: 1px solid #e2e8f0;
        }
        .nav-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .nav-button:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }
        .current-month {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: #e5e7eb;
            margin: 0;
        }
        .day-header {
            background: #374151;
            color: white;
            padding: 10px 5px;
            text-align: center;
            font-weight: 600;
            font-size: 0.9rem;
        }
        .day-header small {
            font-size: 0.7rem;
            opacity: 0.8;
            font-weight: 400;
        }
        .day-cell {
            background: white;
            min-height: 120px;
            padding: 10px;
            position: relative;
            transition: all 0.2s ease;
        }
        .nepali-date {
            font-size: 1.4rem;
            color: #374151;
            margin-top: 4px;
            font-weight: 700;
        }
        .day-cell:hover {
            background: #f3f4f6;
        }
        .day-number {
            font-weight: 400;
            font-size: 0.8rem;
            color: #9ca3af;
            margin-bottom: 2px;
        }
        .today {
            background: rgba(59, 130, 246, 0.1) !important;
            border: 2px solid rgba(59, 130, 246, 0.3) !important;
            box-shadow: 0 0 8px rgba(59, 130, 246, 0.15);
        }
        
        .today .day-number {
            color: #1d4ed8;
            font-weight: 700;
        }
        
        .today .nepali-date {
            color: #1d4ed8 !important;
            font-weight: 600;
        }
        .other-month {
            background: #f9fafb;
            opacity: 0.5;
        }
        
        .today.other-month {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            opacity: 1 !important;
        }
        .event-badge {
            background: #10b981;
            color: white;
            padding: 3px 8px;
            border-radius: 15px;
            font-size: 0.7rem;
            margin-bottom: 3px;
            display: block;
            text-align: center;
            font-weight: 500;
        }
        .event-badge.holiday {
            background: #ef4444;
        }
        .event-badge.exam {
            background: #f59e0b;
        }
        .event-badge.festival {
            background: #8b5cf6;
        }
        .legend-section {
            padding: 20px 30px;
            background: #f8fafc;
            display: flex;
            justify-content: center;
            gap: 30px;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            color: #4b5563;
        }
        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        .footer {
            background: var(--text-dark);
            color: white;
            padding: 50px 0 20px;
            margin-top: 50px;
        }
        
        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 2rem;
        }
        
        .footer-section h4 {
            color: var(--accent-color);
            margin-bottom: 1rem;
        }
        
        .footer-section ul {
            list-style: none;
            padding: 0;
        }
        
        .footer-section ul li {
            margin-bottom: 0.5rem;
        }
        
        .footer-section ul li a {
            color: #d1d5db;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        
        .footer-section ul li a:hover {
            color: var(--accent-color);
        }
        
        .footer-bottom {
            border-top: 1px solid #374151;
            padding-top: 1rem;
            text-align: center;
            color: #9ca3af;
        }
        @media (max-width: 768px) {
            .calendar-wrapper {
                margin: 100px auto 30px;
                padding: 0 10px;
            }
            .calendar-header {
                padding: 20px;
            }
            .calendar-title {
                font-size: 1.5rem;
            }
            .month-navigation {
                padding: 15px 20px;
            }
            .current-month {
                font-size: 1.2rem;
            }
            .day-cell {
                min-height: 80px;
                padding: 5px;
            }
            .nepali-date {
                font-size: 1rem;
            }
            .day-number {
                font-size: 0.7rem;
            }
            .legend-section {
                padding: 15px 20px;
                gap: 15px;
            }
        }
        @media (max-width: 480px) {
            .nepali-date {
                font-size: 0.9rem;
            }
            .day-number {
                font-size: 0.6rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="{% static 'img/Everest-Crest-Square.png' %}" alt="School Logo">
                {{ school.school_name|default:"School Management System" }}
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon" style="background-image: url('data:image/svg+xml,%3csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 30 30%27%3e%3cpath stroke=%27rgba%2833, 37, 41, 0.75%29%27 stroke-linecap=%27round%27 stroke-miterlimit=%2710%27 stroke-width=%272%27 d=%27M4 7h22M4 15h22M4 23h22%27/%3e%3c/svg%3e');"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">Home</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#about">About</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#values">Values</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#news">News</a></li>
                    <li class="nav-item"><a class="nav-link" href="/public-school-calendar/">School Calendar</a></li>
                    <li class="nav-item"><a class="nav-link" href="{% url 'public_registration' %}">Registration</a></li>
                    <li class="nav-item"><a class="nav-link" href="/#contact">Contact</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Calendar Wrapper -->
    <div class="calendar-wrapper">
        <div class="calendar-card">
            <!-- Header -->
            <div class="calendar-header">
                <h1 class="calendar-title">Academic Calendar</h1>
                <p class="calendar-subtitle">{{ school.school_name|default:"School Management System" }}</p>
            </div>

            <!-- Month Navigation -->
            <div class="month-navigation">
                <button class="nav-button" onclick="previousMonth()">
                    <i class="fas fa-chevron-left me-2"></i>Previous
                </button>
                <div class="current-month" id="currentMonth">January 2025</div>
                <button class="nav-button" onclick="nextMonth()">
                    Next<i class="fas fa-chevron-right ms-2"></i>
                </button>
            </div>

            <!-- Calendar Grid -->
            <div class="calendar-grid">
                <!-- Day Headers -->
                <div class="day-header">आइतबार<br><small>Sunday</small></div>
                <div class="day-header">सोमबार<br><small>Monday</small></div>
                <div class="day-header">मंगलबार<br><small>Tuesday</small></div>
                <div class="day-header">बुधबार<br><small>Wednesday</small></div>
                <div class="day-header">बिहिबार<br><small>Thursday</small></div>
                <div class="day-header">शुक्रबार<br><small>Friday</small></div>
                <div class="day-header">शनिबार<br><small>Saturday</small></div>
            </div>
            
            <!-- Calendar Days Grid -->
            <div class="calendar-grid" id="calendarDays"></div>

            <!-- Legend -->
            <div class="legend-section">
                <div class="legend-item">
                    <div class="legend-dot" style="background: #10b981;"></div>
                    <span>School Events</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #ef4444;"></div>
                    <span>Holidays</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #f59e0b;"></div>
                    <span>Examinations</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #8b5cf6;"></div>
                    <span>Festivals</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href="/#about">About Us</a></li>
                        <li><a href="/#schools">Our Schools</a></li>
                        <li><a href="{% url 'public_registration' %}">Admissions</a></li>
                        <li><a href="{% url 'studentlist' %}">Student Portal</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Academic</h4>
                    <ul>
                        <li><a href="#">Curriculum</a></li>
                        <li><a href="#">Faculty</a></li>
                        <li><a href="#">Academic Calendar</a></li>
                        <li><a href="{% url 'reports' %}">Results</a></li>
                        <li><a href="#">Library</a></li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Contact Info</h4>
                    <ul>
                        <li><i class="fas fa-map-marker-alt me-2"></i>{{ school.address|default:"School Address" }}</li>
                        <li><i class="fas fa-phone me-2"></i>{{ school.phone|default:"+977-1-XXXXXXX" }}</li>
                        <li><i class="fas fa-envelope me-2"></i>{{ school.email|default:"info@school.edu.np" }}</li>
                    </ul>
                </div>
                <div class="footer-section">
                    <h4>Follow Us</h4>
                    <ul>
                        <li><a href="#"><i class="fab fa-facebook me-2"></i>Facebook</a></li>
                        <li><a href="#"><i class="fab fa-twitter me-2"></i>Twitter</a></li>
                        <li><a href="#"><i class="fab fa-instagram me-2"></i>Instagram</a></li>
                        <li><a href="#"><i class="fab fa-youtube me-2"></i>YouTube</a></li>
                    </ul>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2024 {{ school.school_name|default:"School Management System" }}. All rights reserved. | Developed with Django</p>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const today = new Date();
        const todayNepali = convertToNepali(today.getFullYear(), today.getMonth(), today.getDate());
        let currentNepaliYear = todayNepali.year;
        let currentNepaliMonth = todayNepali.month - 1;
        const nepaliMonths = ['बैशाख', 'जेठ', 'आषाढ', 'श्रावण', 'भाद्र', 'आश्विन', 'कार्तिक', 'मंसिर', 'पुष', 'माघ', 'फाल्गुन', 'चैत्र'];
        const englishMonths = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const daysInNepaliMonths = [31, 31, 31, 32, 31, 30, 29, 30, 29, 30, 29, 30];
        
        function convertToDevanagari(number) {
            const devanagariDigits = ['०', '१', '२', '३', '४', '५', '६', '७', '८', '९'];
            return number.toString().split('').map(digit => devanagariDigits[parseInt(digit)]).join('');
        }
        
        function convertToNepali(englishYear, englishMonth, englishDay) {
            const referenceEnglish = new Date(2024, 11, 21); // Dec 21, 2024
            const referenceNepali = { year: 2081, month: 9, day: 6 }; // 6 Poush 2081
            
            const inputDate = new Date(englishYear, englishMonth, englishDay);
            const daysDiff = Math.floor((inputDate - referenceEnglish) / (1000 * 60 * 60 * 24));
            
            let nepaliYear = referenceNepali.year;
            let nepaliMonth = referenceNepali.month;
            let nepaliDay = referenceNepali.day + daysDiff;
            
            const daysInNepaliMonths = [31, 31, 31, 32, 31, 30, 29, 30, 29, 30, 29, 30];
            
            while (nepaliDay > daysInNepaliMonths[nepaliMonth - 1]) {
                nepaliDay -= daysInNepaliMonths[nepaliMonth - 1];
                nepaliMonth++;
                if (nepaliMonth > 12) {
                    nepaliMonth = 1;
                    nepaliYear++;
                }
            }
            
            while (nepaliDay < 1) {
                nepaliMonth--;
                if (nepaliMonth < 1) {
                    nepaliMonth = 12;
                    nepaliYear--;
                }
                nepaliDay += daysInNepaliMonths[nepaliMonth - 1];
            }
            
            return { year: nepaliYear, month: nepaliMonth, day: nepaliDay };
        }

        // Events from database
        const events = {{ events_json|safe }};

        function convertNepaliToEnglish(nepaliYear, nepaliMonth, nepaliDay) {
            const referenceNepali = { year: 2081, month: 9, day: 6 }; // 6 Poush 2081
            const referenceEnglish = new Date(2024, 11, 21); // Dec 21, 2024 (Saturday)
            
            let totalDays = 0;
            let currentYear = referenceNepali.year;
            let currentMonth = referenceNepali.month;
            let currentDay = referenceNepali.day;
            
            if (nepaliYear > currentYear || (nepaliYear === currentYear && nepaliMonth > currentMonth) || 
                (nepaliYear === currentYear && nepaliMonth === currentMonth && nepaliDay > currentDay)) {
                while (currentYear < nepaliYear || currentMonth < nepaliMonth || currentDay < nepaliDay) {
                    if (currentDay < daysInNepaliMonths[currentMonth - 1]) {
                        currentDay++;
                        totalDays++;
                    } else {
                        currentDay = 1;
                        currentMonth++;
                        totalDays++;
                        if (currentMonth > 12) {
                            currentMonth = 1;
                            currentYear++;
                        }
                    }
                }
            } else {
                while (currentYear > nepaliYear || currentMonth > nepaliMonth || currentDay > nepaliDay) {
                    if (currentDay > 1) {
                        currentDay--;
                        totalDays--;
                    } else {
                        currentMonth--;
                        if (currentMonth < 1) {
                            currentMonth = 12;
                            currentYear--;
                        }
                        currentDay = daysInNepaliMonths[currentMonth - 1];
                        totalDays--;
                    }
                }
            }
            
            const resultDate = new Date(referenceEnglish.getTime() + (totalDays * 24 * 60 * 60 * 1000));
            return resultDate;
        }
        
        function generateNepaliCalendar(nepaliYear, nepaliMonth) {
            const calendarDays = document.getElementById('calendarDays');
            calendarDays.innerHTML = '';
            
            const daysInMonth = daysInNepaliMonths[nepaliMonth];
            const firstDayEnglish = convertNepaliToEnglish(nepaliYear, nepaliMonth + 1, 1);
            // Adjust for Sunday=0 to match our header (Sunday first)
            let startingDayOfWeek = firstDayEnglish.getDay();
            
            for (let i = 0; i < startingDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell other-month';
                calendarDays.appendChild(emptyCell);
            }
            
            for (let nepaliDay = 1; nepaliDay <= daysInMonth; nepaliDay++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'day-cell';
                
                const englishDate = convertNepaliToEnglish(nepaliYear, nepaliMonth + 1, nepaliDay);
                
                const today = new Date();
                const todayNepali = convertToNepali(today.getFullYear(), today.getMonth(), today.getDate());
                
                if (nepaliDay === todayNepali.day && nepaliMonth + 1 === todayNepali.month && nepaliYear === todayNepali.year) {
                    dayCell.classList.add('today');
                }
                
                const dayNumber = document.createElement('div');
                dayNumber.className = 'day-number';
                dayNumber.textContent = `${englishDate.getDate()} ${englishMonths[englishDate.getMonth()]}`;
                dayCell.appendChild(dayNumber);
                
                const nepaliDateDiv = document.createElement('div');
                nepaliDateDiv.className = 'nepali-date';
                nepaliDateDiv.textContent = convertToDevanagari(nepaliDay);
                dayCell.appendChild(nepaliDateDiv);
                
                // Add events for this date - shift by +1 day
                const adjustedDate = new Date(englishDate);
                adjustedDate.setDate(adjustedDate.getDate() + 1);
                const dateKey = adjustedDate.toISOString().split('T')[0];
                if (events[dateKey]) {
                    events[dateKey].forEach(event => {
                        const eventDiv = document.createElement('div');
                        eventDiv.className = `event-badge ${event.type}`;
                        eventDiv.textContent = event.title;
                        eventDiv.title = event.description || event.title;
                        dayCell.appendChild(eventDiv);
                    });
                }
                
                calendarDays.appendChild(dayCell);
            }
            
            const totalCells = calendarDays.children.length;
            for (let i = totalCells; i < 42; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'day-cell other-month';
                calendarDays.appendChild(emptyCell);
            }
            
            document.getElementById('currentMonth').textContent = 
                `${nepaliMonths[nepaliMonth]} ${convertToDevanagari(nepaliYear)}`;
        }

        function previousMonth() {
            currentNepaliMonth--;
            if (currentNepaliMonth < 0) {
                currentNepaliMonth = 11;
                currentNepaliYear--;
            }
            generateNepaliCalendar(currentNepaliYear, currentNepaliMonth);
        }

        function nextMonth() {
            currentNepaliMonth++;
            if (currentNepaliMonth > 11) {
                currentNepaliMonth = 0;
                currentNepaliYear++;
            }
            generateNepaliCalendar(currentNepaliYear, currentNepaliMonth);
        }

        document.addEventListener('DOMContentLoaded', function() {
            generateNepaliCalendar(currentNepaliYear, currentNepaliMonth);
            
            // Debug: Show today's day alignment
            const today = new Date();
            const todayNepali = convertToNepali(today.getFullYear(), today.getMonth(), today.getDate());
            const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const nepaliDayNames = ['आइतबार', 'सोमबार', 'मंगलबार', 'बुधबार', 'बिहिबार', 'शुक्रबार', 'शनिबार'];
            
            console.log(`Today's English date: ${today.toDateString()} (${dayNames[today.getDay()]})`);
            console.log(`Today's Nepali date: ${todayNepali.day} ${nepaliMonths[todayNepali.month-1]} ${todayNepali.year}`);
            
            // Verify the conversion back to English
            const backToEnglish = convertNepaliToEnglish(todayNepali.year, todayNepali.month, todayNepali.day);
            console.log(`Nepali date converted back to English: ${backToEnglish.toDateString()} (${dayNames[backToEnglish.getDay()]})`);
            
            // Debug event mapping
            console.log('Available events:', events);
            Object.keys(events).forEach(dateKey => {
                const eventDate = new Date(dateKey);
                console.log(`Event on ${eventDate.toDateString()} (${dayNames[eventDate.getDay()]}):`, events[dateKey]);
            });
        });
    </script>
</body>
</html>