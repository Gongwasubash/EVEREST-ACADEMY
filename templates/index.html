{% extends "base.html" %}
{% load static %}

{% block title %}Dashboard - School Management{% endblock %}

{% block extra_css %}
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/chart-fix.css' %}">
<link rel="stylesheet" href="{% static 'css/collection-fix.css' %}">
<link rel="stylesheet" href="{% static 'css/student-chart-fix.css' %}">
<link rel="stylesheet" href="{% static 'css/stats-card-fix.css' %}">
<link rel="stylesheet" href="{% static 'css/actions-height-fix.css' %}">
<link rel="stylesheet" href="{% static 'css/action-button-fix.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard-sidebar-fix.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard-layout-fix.css' %}">
<link rel="stylesheet" href="{% static 'css/charts-responsive.css' %}">
<link rel="stylesheet" href="{% static 'css/interactive-collection.css' %}">
{% endblock %}

{% block content %}
<div class="modern-dashboard">


    <!-- Statistics Cards -->
    <section class="stats-section">
        <div class="stats-grid">
            <div class="stat-card students-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M16,4C16,2.89 15.11,2 14,2H10C8.89,2 8,2.89 8,4H5C3.89,4 3,4.89 3,6V20C3,21.11 3.89,22 5,22H19C20.11,22 21,21.11 21,20V6C21,4.89 20.11,4 19,4H16M10,4H14V6H10V4Z"/>
                    </svg>
                </div>
                <div class="stat-info">
                    <h3>{{ total_students }}</h3>
                    <p>Total Students</p>
                    <span class="stat-trend positive">+5.2%</span>
                </div>
            </div>

            <div class="stat-card session-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z"/>
                    </svg>
                </div>
                <div class="stat-info">
                    <h3>2025-26</h3>
                    <p>Current Session</p>
                    <span class="stat-trend neutral">Active</span>
                </div>
            </div>

            <div class="stat-card birthday-card">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,6A3,3 0 0,1 15,9A3,3 0 0,1 12,12A3,3 0 0,1 9,9A3,3 0 0,1 12,6M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                    </svg>
                </div>
                <div class="stat-info">
                    <h3>{{ todays_birthdays }}</h3>
                    <p>Today's Birthdays</p>
                    <span class="stat-trend positive">Celebrate!</span>
                </div>
            </div>

            <div class="stat-card enquiry-card" onclick="window.location.href='{% url 'pending_enquiry' %}'">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20,2H4A2,2 0 0,0 2,4V22L6,18H20A2,2 0 0,0 22,16V4C22,2.89 21.1,2 20,2Z"/>
                    </svg>
                </div>
                <div class="stat-info">
                    <h3>{{ pending_enquiries|default:0 }}</h3>
                    <p>Pending Enquiries</p>
                    <span class="stat-trend warning">Action needed</span>
                </div>
            </div>

            <div class="stat-card attendance-card" onclick="window.location.href='/attendance-report/'">
                <div class="stat-icon">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4M16.5,7.5L15.09,8.91L11,12.5V7H12.5V11.5L15.59,8.91L16.5,7.5Z"/>
                    </svg>
                </div>
                <div class="stat-info">
                    <h3>{{ attendance_percentage }}%</h3>
                    <p>Today's Attendance</p>
                    <span class="stat-trend {% if attendance_percentage >= 90 %}positive{% elif attendance_percentage >= 75 %}neutral{% else %}warning{% endif %}">{{ total_present }}/{{ total_students }} Present</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Collections and Student Distribution Section -->
    <section class="collections-student-section">
        <div class="left-column">
            <div class="collections-section">
                <div class="collections-card">
                    <div class="card-header">
                        <h2 class="card-title">Fee Collections</h2>
                    </div>
                    <div class="collection-merged">
                        <div class="collection-item interactive" onclick="window.location.href='{% url 'collection_details' 'today' %}'">
                            <div class="collection-header">
                                <h4>Today's Collection</h4>
                                <div class="collection-trend positive">+12%</div>
                            </div>
                            <span class="amount">Rs {{ todays_collection|default:"0" }}</span>
                            <div class="collection-details">
                                <small>{{ total_present|default:0 }} payments today</small>
                            </div>
                        </div>
                        <div class="collection-item interactive" onclick="window.location.href='{% url 'collection_details' 'weekly' %}'">
                            <div class="collection-header">
                                <h4>Weekly Collection</h4>
                                <div class="collection-trend positive">+8%</div>
                            </div>
                            <span class="amount">Rs {{ weekly_collection|default:"0" }}</span>
                            <div class="collection-details">
                                <small>Last 7 days</small>
                            </div>
                        </div>
                        <div class="collection-item interactive" onclick="window.location.href='{% url 'collection_details' 'monthly' %}'">
                            <div class="collection-header">
                                <h4>Monthly Collection</h4>
                                <div class="collection-trend neutral">+2%</div>
                            </div>
                            <span class="amount">Rs {{ monthly_collection|default:"0" }}</span>
                            <div class="collection-details">
                                <small>Current month</small>
                            </div>
                        </div>
                        <div class="collection-item interactive" onclick="window.location.href='{% url 'collection_details' 'yearly' %}'">
                            <div class="collection-header">
                                <h4>Yearly Collection</h4>
                                <div class="collection-trend positive">+15%</div>
                            </div>
                            <span class="amount">Rs {{ yearly_collection|default:"0" }}</span>
                            <div class="collection-details">
                                <small>{{ yearly_collection|default:0|floatformat:0 }} total payments</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="actions-section">
                <h2 class="section-title">Quick Actions</h2>
                <div class="actions-grid">
                    <button class="action-btn registration" onclick="window.location.href='{% url 'public_registration' %}'">
                        <div class="action-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z"/>
                            </svg>
                        </div>
                        <span>Registration</span>
                    </button>
                    <button class="action-btn admission" onclick="window.location.href='/student-admission/'">
                        <div class="action-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                            </svg>
                        </div>
                        <span>New Admission</span>
                    </button>
                    <button class="action-btn search" onclick="window.location.href='{% url 'search_student' %}'">
                        <div class="action-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                            </svg>
                        </div>
                        <span>Fee Search</span>
                    </button>
                    <button class="action-btn list" onclick="window.location.href='{% url 'studentlist' %}'">
                        <div class="action-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M16,4C16,2.89 15.11,2 14,2H10C8.89,2 8,2.89 8,4H5C3.89,4 3,4.89 3,6V20C3,21.11 3.89,22 5,22H19C20.11,22 21,21.11 21,20V6C21,4.89 20.11,4 19,4H16M10,4H14V6H10V4Z"/>
                            </svg>
                        </div>
                        <span>Student List</span>
                    </button>
                    <button class="action-btn expenses" onclick="window.location.href='{% url 'student_daily_exp' %}'">
                        <div class="action-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z"/>
                            </svg>
                        </div>
                        <span>Daily Expenses</span>
                    </button>
                    <button class="action-btn receipt" onclick="window.location.href='{% url 'fee_receipt_book' %}'">
                        <div class="action-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.11,3 19,3M19,5V19H5V5H19Z"/>
                            </svg>
                        </div>
                        <span>Fee Receipt</span>
                    </button>
                    <button class="action-btn id-card" onclick="showLoaderAndNavigate('{% url 'id_creation' %}')">
                        <div class="action-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M4,4H20A2,2 0 0,1 22,6V18A2,2 0 0,1 20,20H4A2,2 0 0,1 2,18V6A2,2 0 0,1 4,4M4,6V18H20V6H4M6,8H8V10H6V8M10,8H18V10H10V8M6,12H8V14H6V12M10,12H18V14H10V12M6,16H8V18H6V16M10,16H18V18H10V16Z"/>
                            </svg>
                        </div>
                        <span>ID Creation</span>
                    </button>
                    <button class="action-btn report" onclick="window.open('{% url 'fee_payment_report_dashboard' %}', '_blank')">
                        <div class="action-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                            </svg>
                        </div>
                        <span>Fee Report</span>
                    </button>
                    <button class="action-btn table" onclick="window.location.href='{% url 'student_attendance_dashboard' %}'">
                        <div class="action-icon">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M5,4H19A2,2 0 0,1 21,6V18A2,2 0 0,1 19,20H5A2,2 0 0,1 3,18V6A2,2 0 0,1 5,4M5,8V12H11V8H5M13,8V12H19V8H13M5,14V18H11V14H5M13,14V18H19V14H13Z"/>
                            </svg>
                        </div>
                        <span>Attendance</span>
                    </button>
                </div>
            </div>
        </div>
        <div class="student-distribution-side">
            <div class="chart-card main-chart">
                <h3>Student Distribution</h3>
                <div class="chart-container">
                    <canvas id="studentChart"></canvas>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content Grid -->
    <div class="main-content-grid">
        <!-- Charts Section -->
        <section class="charts-section">
            <div class="charts-row">
                <div class="chart-card">
                    <h3>Gender Ratio</h3>
                    <div class="chart-stats">
                        <span>Boys: {{ boys_count }}</span>
                        <span>Girls: {{ girls_count }}</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="genderChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Religion Data</h3>
                    <div class="chart-stats">
                        <span>Hindu: 60%</span>
                        <span>Muslim: 25%</span>
                        <span>Others: 15%</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="religionChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <h3>Category Details</h3>
                    <div class="chart-stats">
                        <span>General: 50%</span>
                        <span>OBC: 30%</span>
                        <span>SC/ST: 20%</span>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<!-- Loader -->
<div id="pageLoader" class="page-loader">
    <div class="loader-content">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh page every 24 hours
setTimeout(() => location.reload(), 86400000);

// Get CSRF token
function getCSRFToken() {
    return document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
           document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
}

// Loader functionality
function showLoaderAndNavigate(url) {
    document.getElementById('pageLoader').style.display = 'flex';
    setTimeout(() => window.location.href = url, 500);
}

// Interactive collection items
document.addEventListener('DOMContentLoaded', function() {
    const collectionItems = document.querySelectorAll('.collection-item.interactive');
    collectionItems.forEach(item => {
        item.style.cursor = 'pointer';
        item.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
        });
        item.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
            this.style.boxShadow = '0 4px 15px rgba(0,0,0,0.1)';
        });
    });
});

// Chart.js initialization
document.addEventListener('DOMContentLoaded', function() {
    // Student Chart
    const studentElement = document.getElementById('studentChart');
    if (studentElement) {
        const studentCtx = studentElement.getContext('2d');
    const classLabels = [{% for class in class_data %}'{{ class.student_class }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
    const classData = [{% for class in class_data %}{{ class.count }}{% if not forloop.last %}, {% endif %}{% endfor %}];
    const colors = ['#4299e1', '#48bb78', '#ed8936', '#f56565', '#9f7aea', '#38b2ac', '#ecc94b', '#ed64a6', '#a0aec0', '#68d391'];
    
    new Chart(studentCtx, {
        type: 'doughnut',
        data: {
            labels: classLabels,
            datasets: [{
                data: classData,
                backgroundColor: colors.slice(0, classLabels.length),
                borderWidth: 3,
                borderColor: '#fff',
                hoverBorderWidth: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 15 },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed + ' students';
                        }
                    }
                }
            },
            cutout: '60%'
        }
        });
    }

    // Gender Chart
    const genderElement = document.getElementById('genderChart');
    if (genderElement) {
        const genderCtx = genderElement.getContext('2d');
    new Chart(genderCtx, {
        type: 'bar',
        data: {
            labels: ['Boys', 'Girls'],
            datasets: [{
                data: [{{ boys_count }}, {{ girls_count }}],
                backgroundColor: ['#4299e1', '#ed64a6'],
                borderWidth: 0,
                barThickness: 35,
                borderRadius: 8
            }]
        },
        options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 15 },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(0,0,0,0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff'
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    grid: { display: false },
                    ticks: { display: false }
                },
                y: {
                    grid: { display: false },
                    ticks: { font: { size: 12, weight: '500' } }
                }
            }
        }
        });
    }

    // Religion Chart
    const religionElement = document.getElementById('religionChart');
    if (religionElement) {
        const religionCtx = religionElement.getContext('2d');
        const religionLabels = [{% for religion in religion_data %}'{{ religion.religion }}'{% if not forloop.last %}, {% endif %}{% endfor %}];
        const religionCounts = [{% for religion in religion_data %}{{ religion.count }}{% if not forloop.last %}, {% endif %}{% endfor %}];
        
        new Chart(religionCtx, {
            type: 'doughnut',
            data: {
                labels: religionLabels,
                datasets: [{
                    data: religionCounts,
                    backgroundColor: ['#ff6b35', '#f7931e', '#00d4aa', '#9b59b6', '#e74c3c'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: 10 },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff'
                    }
                }
            }
        });
    }

    // Category Chart
    const categoryElement = document.getElementById('categoryChart');
    if (categoryElement) {
        const categoryCtx = categoryElement.getContext('2d');
    new Chart(categoryCtx, {
        type: 'doughnut',
        data: {
            labels: ['General', 'OBC', 'SC', 'ST'],
            datasets: [{
                data: [{{ category_general|default:50 }}, {{ category_obc|default:30 }}, {{ category_sc|default:15 }}, {{ category_st|default:5 }}],
                backgroundColor: ['#3498db', '#e74c3c', '#f39c12', '#9b59b6'],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 5 },
            plugins: {
                legend: {
                    display: false
                }
            }
            }
        });
    }
});
</script>
{% endblock %}