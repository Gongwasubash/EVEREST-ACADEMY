{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    {% csrf_token %}
    <title>{% block title %}School Management{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="{% static 'css/dashboard-sidebar-fix.css' %}">
    <link rel="stylesheet" href="{% static 'css/mobile-overlay-fix.css' %}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="layout">
        <aside class="sidebar">
            <div class="sidebar-header" onclick="openSchoolSettingsPopup()" style="cursor: pointer;">
                <img src="{% if school_info.logo %}{{ school_info.logo.url }}{% else %}{% static 'img/Everest-Crest-Square.png' %}{% endif %}" alt="{{ school_info.school_name }}" style="width: 60px; height: 60px; object-fit: contain;">
                <h2 style="font-size: 14px; margin-top: 5px;">{{ school_info.school_name }}</h2>
            </div>
            <nav class="sidebar-nav">
                {% if is_super_admin or user_permissions.can_view_dashboard %}
                <a href="{% url 'dashboard' %}" class="nav-item{% if request.resolver_match.url_name == 'dashboard' or request.resolver_match.url_name == 'home' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Dashboard</span>
                </a>
                {% endif %}
                {% if is_super_admin or user_permissions.can_view_students %}
                <a href="{% url 'students' %}" class="nav-item{% if request.resolver_match.url_name == 'students' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16 4C16 2.9 15.1 2 14 2H10C8.9 2 8 2.9 8 4H5C3.9 4 3 4.9 3 6V20C3 21.1 3.9 22 5 22H19C20.1 22 21 21.1 21 20V6C21 4.9 20.1 4 19 4H16M10 4H14V6H10V4M7 8H17V10H7V8M7 12H17V14H7V12M7 16H14V18H7V16Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Students</span>
                </a>
                {% endif %}
                {% if is_super_admin or user_permissions.can_view_teachers %}
                <a href="{% url 'teachers' %}" class="nav-item{% if request.resolver_match.url_name == 'teachers' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 17,11H19Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Teachers</span>
                </a>
                {% endif %}

                {% if is_super_admin or user_permissions.can_view_reports %}
                <a href="{% url 'reports' %}" class="nav-item{% if request.resolver_match.url_name == 'reports' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M22,21H2V3H4V19H6V10H10V19H12V6H16V19H18V14H22V21Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Reports</span>
                </a>
                {% endif %}
                {% if is_super_admin or user_permissions.can_view_marksheet %}
                <a href="{% url 'marksheet_system' %}" class="nav-item{% if request.resolver_match.url_name == 'marksheet_system' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20M9,13V15H7V13H9M11,13H17V15H11V13M9,16V18H7V16H9M11,16H17V18H11V16Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Marksheet</span>
                </a>
                {% endif %}
                {% if is_super_admin or user_permissions.can_view_fee_structure %}
                <a href="{% url 'fees' %}" class="nav-item{% if request.resolver_match.url_name == 'fees' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7,15H9C9,16.08 10.37,17 12,17C13.63,17 15,16.08 15,15C15,13.9 13.96,13.5 11.76,12.97C9.64,12.44 7,11.78 7,9C7,7.21 8.47,5.69 10.5,5.18V3H13.5V5.18C15.53,5.69 17,7.21 17,9H15C15,7.92 13.63,7 12,7C10.37,7 9,7.92 9,9C9,10.1 10.04,10.5 12.24,11.03C14.36,11.56 17,12.22 17,15C17,16.79 15.53,18.31 13.5,18.82V21H10.5V18.82C8.47,18.31 7,16.79 7,15Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Fee Structure</span>
                </a>
                {% endif %}


                {% if is_super_admin or user_permissions.can_view_fee_receipt %}
                <a href="{% url 'fee_receipt_book' %}" class="nav-item{% if request.resolver_match.url_name == 'fee_receipt_book' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Fee Receipt</span>
                </a>
                {% endif %}
                {% if is_super_admin or user_permissions.can_view_daily_expenses %}
                <a href="{% url 'student_daily_exp' %}" class="nav-item{% if request.resolver_match.url_name == 'student_daily_exp' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,1L21,5V11C21,16.55 17.16,21.74 12,23C6.84,21.74 3,16.55 3,11V5L12,1M12,7C10.9,7 10,7.9 10,9S10.9,11 12,11C13.1,11 14,10.1 14,9S13.1,7 12,7M18,14C18,16.21 15.79,18 13,18H11C8.21,18 6,16.21 6,14C6,13.45 6.45,13 7,13S8,13.45 8,14C8,15.1 8.9,16 10,16H14C15.1,16 16,15.1 16,14C16,13.45 16.45,13 17,13S18,13.45 18,14Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Daily Expenses</span>
                </a>
                {% endif %}

                {% if is_super_admin or user_permissions.can_view_attendance %}
                <a href="{% url 'student_attendance_dashboard' %}" class="nav-item{% if request.resolver_match.url_name == 'student_attendance_dashboard' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19Z M17,12H7V10H17V12Z M15,16H7V14H15V16Z M17,8H7V6H17V8Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Student Attendance</span>
                </a>
                {% endif %}

                {% if is_super_admin or user_permissions.can_view_school_settings %}
                <a href="{% url 'school_settings' %}" class="nav-item{% if request.resolver_match.url_name == 'school_settings' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">School Settings</span>
                </a>
                {% endif %}

                {% if is_super_admin or user_permissions.can_view_website_settings %}
                <a href="{% url 'website_settings' %}" class="nav-item{% if request.resolver_match.url_name == 'website_settings' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M16.36,14C16.44,13.34 16.5,12.68 16.5,12C16.5,11.32 16.44,10.66 16.36,10H19.74C19.9,10.64 20,11.31 20,12C20,12.69 19.9,13.36 19.74,14M14.59,19.56C15.19,18.45 15.65,17.25 15.97,16H18.92C17.96,17.65 16.43,18.93 14.59,19.56M14.34,14H9.66C9.56,13.34 9.5,12.68 9.5,12C9.5,11.32 9.56,10.65 9.66,10H14.34C14.43,10.65 14.5,11.32 14.5,12C14.5,12.68 14.43,13.34 14.34,14M12,19.96C11.17,18.76 10.5,17.43 10.09,16H13.91C13.5,17.43 12.83,18.76 12,19.96M8,8H5.08C6.03,6.34 7.57,5.06 9.4,4.44C8.8,5.55 8.35,6.75 8,8M5.08,16H8C8.35,17.25 8.8,18.45 9.4,19.56C7.57,18.93 6.03,17.65 5.08,16M4.26,14C4.1,13.36 4,12.69 4,12C4,11.31 4.1,10.64 4.26,10H7.64C7.56,10.66 7.5,11.32 7.5,12C7.5,12.68 7.56,13.34 7.64,14M12,4.03C12.83,5.23 13.5,6.57 13.91,8H10.09C10.5,6.57 11.17,5.23 12,4.03M18.92,8H15.97C15.65,6.75 15.19,5.55 14.59,4.44C16.43,5.07 17.96,6.34 18.92,8M12,2C6.47,2 2,6.5 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">Website Settings</span>
                </a>
                {% endif %}
                
                {% if is_super_admin or user_permissions.can_view_user_management %}
                <a href="{% url 'user_management' %}" class="nav-item{% if request.resolver_match.url_name == 'user_management' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                        </svg>
                    </span>
                    <span class="nav-text">User Management</span>
                </a>
                {% endif %}
                
                <a href="{% url 'school_calendar' %}" class="nav-item{% if request.resolver_match.url_name == 'school_calendar' %} active{% endif %}">
                    <span class="nav-icon">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19,3H18V1H16V3H8V1H6V3H5A2,2 0 0,0 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5A2,2 0 0,0 19,3M19,19H5V8H19V19M16,10V12H14V10H16M12,10V12H10V10H12M8,10V12H6V10H8M16,14V16H14V14H16M12,14V16H10V14H12M8,14V16H6V14H8"/>
                        </svg>
                    </span>
                    <span class="nav-text">School Calendar</span>
                </a>
            </nav>
            

        </aside>
        
        <div class="mobile-overlay" onclick="closeSidebar()"></div>
        
        <div class="main-content">
            <!-- Navbar -->
            <nav class="navbar" style="background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); padding: 1rem 0; border-bottom: 1px solid #e9ecef; position: sticky; top: 0; z-index: 1000;">
                <div class="container" style="max-width: 1200px; margin: 0 auto; padding: 0 1rem; display: flex; justify-content: space-between; align-items: center;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <button class="menu-toggle" onclick="toggleSidebar()" style="background: none; border: none; cursor: pointer;">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 24px; height: 24px;">
                                <path d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z"/>
                            </svg>
                        </button>
                        <div onclick="openSchoolSettingsPopup()" style="cursor: pointer; display: flex; align-items: center;">
                            <img src="{% if school_info.logo %}{{ school_info.logo.url }}{% else %}{% static 'img/Everest-Crest-Square.png' %}{% endif %}" alt="{{ school_info.school_name }}" style="width: 40px; height: 40px; object-fit: contain; margin-right: 10px;">
                            <h1 style="font-size: 1.5rem; margin: 0; color: #333;">{{ school_info.school_name }}</h1>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <div class="profile-dropdown" style="position: relative;">
                            <button class="profile-btn" onclick="toggleProfileDropdown(event)" style="background: none; border: none; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; border-radius: 5px; transition: background 0.3s; min-height: 44px; -webkit-tap-highlight-color: transparent;">
                                <div class="profile-avatar" style="width: 32px; height: 32px; background: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold;">
                                    {% if admin_username %}{{ admin_username|first|upper }}{% else %}U{% endif %}
                                </div>
                                <span style="color: #333; font-weight: 500;">{% if admin_username %}{{ admin_username }}{% else %}User{% endif %}</span>
                                <svg style="width: 16px; height: 16px; color: #666;" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M7,10L12,15L17,10H7Z"/>
                                </svg>
                            </button>
                            <div class="profile-menu" id="profileMenu" style="position: absolute; top: 100%; right: 0; background: white; border: 1px solid #e9ecef; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 280px; z-index: 1001; display: none;">
                                <div style="padding: 1rem; border-bottom: 1px solid #e9ecef;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                        <div class="profile-avatar-large" style="width: 48px; height: 48px; background: #007bff; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 1.25rem;">
                                            {% if admin_username %}{{ admin_username|first|upper }}{% else %}U{% endif %}
                                        </div>
                                        <div>
                                            <div style="font-weight: 600; color: #333; font-size: 1rem;">{% if admin_username %}{{ admin_username }}{% else %}User{% endif %}</div>
                                            <div style="font-size: 0.875rem; color: #666;">{% if is_super_admin %}Super Admin{% else %}Basic User{% endif %}</div>
                                        </div>
                                    </div>
                                    <div style="background: #f8f9fa; padding: 0.75rem; border-radius: 6px; font-size: 0.875rem;">
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span style="color: #666;">Status:</span>
                                            <span style="color: #28a745; font-weight: 500;">{% if is_super_admin %}Active Admin{% else %}Active User{% endif %}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                            <span style="color: #666;">Access Level:</span>
                                            <span style="color: #007bff; font-weight: 500;">{% if is_super_admin %}Full Access{% else %}Limited Access{% endif %}</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #666;">Last Login:</span>
                                            <span style="color: #333; font-weight: 500;">Today</span>
                                        </div>
                                    </div>
                                </div>
                                <div style="padding: 0.5rem 0;">
                                    <a href="#" onclick="showProfileDetails()" style="display: block; padding: 0.75rem 1rem; color: #333; text-decoration: none; transition: background 0.3s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                                        <svg style="width: 16px; height: 16px; margin-right: 0.5rem; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12,4A4,4 0 0,1 16,8A4,4 0 0,1 12,12A4,4 0 0,1 8,8A4,4 0 0,1 12,4M12,14C16.42,14 20,15.79 20,18V20H4V18C4,15.79 7.58,14 12,14Z"/>
                                        </svg>
                                        View Profile Details
                                    </a>
                                    <a href="{% url 'user_login' %}" style="display: block; padding: 0.75rem 1rem; color: #333; text-decoration: none; transition: background 0.3s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                                        <svg style="width: 16px; height: 16px; margin-right: 0.5rem; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M19,3H5C3.89,3 3,3.89 3,5V19A2,2 0 0,0 5,21H19A2,2 0 0,0 21,19V5C21,3.89 20.1,3 19,3M19,19H5V5H19V19Z"/>
                                        </svg>
                                        User Dashboard
                                    </a>
                                    <a href="{% url 'admin_login_view' %}" style="display: block; padding: 0.75rem 1rem; color: #333; text-decoration: none; transition: background 0.3s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                                        <svg style="width: 16px; height: 16px; margin-right: 0.5rem; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                                        </svg>
                                        Admin Panel
                                    </a>
                                    <hr style="margin: 0.5rem 0; border-color: #e9ecef;">
                                    <a href="/logout/" style="display: block; padding: 0.75rem 1rem; color: #dc3545; text-decoration: none; transition: background 0.3s;" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='transparent'">
                                        <svg style="width: 16px; height: 16px; margin-right: 0.5rem; vertical-align: middle;" viewBox="0 0 24 24" fill="currentColor">
                                            <path d="M16,17V14H9V10H16V7L21,12L16,17M14,2A2,2 0 0,1 16,4V6H14V4H5V20H14V18H16V20A2,2 0 0,1 14,22H5A2,2 0 0,1 3,20V4A2,2 0 0,1 5,2H14Z"/>
                                        </svg>
                                        Logout
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
            
            <main class="content">
                {% block content %}{% endblock %}
            </main>
            
            <!-- Footer -->
            <footer style="background: #f8f9fa; padding: 2rem 0; margin-top: 2rem; border-top: 1px solid #e9ecef;">
                <div style="max-width: 1200px; margin: 0 auto; padding: 0 1rem;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem; text-align: center;">
                        <div>
                            <h5 style="color: #333; margin-bottom: 1rem;">{{ school_info.school_name }}</h5>
                            <p style="color: #666; margin: 0;">Excellence in Education</p>
                        </div>
                        <div>
                            <h6 style="color: #333; margin-bottom: 1rem;">Contact Info</h6>
                            <p style="color: #666; margin: 0.5rem 0;">{{ school_info.address|default:"Kathmandu, Nepal" }}</p>
                            <p style="color: #666; margin: 0.5rem 0;">Phone: {{ school_info.phone|default:"+977-1-4444444" }}</p>
                            <p style="color: #666; margin: 0.5rem 0;">Email: {{ school_info.email|default:"info@school.edu.np" }}</p>
                        </div>
                        <div>
                            <h6 style="color: #333; margin-bottom: 1rem;">Quick Links</h6>
                            <p style="margin: 0.5rem 0;"><a href="{% url 'public_registration' %}" style="color: #007bff; text-decoration: none;">Student Registration</a></p>
                            <p style="margin: 0.5rem 0;"><a href="{% url 'home' %}" style="color: #007bff; text-decoration: none;">Dashboard</a></p>
                        </div>
                    </div>
                    <hr style="margin: 2rem 0; border-color: #e9ecef;">
                    <div style="text-align: center; color: #666;">
                        <p style="margin: 0;">&copy; 2025 {{ school_info.school_name }}. All rights reserved.</p>
                    </div>
                </div>
            </footer>
        </div>
    </div>
    
    <!-- Profile Details Modal -->
    <div id="profileDetailsModal" class="modal" style="display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
        <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 0; border: none; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 10px 10px 0 0; position: relative;">
                <h2 style="margin: 0; font-size: 1.5rem;">Profile Details</h2>
                <span class="close" onclick="closeProfileDetailsModal()" style="position: absolute; right: 1rem; top: 1rem; color: white; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;">&times;</span>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div class="profile-avatar-xl" style="width: 80px; height: 80px; background: #007bff; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 2rem; margin-bottom: 1rem;">
                        {% if admin_username %}{{ admin_username|first|upper }}{% else %}U{% endif %}
                    </div>
                    <h3 style="margin: 0 0 0.5rem 0; color: #333;">{% if admin_username %}{{ admin_username }}{% else %}User{% endif %}</h3>
                    <p style="margin: 0; color: #666; font-size: 1rem;">{% if is_super_admin %}Super Administrator{% else %}Basic User{% endif %}</p>
                </div>
                
                <div class="profile-info" style="background: #f8f9fa; padding: 1.5rem; border-radius: 8px;">
                    <div class="info-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                        <span style="color: #666; font-weight: 500;">Username:</span>
                        <span style="color: #333; font-weight: 600;">{% if admin_username %}{{ admin_username }}{% else %}user{% endif %}</span>
                    </div>
                    <div class="info-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                        <span style="color: #666; font-weight: 500;">Role:</span>
                        <span style="color: {% if is_super_admin %}#dc3545{% else %}#007bff{% endif %}; font-weight: 600;">{% if is_super_admin %}Super Admin{% else %}Basic User{% endif %}</span>
                    </div>
                    <div class="info-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                        <span style="color: #666; font-weight: 500;">Access Level:</span>
                        <span style="color: {% if is_super_admin %}#28a745{% else %}#ffc107{% endif %}; font-weight: 600;">{% if is_super_admin %}Full Access{% else %}Limited Access{% endif %}</span>
                    </div>
                    <div class="info-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                        <span style="color: #666; font-weight: 500;">Status:</span>
                        <span style="color: #28a745; font-weight: 600; display: flex; align-items: center;"><span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; margin-right: 0.5rem;"></span>Active</span>
                    </div>
                    <div class="info-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid #e9ecef;">
                        <span style="color: #666; font-weight: 500;">Session:</span>
                        <span style="color: #333; font-weight: 600;">Active</span>
                    </div>
                    <div class="info-row" style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0;">
                        <span style="color: #666; font-weight: 500;">Last Login:</span>
                        <span style="color: #333; font-weight: 600;">Today</span>
                    </div>
                </div>
                
                {% if is_super_admin %}
                <div class="permissions-info" style="margin-top: 1.5rem; background: #e8f5e8; padding: 1rem; border-radius: 8px; border-left: 4px solid #28a745;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #155724; font-size: 1rem;">Admin Permissions</h4>
                    <p style="margin: 0; color: #155724; font-size: 0.875rem;">You have full administrative access to all system features including user management, settings, and data modification.</p>
                </div>
                {% else %}
                <div class="permissions-info" style="margin-top: 1.5rem; background: #fff3cd; padding: 1rem; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 0.5rem 0; color: #856404; font-size: 1rem;">User Permissions</h4>
                    <p style="margin: 0; color: #856404; font-size: 0.875rem;">You have limited access to view student information, attendance records, and basic reports. Contact an administrator for additional permissions.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <!-- School Settings Popup -->
    <div id="schoolSettingsModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>School Settings</h2>
                <span class="close" onclick="closeSchoolSettingsPopup()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="schoolSettingsForm" method="post" action="{% url 'school_settings' %}">
                    {% csrf_token %}
                    <div class="form-group">
                        <label>School Name</label>
                        <input type="text" name="school_name" value="{{ school_info.school_name }}" required>
                    </div>
                    <div class="form-group">
                        <label>Address</label>
                        <textarea name="address" rows="3" placeholder="Enter school address">{{ school_info.address }}</textarea>
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" name="phone" value="{{ school_info.phone }}" placeholder="Enter phone number">
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" name="email" value="{{ school_info.email }}" placeholder="Enter email address">
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn-primary">Save Settings</button>
                        <button type="button" class="btn-secondary" onclick="closeSchoolSettingsPopup()">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <script src="{% static 'js/main.js' %}"></script>
    <script src="{% static 'js/mobile-fix.js' %}"></script>
    <script>
        function openSchoolSettingsPopup() {
            document.getElementById('schoolSettingsModal').style.display = 'flex';
        }
        
        function closeSchoolSettingsPopup() {
            document.getElementById('schoolSettingsModal').style.display = 'none';
        }
        
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const body = document.body;
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
                
                // Prevent body scroll when sidebar is open on mobile
                if (window.innerWidth <= 768) {
                    if (sidebar.classList.contains('open')) {
                        body.style.overflow = 'hidden';
                        body.style.position = 'fixed';
                        body.style.width = '100%';
                    } else {
                        body.style.overflow = '';
                        body.style.position = '';
                        body.style.width = '';
                        
                        // AGGRESSIVE FIX - FORCE MAIN CONTENT CLICKABLE
                        if (mainContent) {
                            mainContent.style.pointerEvents = 'auto';
                            mainContent.style.touchAction = 'auto';
                        }
                        
                        // FORCE ALL INTERACTIVE ELEMENTS CLICKABLE
                        setTimeout(() => {
                            document.querySelectorAll('button, select, input, a, .btn, [onclick]').forEach(el => {
                                el.style.pointerEvents = 'auto !important';
                                el.style.touchAction = 'manipulation !important';
                                el.style.zIndex = '999';
                                el.style.position = 'relative';
                            });
                        }, 50);
                    }
                }
            }
        }
        
        function closeSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const body = document.body;
            const mainContent = document.querySelector('.main-content');
            
            if (sidebar && overlay) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
                body.style.overflow = '';
                body.style.position = '';
                body.style.width = '';
                
                // AGGRESSIVE FIX - FORCE MAIN CONTENT CLICKABLE
                if (mainContent) {
                    mainContent.style.pointerEvents = 'auto';
                    mainContent.style.touchAction = 'auto';
                }
                
                // FORCE ALL INTERACTIVE ELEMENTS CLICKABLE IMMEDIATELY
                document.querySelectorAll('button, select, input, a, .btn, [onclick]').forEach(el => {
                    el.style.pointerEvents = 'auto !important';
                    el.style.touchAction = 'manipulation !important';
                    el.style.zIndex = '999';
                    el.style.position = 'relative';
                });
                
                // DOUBLE CHECK AFTER DELAY
                setTimeout(() => {
                    document.querySelectorAll('button, select, input, a, .btn, [onclick]').forEach(el => {
                        el.style.pointerEvents = 'auto !important';
                        el.style.touchAction = 'manipulation !important';
                    });
                }, 100);
            }
        }
        
        // Handle window resize
        window.addEventListener('resize', function() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            const body = document.body;
            
            if (window.innerWidth > 768) {
                if (sidebar) sidebar.classList.remove('open');
                if (overlay) overlay.classList.remove('active');
                body.style.overflow = '';
            }
        });
        
        // Initialize sidebar state on page load
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.mobile-overlay');
            
            // Ensure sidebar is properly positioned on load
            if (sidebar && window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }
            if (overlay) {
                overlay.classList.remove('active');
            }
            
            // Add touch event listeners for better mobile interaction
            if ('ontouchstart' in window) {
                // Improve button responsiveness on mobile
                document.querySelectorAll('button, .btn, .nav-item').forEach(element => {
                    element.addEventListener('touchstart', function() {
                        this.style.transform = 'scale(0.95)';
                    }, { passive: true });
                    
                    element.addEventListener('touchend', function() {
                        this.style.transform = '';
                    }, { passive: true });
                });
            }
            
            // Ensure profile menu is hidden on load
            const profileMenu = document.getElementById('profileMenu');
            if (profileMenu) {
                profileMenu.style.display = 'none';
            }
        });
        
        // Close modal when clicking outside
        window.onclick = function(event) {
            const schoolModal = document.getElementById('schoolSettingsModal');
            const profileModal = document.getElementById('profileDetailsModal');
            if (event.target == schoolModal) {
                closeSchoolSettingsPopup();
            }
            if (event.target == profileModal) {
                closeProfileDetailsModal();
            }
        }
        
        // Close sidebar when clicking nav items on mobile
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', (e) => {
                if (window.innerWidth <= 768) {
                    // Allow the link to navigate first, then close sidebar
                    setTimeout(() => {
                        closeSidebar();
                    }, 100);
                }
            });
        });
        
        // Profile dropdown functionality
        function toggleProfileDropdown(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const menu = document.getElementById('profileMenu');
            const isVisible = menu.style.display === 'block';
            
            // Close all other dropdowns first
            document.querySelectorAll('.profile-menu').forEach(m => {
                if (m !== menu) m.style.display = 'none';
            });
            
            menu.style.display = isVisible ? 'none' : 'block';
            
            // Add touch event handling for mobile
            if (!isVisible && 'ontouchstart' in window) {
                menu.addEventListener('touchstart', function(e) {
                    e.stopPropagation();
                }, { passive: true });
            }
        }
        
        // Close profile dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.querySelector('.profile-dropdown');
            const menu = document.getElementById('profileMenu');
            if (dropdown && menu && !dropdown.contains(event.target)) {
                menu.style.display = 'none';
            }
        });
        
        // Handle touch events for mobile
        document.addEventListener('touchstart', function(event) {
            const dropdown = document.querySelector('.profile-dropdown');
            const menu = document.getElementById('profileMenu');
            if (dropdown && menu && !dropdown.contains(event.target)) {
                menu.style.display = 'none';
            }
        }, { passive: true });
        
        // Profile button hover effect
        document.querySelector('.profile-btn').addEventListener('mouseenter', function() {
            this.style.background = '#f8f9fa';
        });
        document.querySelector('.profile-btn').addEventListener('mouseleave', function() {
            this.style.background = 'transparent';
        });
        
        // Profile details modal functions
        function showProfileDetails() {
            document.getElementById('profileDetailsModal').style.display = 'block';
            document.getElementById('profileMenu').style.display = 'none';
        }
        
        function closeProfileDetailsModal() {
            document.getElementById('profileDetailsModal').style.display = 'none';
        }
        
        // Close profile modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('profileDetailsModal');
            if (event.target === modal) {
                closeProfileDetailsModal();
            }
        });
        

    </script>
    {% block extra_js %}{% endblock %}
</body>
</html>