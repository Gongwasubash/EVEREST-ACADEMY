{% extends 'base.html' %}
{% load custom_filters %}

{% block title %}Attendance Dashboard{% endblock %}

{% block content %}
<style>
* { box-sizing: border-box; }
body { background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); color: #1e293b; font-family: 'Inter', -apple-system, sans-serif; }
.container { max-width: 1400px; margin: 0 auto; padding: 2rem; }
.header { background: linear-gradient(135deg, #ffffff 0%, #f1f5f9 100%); border-radius: 24px; padding: 2rem; margin-bottom: 2rem; border: 1px solid #e2e8f0; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
.header h1 { font-size: 2.5rem; font-weight: 800; background: linear-gradient(135deg, #60a5fa, #a78bfa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin: 0; }
.header p { color: #94a3b8; margin: 0.5rem 0 0 0; }
.actions { display: flex; gap: 1rem; margin-top: 1rem; }
.btn { background: linear-gradient(135deg, #3b82f6, #8b5cf6); border: none; border-radius: 16px; padding: 0.75rem 1.5rem; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(59, 130, 246, 0.3); }
.btn-secondary { background: linear-gradient(135deg, #64748b, #475569); }
.stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
.stat { background: white; border-radius: 20px; padding: 2rem; text-align: center; border: 1px solid #e2e8f0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); transition: all 0.3s; }
.stat:hover { transform: translateY(-4px); box-shadow: 0 20px 40px rgba(0,0,0,0.3); }
.stat-icon { font-size: 3rem; margin-bottom: 1rem; }
.stat-number { font-size: 3rem; font-weight: 800; margin: 0; }
.stat-label { color: #64748b; font-size: 1rem; margin: 0.5rem 0 0 0; }
.stat.total .stat-icon { color: #60a5fa; }
.stat.present .stat-icon { color: #10b981; }
.stat.absent .stat-icon { color: #ef4444; }
.stat.late .stat-icon { color: #f59e0b; }
.filters { background: white; border-radius: 20px; padding: 2rem; margin-bottom: 2rem; border: 1px solid #e2e8f0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.filter-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; align-items: end; }
.form-group { display: flex; flex-direction: column; }
.form-label { color: #374151; font-weight: 600; margin-bottom: 0.5rem; }
.form-control { background: white; border: 2px solid #e2e8f0; border-radius: 12px; padding: 0.75rem 1rem; color: #374151; transition: all 0.3s; }
.form-control:focus { border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1); outline: none; }
.table-container { background: white; border-radius: 20px; overflow: hidden; border: 1px solid #e2e8f0; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
.table-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem 2rem; border-bottom: 1px solid #e2e8f0; }
.table-title { font-size: 1.5rem; font-weight: 700; margin: 0; color: white; }
.table { width: 100%; border-collapse: collapse; }
.table th { background: #f8fafc; color: #374151; padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid #e2e8f0; }
.table td { padding: 1rem; border-bottom: 1px solid #f1f5f9; vertical-align: middle; }
.table-row { transition: all 0.3s; }
.table-row:hover { background: #f8fafc; }
.student-info { display: flex; align-items: center; gap: 1rem; }
.avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, #60a5fa, #a78bfa); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem; }
.student-name { font-weight: 600; color: #1e293b; }
.student-id { color: #64748b; font-size: 0.875rem; }
.badge { padding: 0.5rem 1rem; border-radius: 12px; font-size: 0.875rem; font-weight: 600; }
.badge-primary { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
.badge-info { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
.status-buttons { display: flex; gap: 0.5rem; }
.status-btn { padding: 0.75rem 1rem; border: 2px solid #e2e8f0; border-radius: 12px; background: white; color: #64748b; font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 0.5rem; min-width: 80px; justify-content: center; }
.status-btn.active.present { background: linear-gradient(135deg, #10b981, #34d399); color: white; border-color: #10b981; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); }
.status-btn.active.absent { background: linear-gradient(135deg, #ef4444, #f87171); color: white; border-color: #ef4444; box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3); }
.status-btn.active.late { background: linear-gradient(135deg, #f59e0b, #fbbf24); color: white; border-color: #f59e0b; box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3); }
.status-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
.status-btn:active { transform: translateY(0); }

.action-buttons { display: flex; gap: 0.5rem; }
.action-btn { width: 36px; height: 36px; border-radius: 10px; border: none; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; }
.btn-save { background: #10b981; color: white; }
.btn-save:hover { background: #059669; transform: scale(1.1); }
.btn-delete { background: #ef4444; color: white; }
.btn-delete:hover { background: #dc2626; transform: scale(1.1); }
.action-btn:hover { transform: scale(1.1); }
.empty-state { text-align: center; padding: 4rem 2rem; color: #64748b; }
.empty-icon { font-size: 4rem; margin-bottom: 1rem; }
@media (max-width: 768px) {
  .container { padding: 1rem; }
  .header { padding: 1.5rem; text-align: center; }
  .header h1 { font-size: 2rem; }
  .actions { flex-direction: column; }
  .stats { grid-template-columns: repeat(2, 1fr); gap: 1rem; }
  .stat { padding: 1.5rem; }
  .stat-number { font-size: 2rem; }
  .filter-grid { grid-template-columns: 1fr; }
  .table-container { margin: 0 -1rem; border-radius: 0; overflow-x: auto; }
  .table { font-size: 0.875rem; min-width: 600px; }
  .student-info { flex-direction: column; text-align: center; gap: 0.5rem; }
  .avatar { width: 40px; height: 40px; }
  .status-buttons { flex-direction: column; gap: 0.25rem; }
  .status-btn { min-width: auto; padding: 0.5rem; font-size: 0.75rem; }
  .action-buttons { flex-direction: column; gap: 0.25rem; }
  .action-btn { width: 32px; height: 32px; }
}
</style>

<div class="container">
  <div class="header">
    <div style="display: flex; justify-content: space-between; align-items: start; flex-wrap: wrap;">
      <div>
        <h1>üìä Attendance Dashboard</h1>
        <p>Streamlined student attendance management</p>
        {% if is_holiday or is_saturday %}
        <div style="background: #fef3c7; color: #92400e; padding: 1rem; border-radius: 12px; margin-top: 1rem; border: 1px solid #fcd34d;">
          <strong>‚ö†Ô∏è Notice:</strong> 
          {% if is_saturday %}Selected date is Saturday (Holiday) - Attendance cannot be recorded.{% endif %}
          {% if is_holiday %}Selected date is a Holiday/Festival - Attendance cannot be recorded.{% endif %}
        </div>
        {% endif %}
      </div>
      <div class="actions">
        <button class="btn btn-secondary" onclick="saveAllAttendance()" {% if not can_mark_attendance %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>üíæ Save All</button>
      </div>
    </div>
  </div>

  <div class="stats">
    <div class="stat total" onclick="filterByStatus('all')" style="cursor: pointer;">
      <div class="stat-icon">üë•</div>
      <div class="stat-number" id="totalStudents">{{ total_students }}</div>
      <div class="stat-label">Total Students</div>
    </div>
    <div class="stat present" onclick="filterByStatus('present')" style="cursor: pointer;">
      <div class="stat-icon">‚úÖ</div>
      <div class="stat-number" id="presentCount">{{ present_count }}</div>
      <div class="stat-label">Present</div>
    </div>
    <div class="stat absent" onclick="filterByStatus('absent')" style="cursor: pointer;">
      <div class="stat-icon">‚ùå</div>
      <div class="stat-number" id="absentCount">{{ absent_count }}</div>
      <div class="stat-label">Absent</div>
    </div>
    <div class="stat late" onclick="filterByStatus('late')" style="cursor: pointer;">
      <div class="stat-icon">‚è∞</div>
      <div class="stat-number" id="lateCount">{{ late_count }}</div>
      <div class="stat-label">Late</div>
    </div>
    <div class="stat total">
      <div class="stat-icon">üìÖ</div>
      <div class="stat-number">{{ total_school_days|default:0 }}</div>
      <div class="stat-label">School Days</div>
    </div>
  </div>

  <div class="filters">
    <div class="filter-grid">
      <div class="form-group">
        <label class="form-label">üìÖ Date</label>
        <input type="date" id="dateFilter" class="form-control" value="{{ selected_date }}" onchange="filterAttendance()">
      </div>
      <div class="form-group">
        <label class="form-label">üè´ Class</label>
        <select id="classFilter" class="form-control" onchange="filterAttendance()">
          <option value="">All Classes</option>
          {% for class in classes %}
          <option value="{{ class }}" {% if class == selected_class %}selected{% endif %}>{{ class }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">üìö Section</label>
        <select id="sectionFilter" class="form-control" onchange="filterAttendance()">
          <option value="">All Sections</option>
          {% for section in sections %}
          <option value="{{ section }}" {% if section == selected_section %}selected{% endif %}>{{ section }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group">
        <button class="btn" onclick="refreshData()" style="margin-top: 0;">üîÑ Refresh</button>
      </div>
    </div>
  </div>

  <div class="table-container">
    <div class="table-header">
      <h3 class="table-title">üìã Student Attendance</h3>
    </div>
    <div style="overflow-x: auto;">
      <table class="table" id="attendanceTable">
        <thead>
          <tr>
            <th>#</th>
            <th>üë§ Student</th>
            <th>üìä Status</th>
            <th>üì± WhatsApp</th>
            <th>‚öôÔ∏è Actions</th>
          </tr>
        </thead>
        <tbody id="attendanceTableBody">
          {% for item in students_with_attendance %}
          <tr data-student-id="{{ item.student.id }}" data-attendance-id="{{ item.attendance.id }}" data-mobile="{{ item.student.father_mobile|default:item.student.mobile|default:item.student.mother_mobile }}" class="table-row">
            <td>{{ forloop.counter }}</td>
            <td>
              <div class="student-info">
                <div class="avatar">{{ item.student.name|first }}</div>
                <div>
                  <div class="student-name"><a href="{% url 'student_attendance_detail' item.student.id %}" style="color: #1e293b; text-decoration: none;">{{ item.student.name }}</a></div>
                  <div class="student-id d-md-none">{{ item.student.student_class }}-{{ item.student.section }} | {{ item.student.reg_number }}</div>
                </div>
              </div>
            </td>

            <td>
              <div class="status-buttons">
                <button class="status-btn present {% if item.attendance.status == 'present' %}active{% endif %}" onclick="setStatus(this, 'present')" {% if not can_mark_attendance %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                  <i class="fas fa-check-circle"></i> Present
                </button>
                <button class="status-btn absent {% if item.attendance.status == 'absent' %}active{% endif %}" onclick="setStatus(this, 'absent')" {% if not can_mark_attendance %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                  <i class="fas fa-times-circle"></i> Absent
                </button>
                <button class="status-btn late {% if item.attendance.status == 'late' %}active{% endif %}" onclick="setStatus(this, 'late')" {% if not can_mark_attendance %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>
                  <i class="fas fa-clock"></i> Late
                </button>
                <input type="hidden" class="attendance-status" value="{{ item.attendance.status }}">
              </div>
            </td>
            <td>
              <button class="action-btn" onclick="sendWhatsAppToParent({{ item.student.id }})" title="WhatsApp Parent" style="background: #25d366; color: white; width: 48px; height: 48px; font-size: 1.2rem;">üì±</button>
            </td>
            <td>
              <div class="action-buttons">
                <button class="action-btn btn-save" onclick="saveAttendance({{ item.student.id }})" title="Save" {% if not can_mark_attendance %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>üíæ</button>
                {% if item.attendance.id %}
                <button class="action-btn btn-delete" onclick="deleteAttendance({{ item.attendance.id }}, {{ item.student.id }})" title="Delete" {% if not can_mark_attendance %}disabled style="opacity: 0.5; cursor: not-allowed;"{% endif %}>üóëÔ∏è</button>
                {% endif %}
              </div>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="5">
              <div class="empty-state">
                <div class="empty-icon">üìö</div>
                <h4>No students found</h4>
                <p>Try adjusting your filters or add some students first.</p>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function filterAttendance() {
    const date = document.getElementById('dateFilter').value;
    const classFilter = document.getElementById('classFilter').value;
    const sectionFilter = document.getElementById('sectionFilter').value;
    
    let url = '?date=' + date;
    if (classFilter) url += '&class=' + classFilter;
    if (sectionFilter) url += '&section=' + sectionFilter;
    
    window.location.href = url;
}

function refreshData() {
    filterAttendance();
}

function setStatus(button, status) {
    const container = button.parentElement;
    const hiddenInput = container.querySelector('.attendance-status');
    
    container.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    hiddenInput.value = status;
    
    const row = button.closest('tr');
    row.style.background = 'rgba(251, 191, 36, 0.1)';
    updateStatistics();
}

function updateAttendanceStatus(selectElement) {
    const row = selectElement.closest('tr');
    row.style.background = 'rgba(251, 191, 36, 0.1)';
    updateStatistics();
}

function updateStatistics() {
    const rows = document.querySelectorAll('#attendanceTableBody tr[data-student-id]');
    let present = 0, absent = 0, late = 0;
    
    rows.forEach(row => {
        const status = row.querySelector('.attendance-status').value;
        if (status === 'present') present++;
        else if (status === 'absent') absent++;
        else if (status === 'late') late++;
    });
    
    document.getElementById('totalStudents').textContent = rows.length;
    document.getElementById('presentCount').textContent = present;
    document.getElementById('absentCount').textContent = absent;
    document.getElementById('lateCount').textContent = late;
}

function saveAttendance(studentId) {
    const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
    const status = row.querySelector('.attendance-status').value;
    const date = document.getElementById('dateFilter').value;
    
    const data = {
        student_id: studentId,
        date: date,
        status: status,
        remarks: ''
    };
    
    fetch('/api/save-attendance/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            row.style.background = 'rgba(16, 185, 129, 0.1)';
            setTimeout(() => { row.style.background = ''; }, 2000);
            showAlert('success', 'Attendance saved successfully');
        } else {
            showAlert('error', data.error || 'Failed to save attendance');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Network error occurred');
    });
}

function deleteAttendance(attendanceId, studentId) {
    if (!confirm('Are you sure you want to delete this attendance record?')) {
        return;
    }
    
    const data = { attendance_id: attendanceId };
    
    fetch('/api/delete-attendance/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
            row.removeAttribute('data-attendance-id');
            
            const deleteBtn = row.querySelector('.btn-delete');
            if (deleteBtn) deleteBtn.remove();
            
            row.querySelector('.attendance-status').value = 'present';
            
            updateStatistics();
            showAlert('success', 'Attendance record deleted successfully');
        } else {
            showAlert('error', data.error || 'Failed to delete attendance');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Network error occurred');
    });
}

function bulkMarkPresent() {
    const statusContainers = document.querySelectorAll('.status-buttons');
    statusContainers.forEach(container => {
        const presentBtn = container.querySelector('.present');
        const hiddenInput = container.querySelector('.attendance-status');
        
        container.querySelectorAll('.status-btn').forEach(btn => btn.classList.remove('active'));
        presentBtn.classList.add('active');
        hiddenInput.value = 'present';
        
        container.closest('tr').style.background = 'rgba(251, 191, 36, 0.1)';
    });
    updateStatistics();
    showAlert('info', 'All students marked as present. Click "Save All" to save changes.');
}

function saveAllAttendance() {
    const rows = document.querySelectorAll('#attendanceTableBody tr[data-student-id]');
    const attendanceRecords = [];
    
    rows.forEach(row => {
        const studentId = row.getAttribute('data-student-id');
        const status = row.querySelector('.attendance-status').value;
        
        attendanceRecords.push({
            student_id: parseInt(studentId),
            status: status,
            remarks: ''
        });
    });
    
    if (attendanceRecords.length === 0) {
        showAlert('warning', 'No students to save attendance for');
        return;
    }
    
    const data = {
        date: document.getElementById('dateFilter').value,
        attendance_records: attendanceRecords
    };
    
    fetch('/api/bulk-save-attendance/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            rows.forEach(row => {
                row.style.background = 'rgba(16, 185, 129, 0.1)';
            });
            
            setTimeout(() => {
                rows.forEach(row => { row.style.background = ''; });
            }, 2000);
            
            showAlert('success', data.message);
            setTimeout(() => { refreshData(); }, 1000);
        } else {
            showAlert('error', data.error || 'Failed to save attendance');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Network error occurred');
    });
}

function sendWhatsAppNotifications() {
    const rows = document.querySelectorAll('#attendanceTableBody tr[data-student-id]');
    const absentLateStudents = [];
    
    rows.forEach(row => {
        const studentId = row.getAttribute('data-student-id');
        const status = row.querySelector('.attendance-status').value;
        
        if (status === 'absent' || status === 'late') {
            absentLateStudents.push({
                student_id: parseInt(studentId),
                status: status
            });
        }
    });
    
    if (absentLateStudents.length === 0) {
        showAlert('info', 'No absent or late students to notify');
        return;
    }
    
    const data = {
        date: document.getElementById('dateFilter').value,
        students: absentLateStudents
    };
    
    fetch('/api/send-whatsapp-attendance/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', `WhatsApp notifications sent to ${data.sent_count} parents`);
        } else {
            showAlert('error', data.error || 'Failed to send WhatsApp notifications');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('error', 'Network error occurred');
    });
}

function sendWhatsAppToParent(studentId) {
    const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
    const status = row.querySelector('.attendance-status').value;
    
    if (status !== 'absent' && status !== 'late') {
        showAlert('info', 'WhatsApp notifications are only sent for absent or late students');
        return;
    }
    
    const mobile = row.dataset.mobile;
    
    if (!mobile) {
        showAlert('error', 'No mobile number available for this student');
        return;
    }
    
    const studentName = row.querySelector('.student-name').textContent;
    const message = status === 'late' 
        ? `Dear Parent,\n\nWe would like to inform you that your child ${studentName} arrived late to school today. Please ensure punctuality to avoid disruption to their learning.\n\nFor any queries, please feel free to reach out to us.\n\nThank you for your cooperation.\n\nBest regards,\nSchool Administration`
        : `Dear Parent,\n\nWe would like to inform you that your child ${studentName} was marked absent today. Please contact the school office at your earliest convenience to discuss this matter.\n\nFor any queries, please feel free to reach out to us.\n\nThank you for your cooperation.\n\nBest regards,\nSchool Administration`;
    const whatsappUrl = `https://web.whatsapp.com/send?phone=${mobile.replace(/[^0-9]/g, '')}&text=${encodeURIComponent(message)}`;
    
    window.open(whatsappUrl, '_blank');
    showAlert('success', 'WhatsApp opened with message');
}

function showAlert(type, message) {
    const alertColors = {
        success: '#10b981',
        error: '#ef4444',
        warning: '#f59e0b',
        info: '#60a5fa'
    };
    
    const alert = document.createElement('div');
    alert.style.cssText = `
        position: fixed; top: 20px; right: 20px; z-index: 1000;
        background: ${alertColors[type]}; color: white; padding: 1rem 1.5rem;
        border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
        font-weight: 600; max-width: 400px;
    `;
    alert.textContent = message;
    
    document.body.appendChild(alert);
    setTimeout(() => alert.remove(), 5000);
}

function filterByStatus(status) {
    const rows = document.querySelectorAll('#attendanceTableBody tr[data-student-id]');
    
    rows.forEach(row => {
        const currentStatus = row.querySelector('.attendance-status').value;
        
        if (status === 'all') {
            row.style.display = '';
        } else if (currentStatus === status) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
    
    // Update stat card highlighting
    document.querySelectorAll('.stat').forEach(stat => {
        stat.style.transform = '';
        stat.style.boxShadow = '';
    });
    
    if (status !== 'all') {
        const activeStatCard = document.querySelector(`.stat.${status}`);
        if (activeStatCard) {
            activeStatCard.style.transform = 'scale(1.05)';
            activeStatCard.style.boxShadow = '0 10px 30px rgba(0,0,0,0.2)';
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    updateStatistics();
});
</script>
{% endblock %}