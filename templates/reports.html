{% extends "base.html" %}
{% load static %}

{% block title %}Marksheet Dashboard{% endblock %}

{% block extra_css %}
<style>
.marksheet-dashboard {
    background: #f5f5f5;
    min-height: 100vh;
    padding: 2rem;
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
}

.dashboard-header {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
}

.dashboard-header h1 {
    color: #333;
    font-size: 2rem;
    font-weight: 600;
    margin: 0;
}

.dashboard-header p {
    color: #666;
    font-size: 1rem;
    margin: 0;
}

.header-controls {
    display: flex;
    gap: 1rem;
    align-items: center;
}

.search-input {
    padding: 8px 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    width: 250px;
    font-size: 14px;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
}

.stat-card {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
}

.stat-card.exams .stat-icon { background: #007bff; }
.stat-card.subjects .stat-icon { background: #28a745; }
.stat-card.marksheets .stat-icon { background: #ffc107; }

.stat-content h3 {
    font-size: 2rem;
    font-weight: 700;
    color: #333;
    margin: 0;
}

.stat-content p {
    color: #666;
    margin: 0;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.actions-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 2rem;
    margin-bottom: 2rem;
    align-items: start;
}

.action-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    height: fit-content;
    overflow: hidden;
}

.exam-card {
    /* Remove grid-column override for better responsive layout */
}

.action-card h3 {
    background: #f8f9fa;
    color: #333;
    font-size: 1.25rem;
    font-weight: 600;
    margin: 0;
    padding: 1.5rem 2rem;
    border-bottom: 1px solid #e9ecef;
}

.action-card form {
    padding: 2rem;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-bottom: 1rem;
}

.form-group {
    margin-bottom: 1rem;
}

.form-group label {
    display: block;
    color: #333;
    font-weight: 500;
    margin-bottom: 0.5rem;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    font-size: 0.875rem;
}

.exam-section {
    margin-bottom: 1rem;
}

.section-title {
    color: #1f2937;
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
    padding: 1rem 0;
    border-bottom: 2px solid #e5e7eb;
}

@media (max-width: 768px) {
    .marksheet-dashboard {
        padding: 1rem;
    }
    
    .actions-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
    
    .exam-section {
        margin-bottom: 0.5rem;
    }
    
    .section-title {
        font-size: 1.25rem;
        padding: 0.75rem 0;
    }
    
    .form-row {
        grid-template-columns: 1fr;
        gap: 0.75rem;
    }
    
    .action-card {
        padding: 1.5rem;
    }
    
    .checkbox-group {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 0.5rem;
        padding: 0.75rem;
    }
    
    .checkbox-label {
        padding: 0.375rem;
        font-size: 0.8rem;
    }
}

@media (max-width: 480px) {
    .section-title {
        font-size: 1.125rem;
    }
    
    .action-card {
        padding: 1rem;
    }
    
    .form-group input, .form-group select {
        padding: 0.625rem;
        font-size: 0.8rem;
    }
    
    .checkbox-group {
        grid-template-columns: repeat(auto-fit, minmax(70px, 1fr));
    }
    
    .btn {
        padding: 0.75rem 1.5rem;
        font-size: 0.875rem;
    }
}

.checkbox-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
    gap: 0.75rem;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    padding: 1rem;
    background: #f9fafb;
}

.checkbox-label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.875rem;
    font-weight: 500;
    color: #374151;
    margin: 0;
    padding: 0.5rem;
    border-radius: 6px;
    transition: all 0.2s ease;
    background: white;
    border: 1px solid #e5e7eb;
}

.checkbox-label:hover {
    background: #f3f4f6;
    border-color: #d1d5db;
    transform: translateY(-1px);
}

.checkbox-label input[type="checkbox"] {
    width: 16px;
    height: 16px;
    margin: 0;
    padding: 0;
    accent-color: #2563eb;
    cursor: pointer;
}

.checkmark {
    display: none;
}

.btn {
    background: #007bff;
    color: white;
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 6px;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.3s ease;
}

.btn:hover {
    background: #0056b3;
}

.btn-success {
    background: #28a745;
}

.btn-success:hover {
    background: #218838;
}

.recent-section {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.recent-section h3 {
    color: #333;
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1.5rem;
}

.exam-list {
    list-style: none;
    padding: 0;
    margin: 0;
}

.exam-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem 0;
    border-bottom: 1px solid #f1f3f4;
}

.exam-item:last-child {
    border-bottom: none;
}

.exam-actions {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.delete-btn {
    background: #dc3545;
    color: white;
    padding: 4px 8px;
    font-size: 11px;
}

.delete-btn:hover {
    background: #c82333;
}

.exam-info h4 {
    color: #333;
    font-size: 1rem;
    font-weight: 600;
    margin: 0 0 0.25rem 0;
}

.exam-info p {
    color: #666;
    font-size: 0.875rem;
    margin: 0;
}

.exam-badge {
    background: #e9ecef;
    color: #495057;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
    font-weight: 600;
}



.btn-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

.btn-danger {
    background: #dc3545;
    color: white;
}

.btn-danger:hover {
    background: #c82333;
}

.subject-checkbox {
    margin: 0;
    transform: scale(1.2);
}

.section-controls {
    flex-wrap: wrap;
    gap: 0.5rem;
}

.section-controls button {
    white-space: nowrap;
}

.bulk-delete-mode .subject-checkbox {
    display: inline-block !important;
}

.bulk-delete-mode #selectAllSubjects,
.bulk-delete-mode #selectAllLabel {
    display: inline-block !important;
}

.import-export-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    flex-wrap: wrap;
}

@media (max-width: 768px) {
    .section-controls {
        flex-direction: column;
        align-items: stretch;
    }
    
    .section-controls button,
    .section-controls select {
        width: 100%;
        margin-bottom: 0.25rem;
    }
}

.form-control {
    padding: 0.375rem 0.75rem;
    border: 1px solid #ced4da;
    border-radius: 0.25rem;
    font-size: 0.875rem;
    width: 100%;
}

.table-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    gap: 1rem;
}

.advanced-table {
    width: 100%;
    border-collapse: collapse;
    background: white;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.advanced-table th {
    background: #f8f9fa;
    padding: 12px 8px;
    text-align: left;
    font-weight: 600;
    border-bottom: 2px solid #dee2e6;
    cursor: pointer;
    user-select: none;
}

.advanced-table th:hover {
    background: #e9ecef;
}

.advanced-table td {
    padding: 12px 8px;
    border-bottom: 1px solid #dee2e6;
}

.filter-row th {
    background: #ffffff;
    padding: 8px;
    cursor: default;
}

.filter-row input, .filter-row select {
    width: 100%;
    padding: 6px 8px;
    border: 1px solid #ced4da;
    border-radius: 4px;
    font-size: 12px;
}

.table-pagination {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 1rem;
    padding: 1rem 0;
}

.sort-icon {
    margin-left: 5px;
    color: #666;
    font-size: 12px;
}

.section-controls {
    display: flex;
    gap: 0.5rem;
    align-items: center;
    margin-bottom: 1rem;
}

.section-controls input {
    padding: 4px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
    width: 150px;
}

.section-controls select {
    padding: 4px 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 12px;
}

.hidden {
    display: none !important;
}

.highlight {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
}

.action-card.filtered {
    opacity: 0.3;
    pointer-events: none;
}

.selected-for-delete {
    background-color: #f8d7da !important;
    border-left: 4px solid #dc3545;
}



.btn-success {
    background: #28a745;
    color: white;
}

.btn-success:hover {
    background: #218838;
}

.marks-entry-section {
    background: white;
    padding: 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-top: 2rem;
}

.marks-form {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 1rem;
}

@media (max-width: 1200px) {
    .actions-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }
}

@media (max-width: 768px) {
    .marksheet-dashboard {
        padding: 1rem;
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .dashboard-header {
        padding: 1.5rem;
        flex-direction: column;
        text-align: center;
        gap: 1rem;
    }
    
    .dashboard-header h1 {
        font-size: 1.5rem;
    }
    
    .form-row {
        grid-template-columns: 1fr;
    }
    
    .checkbox-group {
        grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
        gap: 0.5rem;
    }
    
    .advanced-table {
        font-size: 0.875rem;
    }
    
    .advanced-table th,
    .advanced-table td {
        padding: 8px 4px;
    }
}

@media (max-width: 480px) {
    .stats-grid {
        grid-template-columns: 1fr;
    }
    
    .stat-card {
        padding: 1.5rem;
    }
    
    .checkbox-group {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .section-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
    }
    
    .section-controls button,
    .section-controls select,
    .section-controls input {
        width: 100%;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="marksheet-dashboard">
    <div class="dashboard-header">
        <h1>📊 Marksheet Dashboard</h1>
        <p>Manage exams, subjects, and student marksheets</p>
        <div class="header-controls">
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card exams">
            <div class="stat-icon">📝</div>
            <div class="stat-content">
                <h3>{{ total_exams }}</h3>
                <p>Total Exams</p>
            </div>
        </div>
        
        <div class="stat-card subjects">
            <div class="stat-icon">📚</div>
            <div class="stat-content">
                <h3>{{ total_subjects }}</h3>
                <p>Total Subjects</p>
            </div>
        </div>
        
        <div class="stat-card marksheets">
            <div class="stat-icon">🎓</div>
            <div class="stat-content">
                <h3>{{ total_marksheets }}</h3>
                <p>Total Marksheets</p>
            </div>
        </div>
    </div>

    <div class="actions-grid" id="actionsGrid">
        <div class="action-card" data-category="subject">
            <h3>Add New Subject</h3>
            <form id="subjectForm">
                {% csrf_token %}
                <div class="form-group">
                    <label>Subject Name</label>
                    <input type="text" name="name" required>
                </div>
                <div class="form-group">
                    <label>Subject Code</label>
                    <input type="text" name="code" required>
                </div>
                <div class="form-group">
                    <label>Class</label>
                    <select name="class_name" required>
                        <option value="">Select Class</option>
                        {% for class_name in available_classes %}
                        <option value="{{ class_name }}">{{ class_name }}</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label>Max Marks</label>
                    <input type="number" name="max_marks" value="100" required>
                </div>
                <div class="form-group">
                    <label>Pass Marks</label>
                    <input type="number" name="pass_marks" value="35" required>
                </div>
                <button type="submit" class="btn btn-success">Add Subject</button>
            </form>
        </div>

        <div class="action-card exam-card" data-category="exam">
            <h3>Create New Exam</h3>
            <form id="examForm">
                {% csrf_token %}
                <div class="form-row">
                    <div class="form-group">
                        <label>Exam Name</label>
                        <input type="text" name="name" required>
                    </div>
                    <div class="form-group">
                        <label>Exam Type</label>
                        <select name="exam_type" required>
                            <option value="">Select Type</option>
                            <option value="First Term">First Term</option>
                            <option value="Mid Term">Mid Term</option>
                            <option value="Final Term">Final Term</option>
                            <option value="Unit Test">Unit Test</option>
                            <option value="Annual">Annual</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Exam Date</label>
                        <input type="date" name="exam_date" required>
                    </div>
                    <div class="form-group">
                        <label>Session</label>
                        <input type="text" name="session" value="2024-25" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Classes</label>
                    <div class="checkbox-group">
                        {% for class_name in available_classes %}
                        <label class="checkbox-label">
                            <input type="checkbox" name="class_names" value="{{ class_name }}">
                            <span class="checkmark"></span>
                            {{ class_name }}
                        </label>
                        {% endfor %}
                    </div>
                </div>
                <button type="submit" class="btn">Create Exam</button>
            </form>
        </div>
    </div>





    <div class="recent-section" data-category="exam">
        <h3>Recent Exams</h3>
        <div class="section-controls">
            <input type="text" placeholder="Filter exams..." onkeyup="filterExams(this.value)">
            <select onchange="sortExams(this.value)">
                <option value="date">Sort by Date</option>
                <option value="name">Sort by Name</option>
                <option value="class">Sort by Class</option>
            </select>
        </div>
        <ul class="exam-list">
            {% regroup recent_exams by name as grouped_exams %}
            {% for exam_group in grouped_exams %}
            <li class="exam-item">
                <div class="exam-info">
                    <h4>{{ exam_group.grouper }}</h4>
                    <p>
                        {% if exam_group.list|length == 1 %}
                            {{ exam_group.list.0.class_name }} - {{ exam_group.list.0.exam_date }}
                        {% else %}
                            {% if exam_group.list.0.class_name == "All Classes" %}
                                All Classes - {{ exam_group.list.0.exam_date }}
                            {% else %}
                                Multiple Classes - {{ exam_group.list.0.exam_date }}
                            {% endif %}
                        {% endif %}
                    </p>
                </div>
                <div class="exam-actions">
                    <span class="exam-badge">{{ exam_group.list.0.exam_type }}</span>
                    <button class="btn btn-sm delete-btn" onclick="deleteExam({{ exam_group.list.0.id }}, '{{ exam_group.grouper }}', '{{ exam_group.list.0.class_name }}')">Delete</button>
                </div>
            </li>
            {% empty %}
            <li class="exam-item">
                <p>No exams created yet</p>
            </li>
            {% endfor %}
        </ul>
    </div>

    <div class="recent-section" data-category="subject">
        <h3>Subjects</h3>

        <div class="students-container">
            <div class="table-controls">
                <input type="text" id="subjectSearch" placeholder="Search subjects..." class="search-input">
                <select id="entriesPerPage" onchange="changeEntriesPerPage()">
                    <option value="10">10 entries</option>
                    <option value="25">25 entries</option>
                    <option value="50">50 entries</option>
                    <option value="100">100 entries</option>
                </select>
            </div>
            <table class="fee-table advanced-table">
                <thead>
                    <tr>
                        <th>
                            <input type="checkbox" id="selectAllSubjects" onchange="toggleAllSubjects(this)" style="display: none;">
                            <label for="selectAllSubjects" id="selectAllLabel" style="display: none;">All</label>
                        </th>
                        <th onclick="sortSubjectTable(1)">Subject Name <span class="sort-icon">↕</span></th>
                        <th onclick="sortSubjectTable(2)">Code <span class="sort-icon">↕</span></th>
                        <th onclick="sortSubjectTable(3)">Class <span class="sort-icon">↕</span></th>
                        <th onclick="sortSubjectTable(4)">Max Marks <span class="sort-icon">↕</span></th>
                        <th onclick="sortSubjectTable(5)">Pass Marks <span class="sort-icon">↕</span></th>
                        <th>Actions</th>
                    </tr>
                    <tr class="filter-row">
                        <th></th>
                        <th><input type="text" placeholder="Filter name" onkeyup="filterColumn(1, this.value)"></th>
                        <th><input type="text" placeholder="Filter code" onkeyup="filterColumn(2, this.value)"></th>
                        <th>
                            <select class="form-control" id="classFilterDropdown" onchange="filterColumn(3, this.value)">
                                <option value="">All Classes</option>
                                {% for class_name in available_classes %}
                                <option value="{{ class_name }}">{{ class_name }}</option>
                                {% endfor %}
                            </select>
                        </th>
                        <th><input type="number" placeholder="Max marks" onkeyup="filterColumn(4, this.value)"></th>
                        <th><input type="number" placeholder="Pass marks" onkeyup="filterColumn(5, this.value)"></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="subjectTableBody">
                    {% for subject in subjects %}
                    <tr data-subject-id="{{ subject.id }}">
                        <td>
                            <input type="checkbox" class="subject-checkbox" value="{{ subject.id }}" style="display: none;">
                        </td>
                        <td>{{ subject.name }}</td>
                        <td>{{ subject.code }}</td>
                        <td class="class-name-cell" data-original="{{ subject.class_name }}">{{ subject.class_name }}</td>
                        <td>{{ subject.max_marks }}</td>
                        <td>{{ subject.pass_marks }}</td>
                        <td>
                            <button class="btn btn-sm" onclick="editSubject({{ subject.id }}, '{{ subject.name }}', '{{ subject.code }}', '{{ subject.class_name }}', {{ subject.max_marks }}, {{ subject.pass_marks }})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteSubject({{ subject.id }}, '{{ subject.name }}')">Delete</button>
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" style="text-align: center; color: #666;">No subjects added yet</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="table-pagination">
                <div class="pagination-info">
                    Showing <span id="subjectStartRecord">1</span> to <span id="subjectEndRecord">{{ subjects|length }}</span> of <span id="subjectTotalRecords">{{ subjects|length }}</span> entries
                </div>
                <div class="pagination">
                    <button class="page-btn" onclick="previousSubjectPage()" id="subjectPrevBtn">Previous</button>
                    <span class="page-numbers" id="subjectPageNumbers">
                        <button class="page-btn active" onclick="goToSubjectPage(1)">1</button>
                    </span>
                    <button class="page-btn" onclick="nextSubjectPage()" id="subjectNextBtn">Next</button>
                </div>
            </div>
        </div>
    </div>

    <div class="recent-section">
        <h3>Classes Overview</h3>
        <div class="students-container">
            <table class="fee-table advanced-table">
                <thead>
                    <tr>
                        <th>Class</th>
                        <th>Total Students</th>
                        <th>Total Subjects</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for class_item in class_data %}
                    <tr>
                        <td>{{ class_item.name }}</td>
                        <td>{{ class_item.student_count }}</td>
                        <td>{{ class_item.subject_count }}</td>
                        <td><button class="btn btn-sm">View Details</button></td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="4" style="text-align: center; color: #666;">No classes available</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
document.getElementById('examForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const selectedClasses = Array.from(this.querySelectorAll('input[name="class_names"]:checked')).map(cb => cb.value);
    if (selectedClasses.length === 0) {
        alert('Please select at least one class');
        return;
    }
    
    const formData = new FormData(this);
    formData.delete('class_names');
    formData.append('selected_classes', JSON.stringify(selectedClasses));
    
    fetch('{% url "create_exam" %}', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Exam created successfully!');
            this.reset();
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
});

document.getElementById('subjectForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const editId = this.dataset.editId;
    
    if (editId) {
        formData.append('subject_id', editId);
    }
    
    const url = editId ? '{% url "edit_subject" %}' : '{% url "create_subject" %}';
    
    fetch(url, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(editId ? 'Subject updated successfully!' : 'Subject added successfully!');
            this.reset();
            delete this.dataset.editId;
            this.querySelector('button[type="submit"]').textContent = 'Add Subject';
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
});

function editSubject(id, name, code, className, maxMarks, passMarks) {
    const form = document.getElementById('subjectForm');
    form.querySelector('input[name="name"]').value = name;
    form.querySelector('input[name="code"]').value = code;
    form.querySelector('select[name="class_name"]').value = className;
    form.querySelector('input[name="max_marks"]').value = maxMarks;
    form.querySelector('input[name="pass_marks"]').value = passMarks;
    
    form.dataset.editId = id;
    form.querySelector('button[type="submit"]').textContent = 'Update Subject';
    
    form.scrollIntoView({ behavior: 'smooth' });
}

document.getElementById('marksForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const formData = new FormData(this);
    const data = Object.fromEntries(formData);
    
    fetch('{% url "enter_marks" %}', {
        method: 'POST',
        body: JSON.stringify(data),
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Marks entered successfully! Grade: ${data.grade}, Status: ${data.status}`);
            this.reset();
        } else {
            alert('Error: ' + data.error);
        }
    });
});

// Store all data for filtering
const allStudents = [
    {% for student in students %}
    {id: '{{ student.id }}', name: '{{ student.name }}', class: '{{ student.student_class }}'},
    {% endfor %}
];

const allExams = [
    {% for exam in exams %}
    {id: '{{ exam.id }}', name: '{{ exam.name }}', class: '{{ exam.class_name }}', type: '{{ exam.exam_type }}', session: '{{ exam.session }}'},
    {% endfor %}
];

const allSubjects = [
    {% for subject in subjects %}
    {id: '{{ subject.id }}', name: '{{ subject.name }}', class: '{{ subject.class_name }}', maxMarks: {{ subject.max_marks }}, passMarks: {{ subject.pass_marks }}},
    {% endfor %}
];

// Function to populate dropdowns based on class filter
function populateDropdowns(selectedClass = '') {
    const studentSelect = document.getElementById('studentSelect');
    const examSelect = document.getElementById('examSelect');
    const subjectSelect = document.getElementById('subjectSelect');
    
    // Clear existing options (except first)
    studentSelect.innerHTML = '<option value="">Select Student</option>';
    examSelect.innerHTML = '<option value="">Select Exam</option>';
    subjectSelect.innerHTML = '<option value="">Select Subject</option>';
    
    // Filter and populate students
    const filteredStudents = selectedClass ? 
        allStudents.filter(s => s.class === selectedClass) : allStudents;
    
    filteredStudents.forEach(student => {
        const option = document.createElement('option');
        option.value = student.id;
        option.textContent = `${student.name} - ${student.class}`;
        studentSelect.appendChild(option);
    });
    
    // Filter and populate exams
    const filteredExams = selectedClass ? 
        allExams.filter(e => e.class === selectedClass) : allExams;
    
    filteredExams.forEach(exam => {
        const option = document.createElement('option');
        option.value = exam.id;
        option.textContent = `${exam.name} - ${exam.class}`;
        examSelect.appendChild(option);
    });
    
    // Filter and populate subjects
    const filteredSubjects = selectedClass ? 
        allSubjects.filter(s => s.class === selectedClass) : allSubjects;
    
    filteredSubjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.id;
        option.textContent = `${subject.name} - ${subject.class}`;
        subjectSelect.appendChild(option);
    });
}

// Load students, exams, and subjects for marks entry
window.addEventListener('load', function() {
    // Initial population
    populateDropdowns();
    
    // Add class filter event listener
    document.getElementById('classFilter').addEventListener('change', function() {
        populateDropdowns(this.value);
    });
});



function editSubject(id, name, code, className, maxMarks, passMarks) {
    const form = document.getElementById('subjectForm');
    form.querySelector('input[name="name"]').value = name;
    form.querySelector('input[name="code"]').value = code;
    form.querySelector('select[name="class_name"]').value = className;
    form.querySelector('input[name="max_marks"]').value = maxMarks;
    form.querySelector('input[name="pass_marks"]').value = passMarks;
    
    form.dataset.editId = id;
    form.querySelector('button[type="submit"]').textContent = 'Update Subject';
    
    form.scrollIntoView({ behavior: 'smooth' });
}
let subjectSortDirection = {};
let subjectCurrentPage = 1;
let subjectEntriesPerPage = 10;

function sortSubjectTable(columnIndex) {
    const table = document.querySelector('.advanced-table');
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => row.cells.length > 1);
    
    const isAscending = subjectSortDirection[columnIndex] !== 'asc';
    subjectSortDirection[columnIndex] = isAscending ? 'asc' : 'desc';
    
    rows.sort((a, b) => {
        const aValue = a.cells[columnIndex].textContent.trim();
        const bValue = b.cells[columnIndex].textContent.trim();
        
        if (columnIndex === 4 || columnIndex === 5) {
            return isAscending ? parseInt(aValue) - parseInt(bValue) : parseInt(bValue) - parseInt(aValue);
        }
        
        return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
    });
    
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    document.querySelectorAll('.advanced-table .sort-icon').forEach(icon => icon.textContent = '↕');
    const thElements = document.querySelectorAll('.advanced-table th');
    if (thElements[columnIndex] && thElements[columnIndex].querySelector('.sort-icon')) {
        thElements[columnIndex].querySelector('.sort-icon').textContent = isAscending ? '↑' : '↓';
    }
}

function filterColumn(columnIndex, filterValue) {
    const rows = document.querySelectorAll('.advanced-table tbody tr');
    rows.forEach(row => {
        const cellValue = row.cells[columnIndex].textContent.toLowerCase();
        const match = cellValue.includes(filterValue.toLowerCase());
        row.style.display = match ? '' : 'none';
    });
}

function changeEntriesPerPage() {
    subjectEntriesPerPage = parseInt(document.getElementById('entriesPerPage').value);
    paginateSubjectTable();
}

function paginateSubjectTable() {
    const rows = document.querySelectorAll('.advanced-table tbody tr');
    const totalRows = rows.length;
    const totalPages = Math.ceil(totalRows / subjectEntriesPerPage);
    
    rows.forEach((row, index) => {
        const startIndex = (subjectCurrentPage - 1) * subjectEntriesPerPage;
        const endIndex = startIndex + subjectEntriesPerPage;
        row.style.display = (index >= startIndex && index < endIndex) ? '' : 'none';
    });
    
    document.getElementById('subjectStartRecord').textContent = Math.min((subjectCurrentPage - 1) * subjectEntriesPerPage + 1, totalRows);
    document.getElementById('subjectEndRecord').textContent = Math.min(subjectCurrentPage * subjectEntriesPerPage, totalRows);
    document.getElementById('subjectTotalRecords').textContent = totalRows;
}

function previousSubjectPage() {
    if (subjectCurrentPage > 1) {
        subjectCurrentPage--;
        paginateSubjectTable();
    }
}

function nextSubjectPage() {
    const totalRows = document.querySelectorAll('.advanced-table tbody tr').length;
    const totalPages = Math.ceil(totalRows / subjectEntriesPerPage);
    if (subjectCurrentPage < totalPages) {
        subjectCurrentPage++;
        paginateSubjectTable();
    }
}

function goToSubjectPage(page) {
    subjectCurrentPage = page;
    paginateSubjectTable();
}

document.getElementById('subjectSearch').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('.advanced-table tbody tr');
    
    rows.forEach(row => {
        const found = Array.from(row.cells).some(cell => 
            cell.textContent.toLowerCase().includes(searchTerm)
        );
        row.style.display = found ? '' : 'none';
    });
});

function changeViewMode() {
    const mode = document.getElementById('viewMode').value;
    const actionsGrid = document.getElementById('actionsGrid');
    
    if (mode === 'table') {
        actionsGrid.style.display = 'none';
    } else {
        actionsGrid.style.display = 'grid';
    }
}

function exportData() {
    const data = {
        exams: allExams,
        subjects: allSubjects,
        students: allStudents
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'marksheet_data.json';
    a.click();
}

function toggleSection(sectionId) {
    const section = document.querySelector(`[data-category="${sectionId.replace('-entry', '')}"]`);
    section.classList.toggle('hidden');
}

function clearMarksForm() {
    document.getElementById('marksForm').reset();
}

function filterExams(searchTerm) {
    const examItems = document.querySelectorAll('.exam-item');
    examItems.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm.toLowerCase()) ? '' : 'none';
    });
}

function sortExams(sortBy) {
    const examList = document.querySelector('.exam-list');
    const items = Array.from(examList.querySelectorAll('.exam-item'));
    
    items.sort((a, b) => {
        const aText = a.querySelector('.exam-info h4').textContent;
        const bText = b.querySelector('.exam-info h4').textContent;
        return aText.localeCompare(bText);
    });
    
    examList.innerHTML = '';
    items.forEach(item => examList.appendChild(item));
}

function addBulkSubjects() {
    alert('Bulk subject addition feature - to be implemented');
}

function exportSubjects() {
    const subjects = Array.from(document.querySelectorAll('.advanced-table tbody tr')).filter(row => row.cells.length > 1).map(row => {
        return {
            name: row.cells[1].textContent,
            code: row.cells[2].textContent,
            class: row.cells[3].textContent,
            maxMarks: row.cells[4].textContent,
            passMarks: row.cells[5].textContent
        };
    });
    
    const csv = 'Name,Code,Class,Max Marks,Pass Marks\n' + 
        subjects.map(s => `"${s.name}","${s.code}","${s.class}",${s.maxMarks},${s.passMarks}`).join('\n');
    
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'subjects.csv';
    a.click();
}

function exportSubjectsJSON() {
    const subjects = Array.from(document.querySelectorAll('.advanced-table tbody tr')).filter(row => row.cells.length > 1).map(row => {
        return {
            name: row.cells[1].textContent,
            code: row.cells[2].textContent,
            class: row.cells[3].textContent,
            maxMarks: parseInt(row.cells[4].textContent),
            passMarks: parseInt(row.cells[5].textContent)
        };
    });
    
    const blob = new Blob([JSON.stringify(subjects, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'subjects.json';
    a.click();
}

function importSubjects(input) {
    const file = input.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            let subjects = [];
            
            if (file.name.endsWith('.csv')) {
                const lines = e.target.result.split('\n');
                const headers = lines[0].split(',');
                
                for (let i = 1; i < lines.length; i++) {
                    if (lines[i].trim()) {
                        const values = lines[i].split(',');
                        subjects.push({
                            name: values[0].replace(/"/g, ''),
                            code: values[1].replace(/"/g, ''),
                            class_name: values[2].replace(/"/g, ''),
                            max_marks: parseInt(values[3]),
                            pass_marks: parseInt(values[4])
                        });
                    }
                }
            } else if (file.name.endsWith('.json')) {
                subjects = JSON.parse(e.target.result);
                subjects = subjects.map(s => ({
                    name: s.name,
                    code: s.code,
                    class_name: s.class || s.class_name,
                    max_marks: s.maxMarks || s.max_marks,
                    pass_marks: s.passMarks || s.pass_marks
                }));
            }
            
            if (subjects.length > 0) {
                importSubjectsToServer(subjects);
            } else {
                alert('No valid subjects found in the file.');
            }
        } catch (error) {
            alert('Error reading file: ' + error.message);
        }
    };
    
    reader.readAsText(file);
    input.value = ''; // Reset file input
}

function importSubjectsToServer(subjects) {
    if (confirm(`Import ${subjects.length} subjects? This will create new subjects.`)) {
        // Create subjects one by one
        let imported = 0;
        let errors = [];
        
        subjects.forEach((subject, index) => {
            const formData = new FormData();
            formData.append('name', subject.name);
            formData.append('code', subject.code);
            formData.append('class_name', subject.class_name);
            formData.append('max_marks', subject.max_marks);
            formData.append('pass_marks', subject.pass_marks);
            
            fetch('{% url "create_subject" %}', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    imported++;
                } else {
                    errors.push(`${subject.name}: ${data.error}`);
                }
                
                // Check if all requests are complete
                if (imported + errors.length === subjects.length) {
                    let message = `Import completed: ${imported} subjects imported successfully.`;
                    if (errors.length > 0) {
                        message += `\n${errors.length} errors:\n${errors.slice(0, 5).join('\n')}`;
                        if (errors.length > 5) message += `\n... and ${errors.length - 5} more errors`;
                    }
                    alert(message);
                    location.reload();
                }
            })
            .catch(error => {
                errors.push(`${subject.name}: Network error`);
                if (imported + errors.length === subjects.length) {
                    alert(`Import completed with errors: ${imported} imported, ${errors.length} failed.`);
                    location.reload();
                }
            });
        });
    }
}

function showBulkDeleteOptions() {
    const checkboxes = document.querySelectorAll('.subject-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllSubjects');
    const selectAllLabel = document.getElementById('selectAllLabel');
    const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
    
    const isVisible = checkboxes[0].style.display !== 'none';
    
    checkboxes.forEach(cb => {
        cb.style.display = isVisible ? 'none' : 'inline-block';
    });
    
    selectAllCheckbox.style.display = isVisible ? 'none' : 'inline-block';
    selectAllLabel.style.display = isVisible ? 'none' : 'inline-block';
    bulkDeleteBtn.style.display = isVisible ? 'none' : 'inline-block';
}

function toggleAllSubjects(selectAllCheckbox) {
    const checkboxes = document.querySelectorAll('.subject-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = selectAllCheckbox.checked;
    });
}

function toggleBulkDelete() {
    const selectedCheckboxes = document.querySelectorAll('.subject-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('Please select subjects to delete.');
        return;
    }
    
    const subjectNames = Array.from(selectedCheckboxes).map(cb => {
        const row = cb.closest('tr');
        return row.cells[1].textContent;
    });
    
    if (confirm(`Delete ${selectedCheckboxes.length} selected subjects?\n\nSubjects:\n${subjectNames.slice(0, 5).join('\n')}${subjectNames.length > 5 ? '\n... and ' + (subjectNames.length - 5) + ' more' : ''}\n\nThis action cannot be undone.`)) {
        const subjectIds = Array.from(selectedCheckboxes).map(cb => cb.value);
        bulkDeleteSubjects(subjectIds);
    }
}

function bulkDeleteSubjects(subjectIds) {
    let deleted = 0;
    let errors = [];
    
    subjectIds.forEach(subjectId => {
        fetch('{% url "delete_subject" %}', {
            method: 'POST',
            body: JSON.stringify({ subject_id: subjectId }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                deleted++;
            } else {
                errors.push(data.error);
            }
            
            if (deleted + errors.length === subjectIds.length) {
                let message = `Bulk delete completed: ${deleted} subjects deleted.`;
                if (errors.length > 0) {
                    message += `\n${errors.length} errors occurred.`;
                }
                alert(message);
                location.reload();
            }
        })
        .catch(error => {
            errors.push('Network error');
            if (deleted + errors.length === subjectIds.length) {
                alert(`Bulk delete completed with errors: ${deleted} deleted, ${errors.length} failed.`);
                location.reload();
            }
        });
    });
}

function deleteSubject(subjectId, subjectName) {
    if (confirm(`Delete subject "${subjectName}"?\n\nThis will also delete all associated marksheets.`)) {
        fetch('{% url "delete_subject" %}', {
            method: 'POST',
            body: JSON.stringify({ subject_id: subjectId }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Subject deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting subject');
        });
    }
}

document.getElementById('globalSearch').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    
    // Filter action cards
    document.querySelectorAll('.action-card').forEach(card => {
        const text = card.textContent.toLowerCase();
        card.classList.toggle('filtered', !text.includes(searchTerm));
    });
    
    // Filter sections
    document.querySelectorAll('.recent-section').forEach(section => {
        const text = section.textContent.toLowerCase();
        section.classList.toggle('highlight', text.includes(searchTerm) && searchTerm.length > 2);
    });
});



function deleteExam(examId, examName, examClass) {
    if (confirm(`Are you sure you want to delete exam "${examName}" for class ${examClass}?\n\nThis will also delete all associated marksheets.`)) {
        fetch('{% url "delete_exam" %}', {
            method: 'POST',
            body: JSON.stringify({ exam_id: examId }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Exam deleted successfully!');
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting exam');
        });
    }
}

function enableBulkEdit() {
    const selectedClass = document.getElementById('bulkEditClassSelect').value;
    const bulkEditBtn = document.getElementById('bulkEditBtn');
    
    if (selectedClass) {
        bulkEditBtn.style.display = 'inline-block';
        // Highlight subjects of selected class or all subjects
        const rows = document.querySelectorAll('.advanced-table tbody tr');
        rows.forEach(row => {
            if (selectedClass === 'All Subjects' || row.cells[2].textContent === selectedClass) {
                row.style.backgroundColor = '#fff3cd';
            } else {
                row.style.backgroundColor = '';
            }
        });
    } else {
        bulkEditBtn.style.display = 'none';
        // Remove highlighting
        const rows = document.querySelectorAll('.advanced-table tbody tr');
        rows.forEach(row => {
            row.style.backgroundColor = '';
        });
    }
}

function bulkEditSubjects() {
    const selectedClass = document.getElementById('bulkEditClassSelect').value;
    
    if (!selectedClass) {
        alert('Please select a class first');
        return;
    }
    
    const targetText = selectedClass === 'All Subjects' ? 'all subjects' : `all ${selectedClass} subjects`;
    const newMaxMarks = prompt(`Enter new Max Marks for ${targetText}:`, '100');
    const newPassMarks = prompt(`Enter new Pass Marks for ${targetText}:`, '35');
    
    if (newMaxMarks === null || newPassMarks === null) return;
    
    if (confirm(`Update ${targetText} with:\nMax Marks: ${newMaxMarks}\nPass Marks: ${newPassMarks}`)) {
        fetch('{% url "bulk_edit_subjects" %}', {
            method: 'POST',
            body: JSON.stringify({
                class_name: selectedClass,
                max_marks: parseInt(newMaxMarks),
                pass_marks: parseInt(newPassMarks)
            }),
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const message = selectedClass === 'All Subjects' ? 
                    `Successfully updated ${data.updated_count} subjects across all classes` :
                    `Successfully updated ${data.updated_count} subjects for class ${selectedClass}`;
                alert(message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error updating subjects');
        });
    }
}

// Convert class names from numeric to word format
function convertClassNames() {
    const classNameMapping = {
        '1st': 'One',
        '2nd': 'Two',
        '3rd': 'Three',
        '4th': 'Four',
        '5th': 'Five',
        '6th': 'Six',
        '7th': 'Seven',
        '8th': 'Eight',
        '9th': 'Nine',
        '10th': 'Ten',
        '11th': 'Eleven',
        '12th': 'Twelve'
    };
    
    const classCells = document.querySelectorAll('.class-name-cell');
    classCells.forEach(cell => {
        const originalClass = cell.dataset.original;
        const convertedClass = classNameMapping[originalClass] || originalClass;
        cell.textContent = convertedClass;
    });
}

window.addEventListener('load', function() {
    paginateSubjectTable();
    convertClassNames();
});
</script>
{% endblock %}