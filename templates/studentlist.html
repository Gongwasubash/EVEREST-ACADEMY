{% extends "base.html" %}

{% block title %}Student List - School Management{% endblock %}

{% block content %}
{% csrf_token %}
<input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
<div class="student-list-container">
    <!-- Header Section -->
    <div class="page-header">
        <h1>Student List</h1>
        <div class="header-actions">
            <input type="text" id="searchInput" placeholder="Search students..." class="search-input">
            <a href="{% url 'download_csv' %}" class="btn btn-secondary">Download CSV</a>
            <button class="btn btn-secondary" onclick="downloadTemplate()">Download Template</button>
            <input type="file" id="csvFile" accept=".csv" style="display: none;" onchange="uploadCSV()">
            <button class="btn btn-secondary" onclick="document.getElementById('csvFile').click()">Upload CSV</button>
            <button class="btn btn-danger" id="bulkDeleteBtn" onclick="bulkDelete()" style="display:none;">Delete Selected</button>
            <button class="btn btn-primary" onclick="window.location.href='{% url 'students' %}'">New Admission</button>
        </div>
    </div>

    <!-- Student Table -->
    <div class="table-container">
        <table class="table table-striped" id="studentTable">
            <thead>
                <tr>
                    <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll()"></th>
                    <th onclick="sortTable(1)">S.No <span class="sort-icon">↕</span></th>
                    <th onclick="sortTable(1)">ID <span class="sort-icon">↕</span></th>
                    <th onclick="sortTable(2)">Reg. No. <span class="sort-icon">↕</span></th>
                    <th onclick="sortTable(3)">Name <span class="sort-icon">↕</span></th>
                    <th onclick="sortTable(4)">Father Name <span class="sort-icon">↕</span></th>
                    <th onclick="sortTable(5)">Class <span class="sort-icon">↕</span></th>
                    <th onclick="sortTable(6)">Section <span class="sort-icon">↕</span></th>
                    <th onclick="sortTable(7)">Gender <span class="sort-icon">↕</span></th>
                    <th onclick="sortTable(8)">Mobile <span class="sort-icon">↕</span></th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody id="studentTableBody">
                {% for student in students %}
                <tr>
                    <td><input type="checkbox" class="student-checkbox" value="{{ student.id }}" onchange="updateBulkDeleteBtn()"></td>
                    <td>{{ forloop.counter }}</td>
                    <td>STU{{ student.id|stringformat:"03d" }}</td>
                    <td>{{ student.reg_number }}</td>
                    <td>{{ student.name }}</td>
                    <td>{{ student.father_name }}</td>
                    <td>{{ student.student_class }}</td>
                    <td>{{ student.section }}</td>
                    <td>{{ student.gender|first }}</td>
                    <td>{{ student.mobile }}</td>
                    <td>
                        <button class="action-btn view-btn" onclick="viewStudent({{ student.id }})" title="View">V</button>
                        <button class="action-btn print-btn" onclick="printStudent({{ student.id }})" title="Print">P</button>
                        <button class="action-btn fee-btn" onclick="feeStudent({{ student.id }})" title="Fee">Fee</button>
                        <button class="action-btn edit-btn" onclick="editStudent({{ student.id }})" title="Edit">Edit</button>
                        <button class="action-btn delete-btn" onclick="deleteStudent({{ student.id }})" title="Delete">Del</button>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="11" style="text-align: center; padding: 20px;">No students found. <a href="{% url 'students' %}">Add new student</a></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div class="pagination-container">
        <div class="pagination-info">
            Showing <span id="startRecord">1</span> to <span id="endRecord">{{ students|length }}</span> of <span id="totalRecords">{{ students|length }}</span> entries
        </div>
        <div class="pagination">
            <button class="page-btn" onclick="previousPage()" id="prevBtn">Previous</button>
            <span class="page-numbers" id="pageNumbers">
                <button class="page-btn active" onclick="goToPage(1)">1</button>
            </span>
            <button class="page-btn" onclick="nextPage()" id="nextBtn">Next</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.student-list-container {
    padding: 20px;
}

.page-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #e2e8f0;
}

.header-actions {
    display: flex;
    gap: 15px;
    align-items: center;
}

.search-input {
    padding: 8px 15px;
    border: 1px solid #ddd;
    border-radius: 5px;
    width: 250px;
    font-size: 14px;
}

.table-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow-x: auto;
    max-height: 600px;
    overflow-y: auto;
}

.table {
    margin: 0;
    font-size: 14px;
}

.table th {
    background: #f8fafc;
    position: sticky;
    top: 0;
    z-index: 10;
    cursor: pointer;
    user-select: none;
    white-space: nowrap;
    padding: 12px 8px;
}

.table th:hover {
    background: #e2e8f0;
}

.sort-icon {
    margin-left: 5px;
    color: #666;
    font-size: 12px;
}

.table td {
    padding: 10px 8px;
    vertical-align: middle;
}

.action-btn {
    padding: 4px 8px;
    margin: 0 2px;
    border: none;
    border-radius: 3px;
    font-size: 11px;
    font-weight: bold;
    cursor: pointer;
    min-width: 30px;
}

.view-btn { background: #3182ce; color: white; }
.print-btn { background: #63b3ed; color: white; }
.fee-btn { background: #38a169; color: white; }
.edit-btn { background: #ed8936; color: white; }
.delete-btn { background: #e53e3e; color: white; }

.action-btn:hover {
    opacity: 0.8;
    transform: translateY(-1px);
}

.pagination-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
    padding: 15px 0;
}

.pagination {
    display: flex;
    gap: 5px;
    align-items: center;
}

.page-btn {
    padding: 8px 12px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 4px;
    font-size: 14px;
}

.page-btn:hover, .page-btn.active {
    background: #3182ce;
    color: white;
    border-color: #3182ce;
}

@media (max-width: 768px) {
    .student-list-container {
        margin-left: 0;
        padding: 10px;
    }
    
    .page-header {
        flex-direction: column;
        gap: 15px;
        align-items: stretch;
    }
    
    .header-actions {
        justify-content: space-between;
    }
    
    .search-input {
        width: 100%;
        max-width: 200px;
    }
    
    .pagination-container {
        flex-direction: column;
        gap: 10px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let recordsPerPage = 10;
let sortDirection = {};

function downloadCSV() {
    window.location.href = '/download-csv/';
}

function downloadTemplate() {
    window.location.href = '/download-template/';
}

// Search functionality
document.getElementById('searchInput').addEventListener('keyup', function() {
    const searchTerm = this.value.toLowerCase();
    const table = document.getElementById('studentTable');
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const cells = row.getElementsByTagName('td');
        let found = false;
        
        for (let j = 0; j < cells.length - 1; j++) {
            if (cells[j].textContent.toLowerCase().includes(searchTerm)) {
                found = true;
                break;
            }
        }
        
        row.style.display = found ? '' : 'none';
    }
});

// Sort functionality
function sortTable(columnIndex) {
    const table = document.getElementById('studentTable');
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    const isAscending = sortDirection[columnIndex] !== 'asc';
    sortDirection[columnIndex] = isAscending ? 'asc' : 'desc';
    
    rows.sort((a, b) => {
        const aValue = a.getElementsByTagName('td')[columnIndex].textContent.trim();
        const bValue = b.getElementsByTagName('td')[columnIndex].textContent.trim();
        
        if (columnIndex === 0) {
            return isAscending ? parseInt(aValue) - parseInt(bValue) : parseInt(bValue) - parseInt(aValue);
        }
        
        return isAscending ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
    });
    
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
    
    document.querySelectorAll('.sort-icon').forEach(icon => icon.textContent = '↕');
    document.querySelectorAll('th')[columnIndex].querySelector('.sort-icon').textContent = isAscending ? '↑' : '↓';
}

function viewStudent(id) {
    window.location.href = '/edit-student/' + id + '/';
}

function printStudent(id) {
    window.print();
}

function feeStudent(id) {
    window.location.href = '/pay-student/' + id + '/';
}

function editStudent(id) {
    window.location.href = '/edit-student/' + id + '/';
}

function deleteStudent(id) {
    if (confirm('Are you sure you want to delete this student?')) {
        fetch('/delete-student/' + id + '/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Student deleted successfully!');
                location.reload();
            } else {
                alert('Error deleting student: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error deleting student. Please try again.');
        });
    }
}

function uploadCSV() {
    const fileInput = document.getElementById('csvFile');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a CSV file.');
        return;
    }
    
    if (!file.name.toLowerCase().endsWith('.csv')) {
        alert('Please select a valid CSV file.');
        return;
    }
    
    // Show loading message
    const originalText = 'Upload CSV';
    const uploadBtn = document.querySelector('button[onclick="document.getElementById(\'csvFile\').click()"]');
    uploadBtn.textContent = 'Uploading...';
    uploadBtn.disabled = true;
    
    const formData = new FormData();
    formData.append('csv_file', file);
    
    // Get CSRF token from cookie or meta tag
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    fetch('/upload-csv/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': csrfToken
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            let message = data.message || 'Students imported successfully from CSV file!';
            if (data.errors && data.errors.length > 0) {
                message += '\n\nSome rows had errors:\n' + data.errors.join('\n');
            }
            alert(message);
            location.reload();
        } else {
            alert('Failed to upload CSV: ' + (data.error || 'Please check file format'));
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        alert('Error uploading CSV. Please check your file format and try again.');
    })
    .finally(() => {
        // Reset button
        uploadBtn.textContent = originalText;
        uploadBtn.disabled = false;
        fileInput.value = ''; // Clear file input
    });
}

function previousPage() {
    if (currentPage > 1) {
        currentPage--;
    }
}

function nextPage() {
    currentPage++;
}

function goToPage(page) {
    currentPage = page;
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.student-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
    updateBulkDeleteBtn();
}

function updateBulkDeleteBtn() {
    const selected = document.querySelectorAll('.student-checkbox:checked');
    const bulkBtn = document.getElementById('bulkDeleteBtn');
    bulkBtn.style.display = selected.length > 0 ? 'inline-block' : 'none';
}

function bulkDelete() {
    const selected = document.querySelectorAll('.student-checkbox:checked');
    if (selected.length === 0) return;
    
    if (confirm(`Delete ${selected.length} selected students?`)) {
        const ids = Array.from(selected).map(cb => cb.value);
        fetch('/bulk-delete-students/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({student_ids: ids})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(`${data.deleted_count} students deleted successfully!`);
                location.reload();
            } else {
                alert('Error: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            alert('Error deleting students. Please try again.');
        });
    }
}
</script>
{% endblock %}