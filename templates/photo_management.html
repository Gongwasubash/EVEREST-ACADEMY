{% extends "base.html" %}

{% block title %}Photo Management - School Management{% endblock %}

{% block content %}
<div class="photo-management-container">
    <div class="page-header">
        <h1><i class="fas fa-camera"></i> Student Photo Management</h1>
        <p>Upload, manage, and assign photos to students</p>
    </div>

    <!-- Quick Stats -->
    <div class="stats-row">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-users"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalStudents">0</h3>
                <p>Total Students</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-image"></i>
            </div>
            <div class="stat-info">
                <h3 id="studentsWithPhotos">0</h3>
                <p>With Photos</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-user-times"></i>
            </div>
            <div class="stat-info">
                <h3 id="studentsWithoutPhotos">0</h3>
                <p>Without Photos</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-folder-open"></i>
            </div>
            <div class="stat-info">
                <h3 id="totalPhotos">0</h3>
                <p>Available Photos</p>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button class="btn btn-primary" onclick="openUploadModal()">
            <i class="fas fa-upload"></i> Upload Photos
        </button>
        <button class="btn btn-secondary" onclick="openBulkAssignModal()">
            <i class="fas fa-random"></i> Bulk Assign
        </button>
        <button class="btn btn-info" onclick="viewPhotoGallery()">
            <i class="fas fa-th"></i> Photo Gallery
        </button>
        <button class="btn btn-success" onclick="exportPhotoReport()">
            <i class="fas fa-download"></i> Export Report
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="search-filter-section">
        <div class="search-box">
            <input type="text" id="studentSearch" placeholder="Search students by name, class, or roll number...">
            <button onclick="searchStudents()"><i class="fas fa-search"></i></button>
        </div>
        <div class="filter-options">
            <select id="classFilter" onchange="filterStudents()">
                <option value="">All Classes</option>
                <option value="Nursery">Nursery</option>
                <option value="LKG">LKG</option>
                <option value="UKG">UKG</option>
                <option value="One">One</option>
                <option value="Two">Two</option>
                <option value="Three">Three</option>
                <option value="Four">Four</option>
                <option value="Five">Five</option>
                <option value="Six">Six</option>
                <option value="Seven">Seven</option>
                <option value="Eight">Eight</option>
                <option value="Nine">Nine</option>
                <option value="Ten">Ten</option>
                <option value="Eleven">Eleven</option>
                <option value="Twelve">Twelve</option>
            </select>
            <select id="photoStatusFilter" onchange="filterStudents()">
                <option value="">All Students</option>
                <option value="with-photo">With Photos</option>
                <option value="without-photo">Without Photos</option>
            </select>
        </div>
    </div>

    <!-- Students Grid -->
    <div class="students-grid" id="studentsGrid">
        <!-- Students will be loaded here -->
    </div>

    <!-- Pagination -->
    <div class="pagination-container">
        <div class="pagination" id="pagination">
            <!-- Pagination will be generated here -->
        </div>
    </div>
</div>

<!-- Upload Modal -->
<div id="uploadModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-upload"></i> Upload Student Photos</h2>
            <span class="close" onclick="closeUploadModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="upload-area" id="uploadArea">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <p>Drag and drop photos here or click to browse</p>
                <input type="file" id="photoInput" multiple accept="image/*" style="display: none;">
                <button class="btn btn-primary" onclick="document.getElementById('photoInput').click()">
                    Choose Files
                </button>
            </div>
            <div class="upload-progress" id="uploadProgress" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <p id="progressText">Uploading...</p>
            </div>
            <div class="uploaded-files" id="uploadedFiles">
                <!-- Uploaded files will appear here -->
            </div>
        </div>
    </div>
</div>

<!-- Bulk Assign Modal -->
<div id="bulkAssignModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-random"></i> Bulk Photo Assignment</h2>
            <span class="close" onclick="closeBulkAssignModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="bulk-options">
                <div class="option-card" onclick="randomAssignAll()">
                    <i class="fas fa-dice"></i>
                    <h3>Random Assignment</h3>
                    <p>Randomly assign available photos to students without photos</p>
                </div>
                <div class="option-card" onclick="assignByClass()">
                    <i class="fas fa-layer-group"></i>
                    <h3>Assign by Class</h3>
                    <p>Assign photos to specific class students</p>
                </div>
                <div class="option-card" onclick="clearAllPhotos()">
                    <i class="fas fa-trash-alt"></i>
                    <h3>Clear All Photos</h3>
                    <p>Remove photo assignments from all students</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photo Assignment Modal -->
<div id="photoAssignModal" class="modal">
    <div class="modal-content large-modal">
        <div class="modal-header">
            <h2><i class="fas fa-user-edit"></i> Assign Photo</h2>
            <span class="close" onclick="closePhotoAssignModal()">&times;</span>
        </div>
        <div class="modal-body">
            <div class="student-info" id="assignStudentInfo">
                <!-- Student info will be loaded here -->
            </div>
            <div class="photo-selection">
                <h3>Select a Photo:</h3>
                <div class="photo-grid" id="photoSelectionGrid">
                    <!-- Available photos will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.photo-management-container {
    padding: 20px;
    max-width: 1400px;
    margin: 0 auto;
}

.page-header {
    text-align: center;
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.page-header i {
    margin-right: 10px;
    color: #3498db;
}

.stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.stat-card {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    transition: transform 0.3s ease;
}

.stat-card:hover {
    transform: translateY(-5px);
}

.stat-icon {
    font-size: 2.5rem;
    margin-right: 15px;
    color: #3498db;
}

.stat-info h3 {
    font-size: 2rem;
    margin: 0;
    color: #2c3e50;
}

.stat-info p {
    margin: 5px 0 0 0;
    color: #7f8c8d;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin-bottom: 30px;
    flex-wrap: wrap;
}

.btn {
    padding: 12px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.btn-primary {
    background: #3498db;
    color: white;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
}

.btn-info {
    background: #17a2b8;
    color: white;
}

.btn-success {
    background: #28a745;
    color: white;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.search-filter-section {
    background: white;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 30px;
    display: flex;
    gap: 20px;
    align-items: center;
    flex-wrap: wrap;
}

.search-box {
    display: flex;
    flex: 1;
    min-width: 300px;
}

.search-box input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px 0 0 5px;
    font-size: 14px;
}

.search-box button {
    padding: 12px 15px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 0 5px 5px 0;
    cursor: pointer;
}

.filter-options {
    display: flex;
    gap: 10px;
}

.filter-options select {
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 14px;
}

.students-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
}

.student-card {
    background: white;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.3s ease;
}

.student-card:hover {
    transform: translateY(-5px);
}

.student-photo-container {
    height: 200px;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

.student-photo {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.no-photo {
    color: #95a5a6;
    font-size: 3rem;
}

.photo-status {
    position: absolute;
    top: 10px;
    right: 10px;
    padding: 5px 10px;
    border-radius: 15px;
    font-size: 12px;
    font-weight: bold;
}

.photo-status.has-photo {
    background: #28a745;
    color: white;
}

.photo-status.no-photo {
    background: #dc3545;
    color: white;
}

.student-info {
    padding: 15px;
}

.student-name {
    font-size: 1.1rem;
    font-weight: bold;
    color: #2c3e50;
    margin-bottom: 5px;
}

.student-details {
    color: #7f8c8d;
    font-size: 0.9rem;
    margin-bottom: 10px;
}

.student-actions {
    display: flex;
    gap: 10px;
}

.btn-sm {
    padding: 8px 12px;
    font-size: 12px;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
}

.modal-content {
    background: white;
    margin: 5% auto;
    padding: 0;
    border-radius: 10px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
}

.large-modal {
    max-width: 900px;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
    color: #2c3e50;
}

.close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #aaa;
}

.close:hover {
    color: #000;
}

.modal-body {
    padding: 20px;
}

.upload-area {
    border: 2px dashed #3498db;
    border-radius: 10px;
    padding: 40px;
    text-align: center;
    margin-bottom: 20px;
    transition: all 0.3s ease;
}

.upload-area:hover {
    border-color: #2980b9;
    background: #f8f9fa;
}

.upload-area.dragover {
    border-color: #27ae60;
    background: #d5f4e6;
}

.upload-icon {
    font-size: 3rem;
    color: #3498db;
    margin-bottom: 15px;
}

.upload-progress {
    margin-bottom: 20px;
}

.progress-bar {
    width: 100%;
    height: 20px;
    background: #f0f0f0;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: #28a745;
    width: 0%;
    transition: width 0.3s ease;
}

.uploaded-files {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 10px;
}

.uploaded-file {
    position: relative;
    border-radius: 5px;
    overflow: hidden;
}

.uploaded-file img {
    width: 100%;
    height: 80px;
    object-fit: cover;
}

.bulk-options {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
}

.option-card {
    padding: 20px;
    border: 2px solid #ddd;
    border-radius: 10px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.option-card:hover {
    border-color: #3498db;
    background: #f8f9fa;
}

.option-card i {
    font-size: 2rem;
    color: #3498db;
    margin-bottom: 10px;
}

.option-card h3 {
    margin: 10px 0;
    color: #2c3e50;
}

.option-card p {
    color: #7f8c8d;
    font-size: 0.9rem;
}

.photo-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 15px;
    max-height: 400px;
    overflow-y: auto;
}

.photo-option {
    position: relative;
    border-radius: 5px;
    overflow: hidden;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.photo-option:hover {
    transform: scale(1.05);
}

.photo-option img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.photo-option.selected {
    border: 3px solid #28a745;
}

.pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 30px;
}

.pagination {
    display: flex;
    gap: 5px;
}

.pagination button {
    padding: 10px 15px;
    border: 1px solid #ddd;
    background: white;
    cursor: pointer;
    border-radius: 5px;
}

.pagination button:hover {
    background: #f8f9fa;
}

.pagination button.active {
    background: #3498db;
    color: white;
    border-color: #3498db;
}

.pagination button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

@media (max-width: 768px) {
    .stats-row {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .students-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    }
    
    .search-filter-section {
        flex-direction: column;
        align-items: stretch;
    }
    
    .search-box {
        min-width: auto;
    }
    
    .action-buttons {
        justify-content: center;
    }
}
</style>

<script>
let currentPage = 1;
let studentsPerPage = 12;
let allStudents = [];
let filteredStudents = [];
let availablePhotos = [];

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadStudents();
    loadAvailablePhotos();
    setupEventListeners();
});

function setupEventListeners() {
    // Search input
    document.getElementById('studentSearch').addEventListener('input', debounce(searchStudents, 300));
    
    // File upload
    const photoInput = document.getElementById('photoInput');
    photoInput.addEventListener('change', handleFileSelect);
    
    // Drag and drop
    const uploadArea = document.getElementById('uploadArea');
    uploadArea.addEventListener('dragover', handleDragOver);
    uploadArea.addEventListener('drop', handleDrop);
    uploadArea.addEventListener('dragleave', handleDragLeave);
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

async function loadStudents() {
    try {
        // Simulate API call - replace with actual endpoint
        const response = await fetch('/api/students/');
        const data = await response.json();
        
        if (data.success) {
            allStudents = data.students;
            filteredStudents = [...allStudents];
            updateStats();
            displayStudents();
        }
    } catch (error) {
        console.error('Error loading students:', error);
        // Load sample data for demo
        loadSampleStudents();
    }
}

function loadSampleStudents() {
    // Sample data for demonstration
    allStudents = [
        {
            id: 1,
            name: 'John Doe',
            student_class: 'Ten',
            section: 'A',
            reg_number: 'REG001',
            photo: '/media/student_photos/student_403_6943.jpg',
            has_photo: true
        },
        {
            id: 2,
            name: 'Jane Smith',
            student_class: 'Nine',
            section: 'B',
            reg_number: 'REG002',
            photo: null,
            has_photo: false
        },
        // Add more sample students...
    ];
    
    // Generate more sample students
    for (let i = 3; i <= 50; i++) {
        allStudents.push({
            id: i,
            name: `Student ${i}`,
            student_class: ['Nursery', 'LKG', 'UKG', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten'][Math.floor(Math.random() * 13)],
            section: ['A', 'B', 'C'][Math.floor(Math.random() * 3)],
            reg_number: `REG${i.toString().padStart(3, '0')}`,
            photo: Math.random() > 0.6 ? `/media/student_photos/student_${400 + i}_${Math.floor(Math.random() * 9999)}.jpg` : null,
            has_photo: Math.random() > 0.6
        });
    }
    
    filteredStudents = [...allStudents];
    updateStats();
    displayStudents();
}

async function loadAvailablePhotos() {
    try {
        // Simulate loading available photos
        availablePhotos = [
            '/static/img/students/images (1).jpg',
            '/static/img/students/images (2).jpg',
            '/static/img/students/images (3).jpg',
            '/static/img/students/images (4).jpg',
            '/static/img/students/images (5).jpg',
            '/static/img/students/images (6).jpg',
            '/static/img/students/images (7).jpg',
            '/static/img/students/images (8).jpg',
            '/static/img/students/images (9).jpg',
            '/static/img/students/images (10).jpg'
        ];
    } catch (error) {
        console.error('Error loading photos:', error);
    }
}

function updateStats() {
    const totalStudents = allStudents.length;
    const studentsWithPhotos = allStudents.filter(s => s.has_photo).length;
    const studentsWithoutPhotos = totalStudents - studentsWithPhotos;
    
    document.getElementById('totalStudents').textContent = totalStudents;
    document.getElementById('studentsWithPhotos').textContent = studentsWithPhotos;
    document.getElementById('studentsWithoutPhotos').textContent = studentsWithoutPhotos;
    document.getElementById('totalPhotos').textContent = availablePhotos.length;
}

function displayStudents() {
    const startIndex = (currentPage - 1) * studentsPerPage;
    const endIndex = startIndex + studentsPerPage;
    const studentsToShow = filteredStudents.slice(startIndex, endIndex);
    
    const grid = document.getElementById('studentsGrid');
    grid.innerHTML = '';
    
    studentsToShow.forEach(student => {
        const studentCard = createStudentCard(student);
        grid.appendChild(studentCard);
    });
    
    updatePagination();
}

function createStudentCard(student) {
    const card = document.createElement('div');
    card.className = 'student-card';
    card.innerHTML = `
        <div class="student-photo-container">
            ${student.has_photo ? 
                `<img src="${student.photo}" alt="${student.name}" class="student-photo">` :
                `<i class="fas fa-user no-photo"></i>`
            }
            <div class="photo-status ${student.has_photo ? 'has-photo' : 'no-photo'}">
                ${student.has_photo ? 'Photo' : 'No Photo'}
            </div>
        </div>
        <div class="student-info">
            <div class="student-name">${student.name}</div>
            <div class="student-details">
                Class: ${student.student_class}-${student.section} | Roll: ${student.reg_number}
            </div>
            <div class="student-actions">
                <button class="btn btn-primary btn-sm" onclick="assignPhoto(${student.id})">
                    <i class="fas fa-camera"></i> ${student.has_photo ? 'Change' : 'Assign'}
                </button>
                ${student.has_photo ? 
                    `<button class="btn btn-secondary btn-sm" onclick="removePhoto(${student.id})">
                        <i class="fas fa-trash"></i> Remove
                    </button>` : ''
                }
            </div>
        </div>
    `;
    return card;
}

function updatePagination() {
    const totalPages = Math.ceil(filteredStudents.length / studentsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.textContent = 'Previous';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => changePage(currentPage - 1);
    pagination.appendChild(prevBtn);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = i === currentPage ? 'active' : '';
        pageBtn.onclick = () => changePage(i);
        pagination.appendChild(pageBtn);
    }
    
    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.textContent = 'Next';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => changePage(currentPage + 1);
    pagination.appendChild(nextBtn);
}

function changePage(page) {
    currentPage = page;
    displayStudents();
}

function searchStudents() {
    const query = document.getElementById('studentSearch').value.toLowerCase();
    filteredStudents = allStudents.filter(student => 
        student.name.toLowerCase().includes(query) ||
        student.student_class.toLowerCase().includes(query) ||
        student.reg_number.toLowerCase().includes(query)
    );
    currentPage = 1;
    displayStudents();
}

function filterStudents() {
    const classFilter = document.getElementById('classFilter').value;
    const photoStatusFilter = document.getElementById('photoStatusFilter').value;
    const searchQuery = document.getElementById('studentSearch').value.toLowerCase();
    
    filteredStudents = allStudents.filter(student => {
        const matchesSearch = !searchQuery || 
            student.name.toLowerCase().includes(searchQuery) ||
            student.student_class.toLowerCase().includes(searchQuery) ||
            student.reg_number.toLowerCase().includes(searchQuery);
        
        const matchesClass = !classFilter || student.student_class === classFilter;
        
        const matchesPhotoStatus = !photoStatusFilter || 
            (photoStatusFilter === 'with-photo' && student.has_photo) ||
            (photoStatusFilter === 'without-photo' && !student.has_photo);
        
        return matchesSearch && matchesClass && matchesPhotoStatus;
    });
    
    currentPage = 1;
    displayStudents();
}

// Modal functions
function openUploadModal() {
    document.getElementById('uploadModal').style.display = 'block';
}

function closeUploadModal() {
    document.getElementById('uploadModal').style.display = 'none';
}

function openBulkAssignModal() {
    document.getElementById('bulkAssignModal').style.display = 'block';
}

function closeBulkAssignModal() {
    document.getElementById('bulkAssignModal').style.display = 'none';
}

function openPhotoAssignModal(studentId) {
    const student = allStudents.find(s => s.id === studentId);
    if (!student) return;
    
    document.getElementById('assignStudentInfo').innerHTML = `
        <div class="student-card">
            <div class="student-photo-container">
                ${student.has_photo ? 
                    `<img src="${student.photo}" alt="${student.name}" class="student-photo">` :
                    `<i class="fas fa-user no-photo"></i>`
                }
            </div>
            <div class="student-info">
                <div class="student-name">${student.name}</div>
                <div class="student-details">
                    Class: ${student.student_class}-${student.section} | Roll: ${student.reg_number}
                </div>
            </div>
        </div>
    `;
    
    // Load photo selection grid
    const photoGrid = document.getElementById('photoSelectionGrid');
    photoGrid.innerHTML = '';
    
    availablePhotos.forEach((photo, index) => {
        const photoOption = document.createElement('div');
        photoOption.className = 'photo-option';
        photoOption.innerHTML = `<img src="${photo}" alt="Photo ${index + 1}">`;
        photoOption.onclick = () => selectPhoto(photoOption, photo, studentId);
        photoGrid.appendChild(photoOption);
    });
    
    document.getElementById('photoAssignModal').style.display = 'block';
}

function closePhotoAssignModal() {
    document.getElementById('photoAssignModal').style.display = 'none';
}

function selectPhoto(element, photoUrl, studentId) {
    // Remove previous selection
    document.querySelectorAll('.photo-option').forEach(option => {
        option.classList.remove('selected');
    });
    
    // Select current photo
    element.classList.add('selected');
    
    // Assign photo to student
    setTimeout(() => {
        assignPhotoToStudent(studentId, photoUrl);
        closePhotoAssignModal();
    }, 500);
}

function assignPhoto(studentId) {
    openPhotoAssignModal(studentId);
}

function assignPhotoToStudent(studentId, photoUrl) {
    const studentIndex = allStudents.findIndex(s => s.id === studentId);
    if (studentIndex !== -1) {
        allStudents[studentIndex].photo = photoUrl;
        allStudents[studentIndex].has_photo = true;
        updateStats();
        displayStudents();
        
        // Show success message
        showNotification('Photo assigned successfully!', 'success');
    }
}

function removePhoto(studentId) {
    if (confirm('Are you sure you want to remove this photo?')) {
        const studentIndex = allStudents.findIndex(s => s.id === studentId);
        if (studentIndex !== -1) {
            allStudents[studentIndex].photo = null;
            allStudents[studentIndex].has_photo = false;
            updateStats();
            displayStudents();
            
            showNotification('Photo removed successfully!', 'success');
        }
    }
}

// File upload functions
function handleFileSelect(event) {
    const files = event.target.files;
    uploadFiles(files);
}

function handleDragOver(event) {
    event.preventDefault();
    event.currentTarget.classList.add('dragover');
}

function handleDrop(event) {
    event.preventDefault();
    event.currentTarget.classList.remove('dragover');
    const files = event.dataTransfer.files;
    uploadFiles(files);
}

function handleDragLeave(event) {
    event.currentTarget.classList.remove('dragover');
}

function uploadFiles(files) {
    const uploadProgress = document.getElementById('uploadProgress');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const uploadedFiles = document.getElementById('uploadedFiles');
    
    uploadProgress.style.display = 'block';
    uploadedFiles.innerHTML = '';
    
    let uploadedCount = 0;
    const totalFiles = files.length;
    
    Array.from(files).forEach((file, index) => {
        if (file.type.startsWith('image/')) {
            // Simulate upload progress
            setTimeout(() => {
                uploadedCount++;
                const progress = (uploadedCount / totalFiles) * 100;
                progressFill.style.width = progress + '%';
                progressText.textContent = `Uploading... ${uploadedCount}/${totalFiles}`;
                
                // Add to uploaded files display
                const fileDiv = document.createElement('div');
                fileDiv.className = 'uploaded-file';
                const reader = new FileReader();
                reader.onload = function(e) {
                    fileDiv.innerHTML = `<img src="${e.target.result}" alt="${file.name}">`;
                };
                reader.readAsDataURL(file);
                uploadedFiles.appendChild(fileDiv);
                
                // Add to available photos
                const reader2 = new FileReader();
                reader2.onload = function(e) {
                    availablePhotos.push(e.target.result);
                    updateStats();
                };
                reader2.readAsDataURL(file);
                
                if (uploadedCount === totalFiles) {
                    progressText.textContent = 'Upload complete!';
                    setTimeout(() => {
                        uploadProgress.style.display = 'none';
                        showNotification(`${totalFiles} photos uploaded successfully!`, 'success');
                    }, 1000);
                }
            }, index * 200);
        }
    });
}

// Bulk operations
function randomAssignAll() {
    const studentsWithoutPhotos = allStudents.filter(s => !s.has_photo);
    let assignedCount = 0;
    
    studentsWithoutPhotos.forEach(student => {
        if (availablePhotos.length > 0) {
            const randomPhoto = availablePhotos[Math.floor(Math.random() * availablePhotos.length)];
            student.photo = randomPhoto;
            student.has_photo = true;
            assignedCount++;
        }
    });
    
    updateStats();
    displayStudents();
    closeBulkAssignModal();
    showNotification(`${assignedCount} photos assigned randomly!`, 'success');
}

function assignByClass() {
    // Implementation for class-based assignment
    showNotification('Class-based assignment feature coming soon!', 'info');
}

function clearAllPhotos() {
    if (confirm('Are you sure you want to remove all photo assignments?')) {
        allStudents.forEach(student => {
            student.photo = null;
            student.has_photo = false;
        });
        
        updateStats();
        displayStudents();
        closeBulkAssignModal();
        showNotification('All photos cleared!', 'success');
    }
}

// Utility functions
function viewPhotoGallery() {
    window.open('/photo-gallery/', '_blank');
}

function exportPhotoReport() {
    // Generate CSV report
    const csvContent = generatePhotoReport();
    downloadCSV(csvContent, 'photo_report.csv');
    showNotification('Photo report exported!', 'success');
}

function generatePhotoReport() {
    const headers = ['Student Name', 'Class', 'Section', 'Roll Number', 'Photo Status', 'Photo Path'];
    const rows = allStudents.map(student => [
        student.name,
        student.student_class,
        student.section,
        student.reg_number,
        student.has_photo ? 'Has Photo' : 'No Photo',
        student.photo || 'N/A'
    ]);
    
    return [headers, ...rows].map(row => row.join(',')).join('\n');
}

function downloadCSV(content, filename) {
    const blob = new Blob([content], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
        ${message}
    `;
    
    // Add styles
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 20px;
        border-radius: 5px;
        color: white;
        font-weight: bold;
        z-index: 10000;
        animation: slideIn 0.3s ease;
        background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Close modals when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}
</script>
{% endblock %}