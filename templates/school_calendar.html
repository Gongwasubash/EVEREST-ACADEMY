{% extends 'base.html' %}
{% load static %}

{% block title %}School Calendar - {{ school_info.school_name }}{% endblock %}

{% block extra_css %}
<style>
    .calendar-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 10px;
        background: white;
        min-height: 100vh;
    }
    
    .calendar-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        overflow: hidden;
    }
    
    .calendar-header {
        background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%);
        color: white;
        padding: 20px 15px;
        text-align: center;
    }
    
    .calendar-title {
        font-size: 20px;
        font-weight: 700;
        margin-bottom: 5px;
    }
    
    .school-name {
        font-size: 13px;
        opacity: 0.9;
    }
    
    .calendar-nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 15px;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
    }
    
    .nav-btn {
        background: #d32f2f;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        min-width: 60px;
    }
    
    .nav-btn:hover {
        background: #b71c1c;
    }
    
    .month-year {
        font-size: 18px;
        font-weight: 700;
        color: #2d3748;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: white;
        border: 1px solid #ddd;
        border-bottom: none;
    }
    
    .calendar-days-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: white;
        border: 1px solid #ddd;
        border-top: none;
    }
    
    .day-header {
        background: #424242;
        color: white;
        padding: 12px 4px;
        text-align: center;
        font-weight: 600;
        font-size: 12px;
        border: 1px solid #666;
        border-bottom: 2px solid #333;
    }
    
    .day-cell {
        border: 1px solid #ddd;
        min-height: 100px;
        padding: 6px;
        position: relative;
        background: white;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
    }
    
    .day-cell:hover {
        background: #f7fafc;
    }
    
    .day-number {
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 6px;
        font-size: 14px;
        line-height: 1;
        min-width: 20px;
        text-align: center;
    }
    
    .today {
        background: #ffebee !important;
        border: 2px solid #d32f2f;
    }
    
    .today .day-number {
        color: white;
        background: #d32f2f;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 11px;
        font-weight: 700;
    }
    
    .other-month {
        background: #f8f9fa;
        color: #a0aec0;
        opacity: 0.6;
    }
    
    .other-month .day-number {
        color: #a0aec0;
        font-weight: 400;
    }
    
    .school-day, .festival, .holiday, .exam, .meeting, .event, .other {
        color: white;
        padding: 2px 4px;
        border-radius: 3px;
        font-size: 9px;
        margin-bottom: 1px;
        display: block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
        cursor: pointer;
        border-left: 2px solid rgba(0,0,0,0.2);
    }
    
    .school-day { background: #2196F3; }
    .festival { background: #FF5722; }
    .holiday { background: #e53e3e; }
    .exam { background: #FF9800; }
    .meeting { background: #9C27B0; }
    .event { background: #4CAF50; }
    .other { background: #607D8B; }
    
    .date-info {
        background: #d32f2f;
        color: white;
        padding: 12px;
        text-align: center;
        font-size: 12px;
        font-weight: 500;
    }
    
    .filter-controls {
        padding: 8px;
        text-align: center;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
    }
    
    .filter-controls > div {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 6px;
    }
    
    .filter-controls label {
        font-size: 11px;
        display: flex;
        align-items: center;
        gap: 3px;
    }
    
    .filter-controls button {
        background: #d32f2f;
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 11px;
    }
    
    .legend {
        margin-top: 6px;
        font-size: 10px;
        color: #666;
        display: flex;
        justify-content: center;
        flex-wrap: wrap;
        gap: 6px;
    }
    
    .legend span {
        display: inline-block;
        margin: 0 3px;
    }
    
    .legend span span {
        padding: 1px 4px;
        border-radius: 2px;
        color: white;
        font-size: 9px;
    }
    
    /* Mobile Responsive Styles */
    @media (max-width: 768px) {
        .calendar-container {
            padding: 5px;
        }
        
        .calendar-header {
            padding: 15px 10px;
        }
        
        .calendar-title {
            font-size: 18px;
        }
        
        .school-name {
            font-size: 12px;
        }
        
        .calendar-nav {
            padding: 10px;
        }
        
        .nav-btn {
            padding: 6px 10px;
            font-size: 11px;
            min-width: 50px;
        }
        
        .month-year {
            font-size: 16px;
        }
        
        .day-header {
            padding: 8px 2px;
            font-size: 10px;
        }
        
        .day-cell {
            min-height: 80px;
            padding: 4px;
        }
        
        .day-number {
            font-size: 12px;
            margin-bottom: 4px;
        }
        
        .today .day-number {
            width: 20px;
            height: 20px;
            font-size: 10px;
        }
        
        .school-day, .festival, .holiday, .exam, .meeting, .event, .other {
            font-size: 8px;
            padding: 1px 3px;
        }
        
        .date-info {
            padding: 8px;
            font-size: 11px;
        }
        
        .filter-controls {
            padding: 6px;
        }
        
        .filter-controls > div {
            gap: 6px;
        }
        
        .filter-controls label {
            font-size: 10px;
        }
        
        .filter-controls button {
            padding: 3px 6px;
            font-size: 10px;
        }
        
        .legend {
            font-size: 9px;
            gap: 4px;
        }
        
        .legend span span {
            font-size: 8px;
            padding: 1px 3px;
        }
        
        /* Modal responsive */
        #addHolidayModal > div,
        #editHolidayModal > div,
        #dayManagementModal > div {
            width: 95% !important;
            max-width: 400px !important;
            padding: 20px !important;
        }
        
        #addHolidayModal h3,
        #editHolidayModal h3,
        #dayManagementModal h3 {
            font-size: 16px;
        }
        
        #addHolidayModal input,
        #addHolidayModal select,
        #addHolidayModal textarea,
        #editHolidayModal input,
        #editHolidayModal select,
        #editHolidayModal textarea {
            font-size: 14px !important;
        }
        
        #addHolidayModal button,
        #editHolidayModal button,
        #dayManagementModal button {
            padding: 8px 15px !important;
            font-size: 12px !important;
        }
    }
    
    @media (max-width: 480px) {
        .day-cell {
            min-height: 60px;
            padding: 2px;
        }
        
        .day-number {
            font-size: 11px;
        }
        
        .today .day-number {
            width: 18px;
            height: 18px;
            font-size: 9px;
        }
        
        .school-day, .festival, .holiday, .exam, .meeting, .event, .other {
            font-size: 7px;
            padding: 1px 2px;
        }
        
        .day-header {
            font-size: 9px;
            padding: 6px 1px;
        }
        
        .calendar-nav {
            flex-direction: column;
            gap: 8px;
        }
        
        .nav-btn {
            width: 80px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-card">
        <div class="calendar-header">
            <h1 class="calendar-title">हाम्रो पात्रो</h1>
            <p class="school-name">{{ school_info.school_name }}</p>
            <p style="font-size: 12px; opacity: 0.8; margin-top: 5px;">शैक्षिक वर्ष: बैशाख १ - चैत्र ३०</p>
        </div>
        
        <div class="calendar-nav">
            <button class="nav-btn" onclick="prevMonth()">&lt; अघिल्लो</button>
            <div class="month-year" id="monthYear">कार्तिक 2082</div>
            <button class="nav-btn" onclick="nextMonth()">अर्को &gt;</button>
        </div>
        <div class="filter-controls">
            <div>
                <label><input type="checkbox" id="showHolidays" checked onchange="refreshCalendar()"> Holidays</label>
                <label><input type="checkbox" id="showFestivals" checked onchange="refreshCalendar()"> Festivals</label>
                <label><input type="checkbox" id="showExams" checked onchange="refreshCalendar()"> Exams</label>
                <label><input type="checkbox" id="showEvents" checked onchange="refreshCalendar()"> School Events</label>
                <label><input type="checkbox" id="showMeetings" checked onchange="refreshCalendar()"> Meetings</label>
                <button onclick="showAddHolidayModal()">Add Event</button>
            </div>
            <div class="legend">
                <span><span style="background: #e53e3e;">Holiday</span></span>
                <span><span style="background: #FF5722;">Festival</span></span>
                <span><span style="background: #FF9800;">Exam</span></span>
                <span><span style="background: #4CAF50;">Event</span></span>
                <span><span style="background: #9C27B0;">Meeting</span></span>
                <span><span style="background: #2196F3;">School Day</span></span>
            </div>
        </div>
        
        <div class="calendar-grid">
            <div class="day-header">Sun</div>
            <div class="day-header">Mon</div>
            <div class="day-header">Tue</div>
            <div class="day-header">Wed</div>
            <div class="day-header">Thu</div>
            <div class="day-header">Fri</div>
            <div class="day-header">Sat</div>
        </div>
        <div class="calendar-days-grid" id="calendarDays"></div>
        
        <div class="date-info" id="dateInfo">
            आज: <span id="currentBSDate"></span> | शैक्षिक वर्ष: २०८२
        </div>
    </div>
</div>

<!-- Add Holiday Modal -->
<div id="addHolidayModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%;">
        <h3 style="margin-top: 0; color: #d32f2f;">Add Holiday</h3>
        <form id="addHolidayForm">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Holiday Title:</label>
                <input type="text" id="holidayTitle" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Date:</label>
                <input type="date" id="holidayDate" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Type:</label>
                <select id="holidayType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="holiday">Holiday (National/Public)</option>
                    <option value="festival">Festival (Religious/Cultural)</option>
                    <option value="exam">Exam (Tests/Examinations)</option>
                    <option value="event">School Event (Activities/Programs)</option>
                    <option value="school-day">School Day</option>
                    <option value="meeting">Meeting (Staff/Parent Meetings)</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">School:</label>
                <select id="holidaySchool" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">All Schools</option>
                    <!-- Schools will be loaded dynamically -->
                </select>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Description (Optional):</label>
                <textarea id="holidayDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            <div style="text-align: right;">
                <button type="button" onclick="hideAddHolidayModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Cancel</button>
                <button type="submit" style="background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Add Holiday</button>
            </div>
        </form>
    </div>
</div>

<!-- Day Management Modal -->
<div id="dayManagementModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 500px; max-width: 90%; max-height: 80vh; overflow-y: auto;">
        <h3 style="margin-top: 0; color: #d32f2f;" id="dayModalTitle">Events for Date</h3>
        <div id="dayEventsList" style="margin-bottom: 20px;"></div>
        <div style="text-align: right;">
            <button type="button" onclick="hideDayManagementModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Close</button>
            <button type="button" onclick="showAddEventForDay()" style="background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Add Event</button>
        </div>
    </div>
</div>

<!-- Edit Holiday Modal -->
<div id="editHolidayModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1001;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; width: 400px; max-width: 90%;">
        <h3 style="margin-top: 0; color: #d32f2f;">Edit Event</h3>
        <form id="editHolidayForm">
            <input type="hidden" id="editHolidayId">
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Event Title:</label>
                <input type="text" id="editHolidayTitle" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Date:</label>
                <input type="date" id="editHolidayDate" required style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Type:</label>
                <select id="editHolidayType" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="holiday">Holiday (National/Public)</option>
                    <option value="festival">Festival (Religious/Cultural)</option>
                    <option value="exam">Exam (Tests/Examinations)</option>
                    <option value="event">School Event (Activities/Programs)</option>
                    <option value="school-day">School Day</option>
                    <option value="meeting">Meeting (Staff/Parent Meetings)</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">School:</label>
                <select id="editHolidaySchool" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">All Schools</option>
                    <!-- Schools will be loaded dynamically -->
                </select>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Description (Optional):</label>
                <textarea id="editHolidayDescription" rows="3" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
            </div>
            <div style="text-align: right;">
                <button type="button" onclick="hideEditHolidayModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Cancel</button>
                <button type="button" onclick="deleteHoliday()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 5px; margin-right: 10px; cursor: pointer;">Delete</button>
                <button type="submit" style="background: #d32f2f; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">Update Event</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const nepaliMonths = ['बैशाख', 'जेठ', 'आषाढ', 'श्रावण', 'भाद्र', 'आश्विन', 'कार्तिक', 'मंसिर', 'पुष', 'माघ', 'फाल्गुन', 'चैत्र'];

// Get current BS date - more accurate conversion
const today = new Date();
const englishYear = today.getFullYear();
const englishMonth = today.getMonth() + 1;
const englishDay = today.getDate();

// Set current BS date: १९ असोज २०८२
let currentBSYear = 2082;
let currentBSMonth = 6; // असोज is 6th month (0-based = 5)
let currentBSDay = 19;

let currentNepaliYear = currentBSYear;
let currentNepaliMonth = 5; // असोज (0-based)
let currentNepaliDay = currentBSDay;
let apiEvents = {};

// Comprehensive Nepali festivals for all 12 months
const allEvents = {
    1: { // Baisakh
        1: {name: 'नेपाली नयाँ वर्ष', type: 'holiday'},
        8: {name: 'बुद्ध जयन्ती', type: 'holiday'},
        11: {name: 'लोकतन्त्र दिवस', type: 'holiday'},
        15: {name: 'बैशाख पूर्णिमा', type: 'festival'},
        30: {name: 'रोपाईं दिवस', type: 'festival'}
    },
    2: { // Jestha
        3: {name: 'अक्षय तृतीया', type: 'festival'},
        15: {name: 'जेठ पूर्णिमा', type: 'festival'},
        32: {name: 'गाई जात्रा', type: 'festival'}
    },
    3: { // Ashadh
        15: {name: 'गुरु पूर्णिमा', type: 'festival'},
        32: {name: 'नाग पञ्चमी', type: 'festival'}
    },
    4: { // Shrawan
        3: {name: 'हरितालिका तीज', type: 'festival'},
        15: {name: 'जनै पूर्णिमा', type: 'festival'},
        23: {name: 'कृष्ण जन्माष्टमी', type: 'festival'}
    },
    5: { // Bhadra
        3: {name: 'ऋषि पञ्चमी', type: 'festival'},
        15: {name: 'भाद्र पूर्णिमा', type: 'festival'},
        18: {name: 'गणेश चतुर्थी', type: 'festival'}
    },
    6: { // Ashwin
        15: {name: 'इन्द्रजात्रा', type: 'festival'},
        23: {name: 'घटस्थापना', type: 'festival'}
    },
    7: { // Kartik
        1: {name: 'घटस्थापना', type: 'festival'},
        7: {name: 'फुलपाती', type: 'festival'},
        8: {name: 'महाअष्टमी', type: 'festival'},
        9: {name: 'महानवमी', type: 'festival'},
        10: {name: 'विजया दशमी', type: 'holiday'},
        15: {name: 'कोजाग्रत पूर्णिमा', type: 'festival'},
        30: {name: 'दीपावली', type: 'festival'}
    },
    8: { // Mangsir
        1: {name: 'गोवर्धन पूजा', type: 'festival'},
        2: {name: 'गाई तिहार', type: 'festival'},
        3: {name: 'गोरु तिहार', type: 'festival'},
        4: {name: 'लक्ष्मी पूजा', type: 'holiday'},
        5: {name: 'गोभर्धन पूजा', type: 'festival'},
        6: {name: 'भाई टीका', type: 'holiday'},
        15: {name: 'योमरी पुन्ही', type: 'festival'},
        30: {name: 'उधौली पर्व', type: 'festival'}
    },
    9: { // Poush
        1: {name: 'माघे संक्रान्ति', type: 'festival'},
        15: {name: 'पौष पूर्णिमा', type: 'festival'}
    },
    10: { // Magh
        15: {name: 'सरस्वती पूजा', type: 'festival'},
        29: {name: 'प्रजातन्त्र दिवस', type: 'holiday'}
    },
    11: { // Falgun
        11: {name: 'महाशिवरात्री', type: 'holiday'},
        30: {name: 'होली/फागु पूर्णिमा', type: 'holiday'}
    },
    12: { // Chaitra
        1: {name: 'चैत दशैं', type: 'festival'},
        8: {name: 'घोडेजात्रा', type: 'festival'},
        9: {name: 'राम नवमी', type: 'festival'},
        15: {name: 'चैत्र पूर्णिमा', type: 'festival'}
    }
};

function toggleCalendarMode() {
    const isNepaliMode = document.getElementById('nepaliCalendar')?.checked;
    const dayHeaders = document.querySelectorAll('.day-header');
    
    if (isNepaliMode) {
        // Update headers to Nepali
        const nepaliDays = ['आइत', 'सोम', 'मंगल', 'बुध', 'बिहि', 'शुक्र', 'शनि'];
        dayHeaders.forEach((header, index) => {
            header.textContent = nepaliDays[index];
        });
        updateNepaliCalendar();
    } else {
        // Update headers to English
        const englishDays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        dayHeaders.forEach((header, index) => {
            header.textContent = englishDays[index];
        });
        showEnglishCalendar();
    }
    updateNavigationButtons();
}

function refreshCalendar() {
    const isNepaliMode = document.getElementById('nepaliCalendar')?.checked;
    if (isNepaliMode) {
        updateNepaliCalendar();
    } else {
        showEnglishCalendar();
    }
}

async function showEnglishCalendar() {
    const englishMonths = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    const today = new Date();
    
    document.getElementById('monthYear').textContent = englishMonths[currentEnglishMonth] + ' ' + currentEnglishYear;
    
    const daysContainer = document.getElementById('calendarDays');
    daysContainer.innerHTML = '';
    
    // Load custom holidays from database
    await loadCustomHolidays(currentEnglishYear, currentEnglishMonth + 1);
    
    let nepaliEvents = {};
    
    // Get first day of month and days in month
    const firstDay = new Date(currentEnglishYear, currentEnglishMonth, 1).getDay();
    const daysInMonth = new Date(currentEnglishYear, currentEnglishMonth + 1, 0).getDate();
    
    // Add empty cells for days before first day
    for (let i = 0; i < firstDay; i++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'day-cell other-month';
        dayCell.innerHTML = `<div class="day-number"></div>`;
        dayCell.addEventListener('click', function() {
            const prevMonth = currentEnglishMonth === 0 ? 12 : currentEnglishMonth;
            const prevYear = currentEnglishMonth === 0 ? currentEnglishYear - 1 : currentEnglishYear;
            const prevMonthDays = new Date(prevYear, prevMonth, 0).getDate();
            const day = prevMonthDays - firstDay + i + 1;
            const clickedDate = `${prevYear}-${String(prevMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            showDayManagementModal(clickedDate, day);
        });
        daysContainer.appendChild(dayCell);
    }
    
    // Add days of current month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'day-cell';
        if (day === today.getDate() && currentEnglishMonth === today.getMonth() && currentEnglishYear === today.getFullYear()) {
            dayCell.classList.add('today');
        }
        
        let dayContent = `<div class="day-number">${day}</div>`;
        
        // Add converted Nepali BS date
        const nepaliConverted = convertEnglishToNepali(currentEnglishYear, currentEnglishMonth + 1, day);
        const nepaliMonthName = nepaliMonths[nepaliConverted.month - 1];
        dayContent += `<div style="font-size: 12px; color: #666; margin-top: 2px; font-weight: 500;">${nepaliConverted.day} ${nepaliMonthName}</div>`;
        
        // Add Nepali festivals and holidays
        const showFestivals = document.getElementById('showFestivals')?.checked !== false;
        const showHolidays = document.getElementById('showHolidays')?.checked !== false;
        
        if (nepaliEvents[day]) {
            const event = nepaliEvents[day];
            if ((event.type === 'holiday' && showHolidays) || (event.type === 'festival' && showFestivals)) {
                const eventClass = event.type === 'holiday' ? 'holiday' : 'festival';
                dayContent += `<div class="${eventClass}">${event.title}</div>`;
            }
        }
        
        // Add custom holidays for English calendar with filtering
        const englishMonthKey = `${currentEnglishYear}-${currentEnglishMonth + 1}`;
        if (customHolidays[englishMonthKey]) {
            const customDayEvents = customHolidays[englishMonthKey].filter(e => e.day === day);
            customDayEvents.forEach(event => {
                // Check filter settings
                const showHolidays = document.getElementById('showHolidays')?.checked !== false;
                const showFestivals = document.getElementById('showFestivals')?.checked !== false;
                const showExams = document.getElementById('showExams')?.checked !== false;
                const showEvents = document.getElementById('showEvents')?.checked !== false;
                const showMeetings = document.getElementById('showMeetings')?.checked !== false;
                
                let shouldShow = false;
                let eventClass = 'other';
                
                switch(event.type) {
                    case 'holiday':
                        shouldShow = showHolidays;
                        eventClass = 'holiday';
                        break;
                    case 'festival':
                        shouldShow = showFestivals;
                        eventClass = 'festival';
                        break;
                    case 'exam':
                        shouldShow = showExams;
                        eventClass = 'exam';
                        break;
                    case 'event':
                        shouldShow = showEvents;
                        eventClass = 'event';
                        break;
                    case 'school-day':
                        shouldShow = showEvents;
                        eventClass = 'school-day';
                        break;
                    case 'meeting':
                        shouldShow = showMeetings;
                        eventClass = 'meeting';
                        break;
                    default:
                        shouldShow = true;
                        eventClass = 'other';
                }
                
                if (shouldShow) {
                    const displayTitle = event.type === 'school-day' ? 'School Day' : event.title;
                    dayContent += `<div class="${eventClass}" onclick="showEditHolidayModal(${event.id}, '${event.title}', '${event.date}', '${event.type}', '${event.description || ''}')" title="${event.description || event.title}">${displayTitle}</div>`;
                }
            });
        }
        
        dayCell.innerHTML = dayContent;
        dayCell.addEventListener('click', function() {
            const clickedDate = `${currentEnglishYear}-${String(currentEnglishMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            showDayManagementModal(clickedDate, day);
        });
        daysContainer.appendChild(dayCell);
    }
    
    // Fill remaining cells
    const totalCells = daysContainer.children.length;
    for (let day = 1; day <= (42 - totalCells); day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'day-cell other-month';
        dayCell.innerHTML = `<div class="day-number">${day}</div>`;
        dayCell.addEventListener('click', function() {
            const nextMonth = currentEnglishMonth === 11 ? 1 : currentEnglishMonth + 2;
            const nextYear = currentEnglishMonth === 11 ? currentEnglishYear + 1 : currentEnglishYear;
            const clickedDate = `${nextYear}-${String(nextMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            showDayManagementModal(clickedDate, day);
        });
        daysContainer.appendChild(dayCell);
    }
}

async function updateNepaliCalendar() {
    document.getElementById('monthYear').textContent = nepaliMonths[currentNepaliMonth] + ' ' + currentNepaliYear;
    const daysContainer = document.getElementById('calendarDays');
    daysContainer.innerHTML = '';
    
    // Load events for current Nepali month
    await loadNepaliEvents(currentNepaliYear, currentNepaliMonth + 1);
    
    // Calculate starting day (0=Sunday, 1=Monday, etc.)
    const startDay = 0; // Start from Sunday for simplicity
    
    // Days in each Nepali month for 2082
    const daysInNepaliMonths = {
        1: 31, 2: 31, 3: 31, 4: 32, 5: 31, 6: 30,
        7: 29, 8: 30, 9: 29, 10: 30, 11: 29, 12: 30
    };
    const daysInMonth = daysInNepaliMonths[currentNepaliMonth + 1] || 30;
    
    // Add empty cells for days before first day
    for (let i = 0; i < startDay; i++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'day-cell other-month';
        const prevMonth = currentNepaliMonth === 0 ? 11 : currentNepaliMonth - 1;
        const prevYear = currentNepaliMonth === 0 ? currentNepaliYear - 1 : currentNepaliYear;
        const day = 30 - startDay + i + 1;
        dayCell.innerHTML = `<div class="day-number">${day}</div>`;
        dayCell.addEventListener('click', function() {
            const nepaliDate = convertNepaliToEnglish(prevYear, prevMonth + 1, day);
            showDayManagementModal(nepaliDate, day);
        });
        daysContainer.appendChild(dayCell);
    }
    
    // Add days of the month
    for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'day-cell';
        
        // Highlight today
        const today = new Date();
        const nepaliToday = convertEnglishToNepali(today.getFullYear(), today.getMonth() + 1, today.getDate());
        if (day === nepaliToday.day && currentNepaliMonth === nepaliToday.month - 1 && currentNepaliYear === nepaliToday.year) {
            dayCell.classList.add('today');
        }
        
        let dayContent = `<div class="day-number">${day}</div>`;
        
        // Add traditional Nepali festivals for Ashoj
        if (currentNepaliMonth === 5) { // Ashoj
            const ashojEvents = {
                1: {name: 'घटस्थापना', type: 'festival'},
                7: {name: 'फुलपाती', type: 'festival'},
                8: {name: 'महाअष्टमी', type: 'festival'},
                9: {name: 'महानवमी', type: 'festival'},
                10: {name: 'विजया दशमी', type: 'holiday'},
                15: {name: 'कोजाग्रत पूर्णिमा', type: 'festival'}
            };
            
            if (ashojEvents[day]) {
                const event = ashojEvents[day];
                const showFestivals = document.getElementById('showFestivals')?.checked !== false;
                const showHolidays = document.getElementById('showHolidays')?.checked !== false;
                
                if ((event.type === 'holiday' && showHolidays) || (event.type === 'festival' && showFestivals)) {
                    const eventClass = event.type === 'holiday' ? 'holiday' : 'festival';
                    dayContent += `<div class="${eventClass}">${event.name}</div>`;
                }
            }
        }
        
        // Add events from database
        const monthKey = `${currentNepaliYear}-${currentNepaliMonth + 1}`;
        if (nepaliEvents[monthKey]) {
            const dayEvents = nepaliEvents[monthKey].filter(e => e.nepali_day === day);
            dayEvents.forEach(event => {
                const showHolidays = document.getElementById('showHolidays')?.checked !== false;
                const showFestivals = document.getElementById('showFestivals')?.checked !== false;
                const showExams = document.getElementById('showExams')?.checked !== false;
                const showEvents = document.getElementById('showEvents')?.checked !== false;
                const showMeetings = document.getElementById('showMeetings')?.checked !== false;
                
                let shouldShow = false;
                let eventClass = 'other';
                
                switch(event.type) {
                    case 'holiday': shouldShow = showHolidays; eventClass = 'holiday'; break;
                    case 'festival': shouldShow = showFestivals; eventClass = 'festival'; break;
                    case 'exam': shouldShow = showExams; eventClass = 'exam'; break;
                    case 'event': shouldShow = showEvents; eventClass = 'event'; break;
                    case 'meeting': shouldShow = showMeetings; eventClass = 'meeting'; break;
                    default: shouldShow = true; eventClass = 'other';
                }
                
                if (shouldShow) {
                    const displayTitle = event.type === 'school-day' ? 'School Day' : event.title;
                    dayContent += `<div class="${eventClass}">${displayTitle}</div>`;
                }
            });
        }
        
        dayCell.innerHTML = dayContent;
        dayCell.addEventListener('click', function() {
            const nepaliDate = convertNepaliToEnglish(currentNepaliYear, currentNepaliMonth + 1, day);
            showDayManagementModal(nepaliDate, day);
        });
        daysContainer.appendChild(dayCell);
    }
    
    // Fill remaining cells
    const totalCells = daysContainer.children.length;
    const remainingCells = 42 - totalCells;
    for (let day = 1; day <= remainingCells; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'day-cell other-month';
        dayCell.innerHTML = `<div class="day-number">${day}</div>`;
        const nextMonth = currentNepaliMonth === 11 ? 0 : currentNepaliMonth + 1;
        const nextYear = currentNepaliMonth === 11 ? currentNepaliYear + 1 : currentNepaliYear;
        dayCell.addEventListener('click', function() {
            const nepaliDate = convertNepaliToEnglish(nextYear, nextMonth + 1, day);
            showDayManagementModal(nepaliDate, day);
        });
        daysContainer.appendChild(dayCell);
    }
}

function prevMonth() {
    currentNepaliMonth--;
    if (currentNepaliMonth < 0) {
        currentNepaliMonth = 11;
        currentNepaliYear--;
    }
    updateCalendar();
}

async function loadApiEvents(year, month) {
    try {
        const response = await fetch(`https://npclapi.casualsnek.eu.org/events/${year}/${month}`);
        if (response.ok) {
            const data = await response.json();
            if (data && Array.isArray(data)) {
                const monthKey = `${year}-${month}`;
                apiEvents[monthKey] = data.map(item => ({
                    date: parseInt(item.date),
                    title: item.name_np || item.name,
                    holiday: item.type === 'holiday' || item.is_public_holiday
                }));
                console.log(`Loaded ${data.length} events from npEventsAPI`);
            }
        }
    } catch (error) {
        console.log('npEventsAPI error, using fallback data');
    }
}

async function prevMonth() {
    const isNepaliMode = document.getElementById('nepaliCalendar')?.checked;
    if (isNepaliMode) {
        await prevNepaliMonth();
    } else {
        await prevEnglishMonth();
    }
}

async function nextMonth() {
    const isNepaliMode = document.getElementById('nepaliCalendar')?.checked;
    if (isNepaliMode) {
        await nextNepaliMonth();
    } else {
        await nextEnglishMonth();
    }
}

async function prevNepaliMonth() {
    currentNepaliMonth--;
    if (currentNepaliMonth < 0) {
        currentNepaliMonth = 11;
        currentNepaliYear--;
    }
    await loadCustomHolidays(currentNepaliYear, currentNepaliMonth + 1);
    updateNepaliCalendar();
}

async function nextNepaliMonth() {
    currentNepaliMonth++;
    if (currentNepaliMonth > 11) {
        currentNepaliMonth = 0;
        currentNepaliYear++;
    }
    await loadCustomHolidays(currentNepaliYear, currentNepaliMonth + 1);
    updateNepaliCalendar();
}

function updateCurrentDate() {
    const today = new Date();
    const nepaliToday = convertEnglishToNepali(today.getFullYear(), today.getMonth() + 1, today.getDate());
    const monthName = nepaliMonths[nepaliToday.month - 1];
    document.getElementById('currentBSDate').textContent = `आज: ${nepaliToday.year} ${monthName} ${nepaliToday.day} गते`;
}

// English calendar navigation
let currentEnglishYear = new Date().getFullYear();
let currentEnglishMonth = new Date().getMonth();

async function prevEnglishMonth() {
    currentEnglishMonth--;
    if (currentEnglishMonth < 0) {
        currentEnglishMonth = 11;
        currentEnglishYear--;
    }
    await loadCustomHolidays(currentEnglishYear, currentEnglishMonth + 1);
    await showEnglishCalendar();
}

async function nextEnglishMonth() {
    currentEnglishMonth++;
    if (currentEnglishMonth > 11) {
        currentEnglishMonth = 0;
        currentEnglishYear++;
    }
    await loadCustomHolidays(currentEnglishYear, currentEnglishMonth + 1);
    await showEnglishCalendar();
}

// Update navigation buttons based on calendar mode
function updateNavigationButtons() {
    const isNepaliMode = document.getElementById('nepaliCalendar')?.checked;
    const prevBtn = document.querySelector('.nav-btn');
    const nextBtn = document.querySelectorAll('.nav-btn')[1];
    
    if (isNepaliMode) {
        prevBtn.onclick = prevMonth;
        nextBtn.onclick = nextMonth;
    } else {
        prevBtn.onclick = prevEnglishMonth;
        nextBtn.onclick = nextEnglishMonth;
    }
}

document.addEventListener('DOMContentLoaded', async function() {
    await loadSchools();
    
    // Set current dates
    const today = new Date();
    currentEnglishYear = today.getFullYear();
    currentEnglishMonth = today.getMonth();
    
    const nepaliToday = convertEnglishToNepali(today.getFullYear(), today.getMonth() + 1, today.getDate());
    currentNepaliYear = nepaliToday.year;
    currentNepaliMonth = nepaliToday.month - 1;
    
    // Load current month data
    await loadCustomHolidays(currentEnglishYear, currentEnglishMonth + 1);
    await loadNepaliEvents(currentNepaliYear, currentNepaliMonth + 1);
    
    // Show English calendar by default
    await showEnglishCalendar();
    updateCurrentDate();
    
    console.log('Calendar loaded successfully');
});

// Load schools for dropdown
async function loadSchools() {
    try {
        const response = await fetch('/api/schools/');
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                const addSchoolSelect = document.getElementById('holidaySchool');
                const editSchoolSelect = document.getElementById('editHolidaySchool');
                
                data.schools.forEach(school => {
                    const option1 = document.createElement('option');
                    option1.value = school.id;
                    option1.textContent = school.school_name;
                    addSchoolSelect.appendChild(option1);
                    
                    const option2 = document.createElement('option');
                    option2.value = school.id;
                    option2.textContent = school.school_name;
                    editSchoolSelect.appendChild(option2);
                });
            }
        }
    } catch (error) {
        console.log('Error loading schools:', error);
    }
}

// Holiday Management Functions
let customHolidays = {};

function showAddHolidayModal(selectedDate) {
    document.getElementById('addHolidayModal').style.display = 'block';
    // Set selected date or today's date as default
    const dateToSet = selectedDate || new Date().toISOString().split('T')[0];
    document.getElementById('holidayDate').value = dateToSet;
}

function hideAddHolidayModal() {
    document.getElementById('addHolidayModal').style.display = 'none';
    document.getElementById('addHolidayForm').reset();
}

function showEditHolidayModal(holidayId, title, date, type, description, schoolId) {
    document.getElementById('editHolidayModal').style.display = 'block';
    document.getElementById('editHolidayId').value = holidayId;
    document.getElementById('editHolidayTitle').value = title;
    document.getElementById('editHolidayDate').value = date;
    document.getElementById('editHolidayType').value = type;
    document.getElementById('editHolidaySchool').value = schoolId || '';
    document.getElementById('editHolidayDescription').value = description || '';
}

function hideEditHolidayModal() {
    document.getElementById('editHolidayModal').style.display = 'none';
    document.getElementById('editHolidayForm').reset();
}

// Add Holiday Form Submit
document.getElementById('addHolidayForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        title: document.getElementById('holidayTitle').value,
        event_date: document.getElementById('holidayDate').value,
        event_type: document.getElementById('holidayType').value,
        school_id: document.getElementById('holidaySchool').value || null,
        description: document.getElementById('holidayDescription').value
    };
    
    try {
        const response = await fetch('/api/add-holiday/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Event added successfully!');
            hideAddHolidayModal();
            // Refresh calendar
            await loadCustomHolidays(currentEnglishYear, currentEnglishMonth + 1);
            await showEnglishCalendar();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error adding holiday: ' + error.message);
    }
});

// Edit Holiday Form Submit
document.getElementById('editHolidayForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        holiday_id: document.getElementById('editHolidayId').value,
        title: document.getElementById('editHolidayTitle').value,
        event_date: document.getElementById('editHolidayDate').value,
        event_type: document.getElementById('editHolidayType').value,
        school_id: document.getElementById('editHolidaySchool').value || null,
        description: document.getElementById('editHolidayDescription').value
    };
    
    try {
        const response = await fetch('/api/edit-holiday/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Event updated successfully!');
            hideEditHolidayModal();
            // Refresh calendar
            await loadCustomHolidays(currentEnglishYear, currentEnglishMonth + 1);
            await showEnglishCalendar();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error updating holiday: ' + error.message);
    }
});

// Delete Holiday Function
async function deleteHoliday() {
    if (!confirm('Are you sure you want to delete this holiday?')) {
        return;
    }
    
    const holidayId = document.getElementById('editHolidayId').value;
    
    try {
        const response = await fetch('/api/delete-holiday/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ holiday_id: holidayId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Event deleted successfully!');
            hideEditHolidayModal();
            // Refresh calendar
            await loadCustomHolidays(currentEnglishYear, currentEnglishMonth + 1);
            await showEnglishCalendar();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error deleting holiday: ' + error.message);
    }
}

// Load Custom Holidays from Database
async function loadCustomHolidays(year, month) {
    try {
        const response = await fetch(`/get-calendar-data/?year=${year}&month=${month}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                const monthKey = `${year}-${month}`;
                customHolidays[monthKey] = data.events;
                console.log(`Loaded ${data.events.length} events for ${year}-${month}`);
            }
        }
    } catch (error) {
        console.log('Error loading custom holidays:', error);
    }
}

// Load events converted to Nepali dates
let nepaliEvents = {};

async function loadNepaliEvents(nepaliYear, nepaliMonth) {
    try {
        const response = await fetch(`/api/nepali-calendar-events/?year=${nepaliYear}&month=${nepaliMonth}`);
        if (response.ok) {
            const data = await response.json();
            if (data.success) {
                const monthKey = `${nepaliYear}-${nepaliMonth}`;
                nepaliEvents[monthKey] = data.events;
                console.log(`Loaded ${data.events.length} events for Nepali calendar`);
            }
        } else {
            // Fallback: convert English events to Nepali
            await convertEnglishEventsToNepali(nepaliYear, nepaliMonth);
        }
    } catch (error) {
        console.log('Error loading Nepali events, using fallback conversion:', error);
        await convertEnglishEventsToNepali(nepaliYear, nepaliMonth);
    }
}

async function convertEnglishEventsToNepali(nepaliYear, nepaliMonth) {
    // Convert English calendar events to Nepali dates
    const englishYear = nepaliYear - 56; // Approximate conversion
    const englishMonth = nepaliMonth - 8; // Approximate conversion
    
    let adjYear = englishYear;
    let adjMonth = englishMonth;
    
    if (adjMonth <= 0) {
        adjMonth += 12;
        adjYear -= 1;
    }
    
    // Load English events and convert
    await loadCustomHolidays(adjYear, adjMonth);
    
    const monthKey = `${adjYear}-${adjMonth}`;
    const nepaliMonthKey = `${nepaliYear}-${nepaliMonth}`;
    
    if (customHolidays[monthKey]) {
        nepaliEvents[nepaliMonthKey] = customHolidays[monthKey].map(event => {
            // Simple conversion: add 15 days to get approximate Nepali date
            const nepaliDay = event.day + 15;
            return {
                ...event,
                nepali_day: nepaliDay > 30 ? nepaliDay - 30 : nepaliDay,
                original_english_date: event.date
            };
        });
    }
}

function convertEnglishToNepali(englishYear, englishMonth, englishDay) {
    // Fixed conversion: Today (Oct 6, 2024) = 19 Ashoj 2082
    const referenceEnglish = new Date(2024, 9, 6); // Oct 6, 2024
    const referenceNepali = { year: 2082, month: 6, day: 19 }; // 19 Ashoj 2082
    
    const inputDate = new Date(englishYear, englishMonth - 1, englishDay);
    const daysDiff = Math.floor((inputDate - referenceEnglish) / (1000 * 60 * 60 * 24));
    
    let nepaliYear = referenceNepali.year;
    let nepaliMonth = referenceNepali.month;
    let nepaliDay = referenceNepali.day + daysDiff;
    
    // Days in each Nepali month for 2082
    const daysInNepaliMonths = [31, 31, 31, 32, 31, 30, 29, 30, 29, 30, 29, 30];
    
    // Adjust for day overflow/underflow
    while (nepaliDay > daysInNepaliMonths[nepaliMonth - 1]) {
        nepaliDay -= daysInNepaliMonths[nepaliMonth - 1];
        nepaliMonth++;
        if (nepaliMonth > 12) {
            nepaliMonth = 1;
            nepaliYear++;
        }
    }
    
    while (nepaliDay < 1) {
        nepaliMonth--;
        if (nepaliMonth < 1) {
            nepaliMonth = 12;
            nepaliYear--;
        }
        nepaliDay += daysInNepaliMonths[nepaliMonth - 1];
    }
    
    return { year: nepaliYear, month: nepaliMonth, day: nepaliDay };
}

function convertNepaliToEnglish(nepaliYear, nepaliMonth, nepaliDay) {
    // Fixed conversion: 19 Ashoj 2082 = Oct 6, 2024
    const referenceNepali = { year: 2082, month: 6, day: 19 }; // 19 Ashoj 2082
    const referenceEnglish = new Date(2024, 9, 6); // Oct 6, 2024
    
    // Calculate days difference from reference
    const daysInNepaliMonths = [31, 31, 31, 32, 31, 30, 29, 30, 29, 30, 29, 30];
    
    let totalDays = 0;
    let currentYear = referenceNepali.year;
    let currentMonth = referenceNepali.month;
    let currentDay = referenceNepali.day;
    
    // Calculate difference in days
    if (nepaliYear > currentYear || (nepaliYear === currentYear && nepaliMonth > currentMonth) || 
        (nepaliYear === currentYear && nepaliMonth === currentMonth && nepaliDay > currentDay)) {
        // Future date
        while (currentYear < nepaliYear || currentMonth < nepaliMonth || currentDay < nepaliDay) {
            if (currentDay < daysInNepaliMonths[currentMonth - 1]) {
                currentDay++;
                totalDays++;
            } else {
                currentDay = 1;
                currentMonth++;
                totalDays++;
                if (currentMonth > 12) {
                    currentMonth = 1;
                    currentYear++;
                }
            }
        }
    } else {
        // Past date
        while (currentYear > nepaliYear || currentMonth > nepaliMonth || currentDay > nepaliDay) {
            if (currentDay > 1) {
                currentDay--;
                totalDays--;
            } else {
                currentMonth--;
                if (currentMonth < 1) {
                    currentMonth = 12;
                    currentYear--;
                }
                currentDay = daysInNepaliMonths[currentMonth - 1];
                totalDays--;
            }
        }
    }
    
    const resultDate = new Date(referenceEnglish.getTime() + (totalDays * 24 * 60 * 60 * 1000));
    return resultDate.toISOString().split('T')[0];
}

// Get CSRF token function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Day Management Modal Functions
let selectedDate = '';

function showDayManagementModal(dateStr, dayNum) {
    selectedDate = dateStr;
    const date = new Date(dateStr);
    document.getElementById('dayModalTitle').textContent = `Events for ${date.toLocaleDateString()}`;
    
    // Get events for this exact date
    const dayEvents = getDayEvents(dateStr);
    const eventsList = document.getElementById('dayEventsList');
    
    if (dayEvents.length === 0) {
        eventsList.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No events for this day</p>';
    } else {
        eventsList.innerHTML = dayEvents.map(event => `
            <div style="border: 1px solid #ddd; border-radius: 5px; padding: 15px; margin-bottom: 10px; background: #f9f9f9;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h4 style="margin: 0 0 5px 0; color: #d32f2f;">${event.title}</h4>
                        <p style="margin: 0; color: #666; font-size: 12px;">Type: ${event.type}</p>
                        ${event.description ? `<p style="margin: 5px 0 0 0; font-size: 13px;">${event.description}</p>` : ''}
                    </div>
                    <div>
                        ${event.id ? `<button onclick="editEventFromDay(${event.id}, '${event.title}', '${event.date}', '${event.type}', '${event.description || ''}')" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 3px; margin-right: 5px; cursor: pointer; font-size: 12px;">Edit</button>` : ''}
                        ${event.id ? `<button onclick="deleteEventFromDay(${event.id})" style="background: #dc3545; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-size: 12px;">Delete</button>` : '<span style="font-size: 11px; color: #999;">System Event</span>'}
                    </div>
                </div>
            </div>
        `).join('');
    }
    
    document.getElementById('dayManagementModal').style.display = 'block';
}

function hideDayManagementModal() {
    document.getElementById('dayManagementModal').style.display = 'none';
}

function showAddEventForDay() {
    hideDayManagementModal();
    showAddHolidayModal(selectedDate);
}

function getDayEvents(dateStr) {
    const events = [];
    const date = new Date(dateStr);
    const year = date.getFullYear();
    const month = date.getMonth() + 1;
    const day = date.getDate();
    
    // Get custom holidays from database - match exact date
    const monthKey = `${year}-${month}`;
    if (customHolidays[monthKey]) {
        const dayEvents = customHolidays[monthKey].filter(e => {
            return e.date === dateStr;
        });
        events.push(...dayEvents.map(e => ({
            id: e.id,
            title: e.title,
            type: e.type,
            description: e.description || '',
            date: e.date
        })));
    }
    
    // Convert to Nepali date and check for system events
    const nepaliDate = convertEnglishToNepali(year, month, day);
    if (allEvents[nepaliDate.month] && allEvents[nepaliDate.month][nepaliDate.day]) {
        const event = allEvents[nepaliDate.month][nepaliDate.day];
        events.push({
            title: event.name,
            type: event.type,
            description: 'Traditional Nepali Festival/Holiday',
            date: dateStr
        });
    }
    
    return events;
}

function editEventFromDay(id, title, date, type, description) {
    hideDayManagementModal();
    showEditHolidayModal(id, title, date, type, description);
}

async function deleteEventFromDay(id) {
    if (!confirm('Are you sure you want to delete this event?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/delete-holiday/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ holiday_id: id })
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('Event deleted successfully!');
            hideDayManagementModal();
            // Refresh calendar
            await loadCustomHolidays(currentEnglishYear, currentEnglishMonth + 1);
            await showEnglishCalendar();
        } else {
            alert('Error: ' + result.error);
        }
    } catch (error) {
        alert('Error deleting event: ' + error.message);
    }
}

// Close modals when clicking outside
window.addEventListener('click', function(event) {
    const addModal = document.getElementById('addHolidayModal');
    const editModal = document.getElementById('editHolidayModal');
    const dayModal = document.getElementById('dayManagementModal');
    
    if (event.target === addModal) {
        hideAddHolidayModal();
    }
    if (event.target === editModal) {
        hideEditHolidayModal();
    }
    if (event.target === dayModal) {
        hideDayManagementModal();
    }
});
</script>
{% endblock %}