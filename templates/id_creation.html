{% extends "base.html" %}

{% block title %}ID Creation - School Management{% endblock %}

{% block content %}
<div class="id-creation-container">
    <div class="page-header">
        <h1>Student ID Card Creation</h1>
        <p>Generate and print student ID cards</p>
    </div>

    <div class="id-creation-content">
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="studentSearch" placeholder="Search students by name, class, or roll number...">
                <select id="classFilter" onchange="filterByClass()">
                    <option value="">All Classes</option>
                    {% for class in classes %}
                    <option value="{{ class }}">{{ class }}</option>
                    {% endfor %}
                </select>
                <button type="button" onclick="searchStudents()">Search</button>
            </div>
        </div>

        <div class="bulk-actions" style="display: flex; flex-wrap: wrap; gap: 10px; align-items: center; justify-content: flex-start;">
            <button type="button" class="btn-bulk" onclick="selectAll()">Select All</button>
            <button type="button" class="btn-bulk" onclick="clearSelection()">Clear Selection</button>
            <button type="button" class="btn-bulk-print" onclick="bulkPrintIDs()">Print Selected IDs</button>
            <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
                <label for="validTillInput" style="font-weight: 600; white-space: nowrap;">Valid Till:</label>
                <input type="text" id="validTillInput" placeholder="2082/12/30" value="2082/12/30" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; min-width: 100px; max-width: 120px;">
                <button type="button" class="btn-bulk" onclick="saveValidTill()">Save</button>
            </div>
        </div>

        <div class="students-table-container" id="studentsTableContainer">
            <table class="students-table" id="studentsTable">
                <thead>
                    <tr>
                        <th style="width: 50px;"><input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()"></th>
                        <th style="width: 60px;">S.N.</th>
                        <th style="width: 80px;">Photo</th>
                        <th style="width: 200px;">Student Name</th>
                        <th style="width: 80px;">Class</th>
                        <th style="width: 80px;">Section</th>
                        <th style="width: 120px;">Roll Number</th>
                        <th style="width: 180px;">Father Name</th>
                        <th style="width: 120px;">Mobile</th>
                        <th style="width: 150px;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for student in students %}
                    <tr class="student-row" data-student-id="{{ student.id }}">
                        <td><input type="checkbox" class="student-checkbox" value="{{ student.id }}"></td>
                        <td>{{ forloop.counter }}</td>
                        <td class="student-photo-cell">
                            <div class="photo-placeholder">
                                {% if student.photo %}
                                    <img src="{{ student.photo.url }}" alt="{{ student.name }}">
                                {% else %}
                                    <div style="color: #999; font-size: 10px;">No Photo</div>
                                {% endif %}
                            </div>
                        </td>
                        <td class="student-name">{{ student.name }}</td>
                        <td class="student-class">{{ student.student_class }}</td>
                        <td class="student-section">{{ student.section }}</td>
                        <td class="student-roll">{{ student.reg_number }}</td>
                        <td class="father-name">{{ student.father_name|default:"N/A" }}</td>
                        <td class="mobile">{{ student.mobile|default:"N/A" }}</td>
                        <td class="actions-cell">
                            <button type="button" class="btn-preview" onclick="previewID({{ student.id }})">Preview</button>
                            <button type="button" class="btn-print" onclick="printID({{ student.id }})">Print</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ID Preview Modal -->
<div id="idPreviewModal" class="modal" style="display: none;">
    <div class="modal-content id-preview-content">
        <div class="modal-header">
            <h2>ID Card Preview</h2>
            <span class="close" onclick="closePreview()">&times;</span>
        </div>
        <div class="modal-body">
            <div id="idCardPreview" class="id-card">
                <!-- ID card content will be loaded here -->
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-print" onclick="printCurrentID()">Print This ID</button>
            <button type="button" class="btn-secondary" onclick="closePreview()">Close</button>
        </div>
    </div>
</div>

<style>
.id-creation-container {
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
}

.page-header {
    text-align: center;
    margin-bottom: 30px;
}

.page-header h1 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.search-section {
    margin-bottom: 30px;
}

.search-box {
    display: flex;
    gap: 10px;
    max-width: 500px;
    margin: 0 auto;
}

.search-box input {
    flex: 1;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
}

.search-box select {
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 5px;
    font-size: 16px;
    background: white;
}

.search-box button {
    padding: 12px 20px;
    background: #3498db;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.students-table-container {
    margin-bottom: 30px;
    overflow-x: auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.students-table {
    width: 100%;
    border-collapse: collapse;
    min-width: 1200px;
    font-size: 14px;
}

.students-table th,
.students-table td {
    padding: 12px 15px;
    text-align: left;
    border-bottom: 1px solid #ddd;
}

.students-table th {
    background: #f8f9fa;
    font-weight: 600;
    color: #2c3e50;
    position: sticky;
    top: 0;
    z-index: 10;
}

.students-table tbody tr:hover {
    background: #f8f9fa;
}

.students-table tbody tr.selected {
    background: #e3f2fd;
}

.student-name {
    font-weight: 500;
    color: #2c3e50;
}

.actions-cell {
    white-space: nowrap;
}

.student-photo-cell {
    text-align: center;
    padding: 8px;
}

.photo-placeholder {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    overflow: hidden;
    margin: 0 auto;
    border: 2px solid #ddd;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
}

.photo-placeholder img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.actions-cell .btn-generate,
.actions-cell .btn-preview,
.actions-cell .btn-print {
    margin-right: 5px;
    padding: 6px 12px;
    font-size: 12px;
}

.father-name, .mobile {
    color: #666;
    font-size: 13px;
}

.mobile {
    font-family: monospace;
}

.btn-generate, .btn-preview, .btn-print {
    flex: 1;
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 14px;
}

.btn-generate {
    background: #3498db;
    color: white;
}

.btn-preview {
    background: #95a5a6;
    color: white;
}

.btn-print {
    background: #27ae60;
    color: white;
}

.bulk-actions {
    text-align: center;
    padding: 20px;
    border-top: 1px solid #ddd;
}

.btn-bulk, .btn-bulk-print {
    margin: 0 10px;
    padding: 10px 20px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
}

.btn-bulk {
    background: #95a5a6;
    color: white;
}

.btn-bulk-print {
    background: #e74c3c;
    color: white;
}

.modal {
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
    display: flex;
    align-items: center;
    justify-content: center;
}

.id-preview-content {
    background: white;
    border-radius: 8px;
    max-width: 600px;
    width: 90%;
    max-height: 90%;
    overflow-y: auto;
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-body {
    padding: 20px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #ddd;
    text-align: right;
}

.id-card {
    width: 350px;
    height: 220px;
    border: 2px solid #333;
    border-radius: 10px;
    padding: 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    position: relative;
    margin: 0 auto;
    font-family: Arial, sans-serif;
}

.id-card .school-name {
    text-align: center;
    font-size: 16px;
    font-weight: bold;
    margin-bottom: 10px;
}

.id-card .student-photo {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: #fff;
    margin: 0 auto 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #333;
    font-size: 12px;
    overflow: hidden;
}

.id-card .student-photo img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
}

.id-card .student-details {
    text-align: center;
}

.id-card .student-name {
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 5px;
}

.id-card .student-class {
    font-size: 14px;
    margin-bottom: 3px;
}

.id-card .student-roll {
    font-size: 12px;
}

.close {
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    color: #aaa;
}

.close:hover {
    color: #000;
}

.btn-secondary {
    background: #95a5a6;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    margin-left: 10px;
}
</style>

<script>
let selectedStudents = new Set();

// Array of available student photos
const studentPhotos = [
    '/static/img/students/images (1).jpg',
    '/static/img/students/images (2).jpg',
    '/static/img/students/images (3).jpg',
    '/static/img/students/images (4).jpg',
    '/static/img/students/images (5).jpg',
    '/static/img/students/images (6).jpg',
    '/static/img/students/images (7).jpg',
    '/static/img/students/images (8).jpg',
    '/static/img/students/images (9).jpg',
    '/static/img/students/images (10).jpg',
    '/static/img/students/VII-C-JASWANTH-N.jpg',
    '/static/img/students/8c11dd4a7110a437722370c4663f80ec.jpg',
    '/static/img/students/a37be5b9709175f1527761157463ec38.jpg'
];

function getRandomStudentPhoto() {
    return studentPhotos[Math.floor(Math.random() * studentPhotos.length)];
}

function generateID(studentId) {
    window.open(`/print-id-cards/?student_ids=${studentId}`, '_blank', 'width=1200,height=900,scrollbars=yes,resizable=yes');
}

function searchStudents() {
    const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
    const selectedClass = document.getElementById('classFilter').value;
    const studentRows = document.querySelectorAll('.student-row');
    
    studentRows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const studentClass = row.querySelector('.student-class').textContent;
        
        const matchesSearch = text.includes(searchTerm);
        const matchesClass = selectedClass === '' || studentClass === selectedClass;
        
        if (matchesSearch && matchesClass) {
            row.style.display = 'table-row';
        } else {
            row.style.display = 'none';
        }
    });
}

function filterByClass() {
    searchStudents();
}

function previewID(studentId) {
    // Get student data
    const studentRow = document.querySelector(`[data-student-id="${studentId}"]`);
    const studentName = studentRow.querySelector('.student-name').textContent;
    const studentClass = studentRow.querySelector('.student-class').textContent;
    const studentSection = studentRow.querySelector('.student-section').textContent;
    const studentRoll = studentRow.querySelector('.student-roll').textContent;
    const classInfo = `Class: ${studentClass} - ${studentSection}`;
    const rollInfo = `Roll: ${studentRoll}`;
    
    // Get random photo URL
    const photoUrl = getRandomStudentPhoto();
    
    // Generate ID card HTML
    const idCardHTML = `
        <div class="school-name">EVEREST ACADEMY</div>
        <div class="student-photo">
            <img src="${photoUrl}" alt="Student Photo" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">
        </div>
        <div class="student-details">
            <div class="student-name">${studentName}</div>
            <div class="student-class">${classInfo}</div>
            <div class="student-roll">${rollInfo}</div>
        </div>
    `;
    
    document.getElementById('idCardPreview').innerHTML = idCardHTML;
    document.getElementById('idPreviewModal').style.display = 'flex';
}

function closePreview() {
    document.getElementById('idPreviewModal').style.display = 'none';
}

function printID(studentId) {
    previewID(studentId);
    setTimeout(() => {
        printCurrentID();
    }, 500);
}

function printCurrentID() {
    const idCard = document.getElementById('idCardPreview').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Student ID Card</title>
            <style>
                body { margin: 0; padding: 20px; }
                .id-card {
                    width: 350px;
                    height: 220px;
                    border: 2px solid #333;
                    border-radius: 10px;
                    padding: 15px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    position: relative;
                    margin: 0 auto;
                    font-family: Arial, sans-serif;
                }
                .school-name {
                    text-align: center;
                    font-size: 16px;
                    font-weight: bold;
                    margin-bottom: 10px;
                }
                .student-photo {
                    width: 80px;
                    height: 80px;
                    border-radius: 50%;
                    background: #fff;
                    margin: 0 auto 10px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    color: #333;
                    font-size: 12px;
                }
                .student-details {
                    text-align: center;
                }
                .student-name {
                    font-size: 18px;
                    font-weight: bold;
                    margin-bottom: 5px;
                }
                .student-class {
                    font-size: 14px;
                    margin-bottom: 3px;
                }
                .student-roll {
                    font-size: 12px;
                }
            </style>
        </head>
        <body>
            <div class="id-card">${idCard}</div>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
    printWindow.close();
}

function toggleSelectAll() {
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    const checkboxes = document.querySelectorAll('.student-checkbox');
    const rows = document.querySelectorAll('.student-row');
    
    checkboxes.forEach((checkbox, index) => {
        const row = rows[index];
        if (row.style.display !== 'none') {
            checkbox.checked = selectAllCheckbox.checked;
            if (selectAllCheckbox.checked) {
                selectedStudents.add(checkbox.value);
                row.classList.add('selected');
            } else {
                selectedStudents.delete(checkbox.value);
                row.classList.remove('selected');
            }
        }
    });
}

function selectAll() {
    document.getElementById('selectAllCheckbox').checked = true;
    toggleSelectAll();
}

function clearSelection() {
    document.getElementById('selectAllCheckbox').checked = false;
    toggleSelectAll();
}

function bulkPrintIDs() {
    if (selectedStudents.size === 0) {
        alert('Please select students first');
        return;
    }
    
    const studentIds = Array.from(selectedStudents).join(',');
    const validTill = document.getElementById('validTillInput').value || '2082/12/30';
    window.open(`/print-id-cards/?student_ids=${studentIds}&valid_till=${encodeURIComponent(validTill)}`, '_blank', 'width=1200,height=900,scrollbars=yes,resizable=yes');
}

function saveValidTill() {
    const validTill = document.getElementById('validTillInput').value;
    if (!validTill) {
        alert('Please enter a valid till date');
        return;
    }
    
    localStorage.setItem('validTillDate', validTill);
    alert('Valid till date saved successfully!');
}

function bulkPrintOptions() {
    if (selectedStudents.size === 0) {
        alert('Please select students first');
        return;
    }
    
    const studentIds = Array.from(selectedStudents).join(',');
    const options = prompt('Enter print options:\n1 = Classic Blue\n2 = Red\n3 = Green\n4 = Yellow\n5 = White', '1');
    
    if (options) {
        window.open(`/print-id-cards/?student_ids=${studentIds}&template=${options}`, '_blank', 'width=1200,height=900,scrollbars=yes,resizable=yes');
    }
}

// Add click event to student checkboxes for selection
document.addEventListener('DOMContentLoaded', function() {
    const studentCheckboxes = document.querySelectorAll('.student-checkbox');
    studentCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            const studentId = this.value;
            const row = this.closest('.student-row');
            
            if (this.checked) {
                selectedStudents.add(studentId);
                row.classList.add('selected');
            } else {
                selectedStudents.delete(studentId);
                row.classList.remove('selected');
            }
            
            // Update select all checkbox
            const allCheckboxes = document.querySelectorAll('.student-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.student-checkbox:checked');
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            selectAllCheckbox.checked = allCheckboxes.length === checkedCheckboxes.length;
        });
    });
    
    // Search on Enter key
    document.getElementById('studentSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchStudents();
        }
    });
});
</script>
{% endblock %}