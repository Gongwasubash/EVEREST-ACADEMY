{% extends "base.html" %}
{% load static %}

{% block title %}Pending Enquiries - School Management{% endblock %}

{% block content %}
{% csrf_token %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">Pending Enquiries</h4>
                    <small class="text-muted">Total: {{ enquiries.count }} enquiries | Last updated: {% now "Y-m-d H:i:s" %}</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-sm">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 5%">#</th>
                                    <th style="width: 14%">Name</th>
                                    <th style="width: 18%">Email</th>
                                    <th style="width: 11%">Phone</th>
                                    <th style="width: 14%">Subject</th>
                                    <th style="width: 23%">Full Enquiry</th>
                                    <th style="width: 8%">Date</th>
                                    <th style="width: 12%">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for enquiry in enquiries %}
                                <tr onclick="openEnquiryModal({{ enquiry.id }}, '{{ enquiry.name|escapejs }}', '{{ enquiry.email|escapejs }}', '{{ enquiry.phone|default:"-"|escapejs }}', '{{ enquiry.subject|escapejs }}', '{{ enquiry.enquiry|escapejs }}', '{{ enquiry.created_at|date:"Y-m-d" }}', '{{ enquiry.status|default:"new" }}')" style="cursor: pointer;">
                                    <td>{{ forloop.counter }}</td>
                                    <td><strong>{{ enquiry.name }}</strong></td>
                                    <td><small>{{ enquiry.email }}</small></td>
                                    <td><small>{{ enquiry.phone|default:"-" }}</small></td>
                                    <td>{{ enquiry.subject }}</td>
                                    <td><small>{{ enquiry.enquiry|truncatewords:15 }}</small></td>
                                    <td><small>{{ enquiry.created_at|date:"M d" }}</small></td>
                                    <td>
                                        <div class="d-flex align-items-center gap-1">
                                            {% if enquiry.status == 'new' %}
                                                <span class="badge bg-success">New</span>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button type="button" class="btn btn-outline-info btn-sm" onclick="quickUpdateEnquiryStatus({{ enquiry.id }}, 'contacted')" title="Mark as Contacted">
                                                        <i class="fas fa-phone"></i>
                                                    </button>
                                                </div>
                                            {% elif enquiry.status == 'contacted' %}
                                                <span class="badge bg-info">Contacted</span>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="quickUpdateEnquiryStatus({{ enquiry.id }}, 'resolved')" title="Mark as Resolved">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                </div>
                                            {% elif enquiry.status == 'resolved' %}
                                                <span class="badge bg-primary">Resolved</span>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button type="button" class="btn btn-outline-secondary btn-sm" onclick="quickUpdateEnquiryStatus({{ enquiry.id }}, 'closed')" title="Mark as Closed">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            {% elif enquiry.status == 'closed' %}
                                                <span class="badge bg-secondary">Closed</span>
                                            {% else %}
                                                <span class="badge bg-warning">{{ enquiry.status|default:"New" }}</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                        No pending enquiries found
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Registration Enquiries Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="card-title mb-0">Student Registration Enquiries</h4>
                    <small class="text-muted">Total: {{ registrations.count }} registrations</small>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered table-sm">
                            <thead class="table-primary">
                                <tr>
                                    <th style="width: 5%">#</th>
                                    <th style="width: 14%">Student Name</th>
                                    <th style="width: 8%">Class</th>
                                    <th style="width: 7%">Gender</th>
                                    <th style="width: 13%">Father Name</th>
                                    <th style="width: 10%">Mobile</th>
                                    <th style="width: 13%">Address</th>
                                    <th style="width: 9%">App. No.</th>
                                    <th style="width: 8%">Date</th>
                                    <th style="width: 14%">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for registration in registrations %}
                                <tr onclick="openRegistrationModal({{ registration.id }}, '{{ registration.name|escapejs }}', '{{ registration.student_class }}', '{{ registration.gender }}', '{{ registration.father_name|escapejs }}', '{{ registration.mother_name|escapejs }}', '{{ registration.mobile }}', '{{ registration.address|escapejs }}', '{{ registration.city|escapejs }}', '{{ registration.dob }}', '{{ registration.religion }}', '{{ registration.application_number }}', '{{ registration.registration_date|date:"Y-m-d" }}', '{{ registration.status }}')" style="cursor: pointer;">
                                    <td>{{ forloop.counter }}</td>
                                    <td><strong>{{ registration.name }}</strong></td>
                                    <td>{{ registration.student_class }}</td>
                                    <td>{{ registration.gender }}</td>
                                    <td>{{ registration.father_name }}</td>
                                    <td><small>{{ registration.mobile }}</small></td>
                                    <td><small>{{ registration.address|truncatewords:3 }}</small></td>
                                    <td><small>{{ registration.application_number }}</small></td>
                                    <td><small>{{ registration.registration_date|date:"M d" }}</small></td>
                                    <td>
                                        <div class="d-flex align-items-center gap-1">
                                            {% if registration.status == 'pending' %}
                                                <span class="badge bg-warning">Pending</span>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="quickUpdateRegistrationStatus({{ registration.id }}, 'approved')" title="Approve Registration">
                                                        <i class="fas fa-check"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger btn-sm" onclick="quickUpdateRegistrationStatus({{ registration.id }}, 'rejected')" title="Reject Registration">
                                                        <i class="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            {% elif registration.status == 'approved' %}
                                                <span class="badge bg-success">Approved</span>
                                            {% elif registration.status == 'rejected' %}
                                                <span class="badge bg-danger">Rejected</span>
                                                <div class="btn-group btn-group-sm" role="group">
                                                    <button type="button" class="btn btn-outline-success btn-sm" onclick="quickUpdateRegistrationStatus({{ registration.id }}, 'approved')" title="Approve Registration">
                                                        <i class="fas fa-undo"></i>
                                                    </button>
                                                </div>
                                            {% else %}
                                                <span class="badge bg-secondary">{{ registration.status }}</span>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="10" class="text-center text-muted py-4">
                                        <i class="fas fa-user-plus fa-2x mb-2"></i><br>
                                        No registration enquiries found
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Contact Enquiry Details Modal -->
<div class="modal fade" id="enquiryModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contact Enquiry Details</h5>
                <button type="button" class="btn-close" onclick="closeEnquiryModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Contact Information</h6>
                        <p><strong>Name:</strong> <span id="modalEnquiryName"></span></p>
                        <p><strong>Email:</strong> <span id="modalEnquiryEmail"></span></p>
                        <p><strong>Phone:</strong> <span id="modalEnquiryPhone"></span></p>
                        <p><strong>Subject:</strong> <span id="modalEnquirySubject"></span></p>
                        <p><strong>Date:</strong> <span id="modalEnquiryDate"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Enquiry Details</h6>
                        <p><strong>Message:</strong></p>
                        <div style="max-height: 150px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 4px;">
                            <span id="modalEnquiryMessage"></span>
                        </div>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <h6>Update Status</h6>
                        <form method="post" action="{% url 'pending_enquiry' %}" onsubmit="console.log('Form submitted with enquiry_id:', document.getElementById('modalEnquiryId').value, 'status:', document.getElementById('modalEnquiryStatus').value);">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="update_enquiry_status">
                            <input type="hidden" name="enquiry_id" id="modalEnquiryId">
                            <div class="form-group mb-3">
                                <select name="status" id="modalEnquiryStatus" class="form-control">
                                    <option value="new">New</option>
                                    <option value="contacted">Contacted</option>
                                    <option value="resolved">Resolved</option>
                                    <option value="closed">Closed</option>
                                </select>
                            </div>
                            <div class="form-group mb-3">
                                <textarea name="remarks" placeholder="Add remarks (optional)" class="form-control" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Status</button>
                            <button type="button" class="btn btn-secondary" onclick="closeEnquiryModal()">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Registration Details Modal -->
<div class="modal fade" id="registrationModal" tabindex="-1" style="display: none;">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Registration Details</h5>
                <button type="button" class="btn-close" onclick="closeRegistrationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Student Information</h6>
                        <p><strong>Name:</strong> <span id="modalName"></span></p>
                        <p><strong>Class:</strong> <span id="modalClass"></span></p>
                        <p><strong>Gender:</strong> <span id="modalGender"></span></p>
                        <p><strong>Date of Birth:</strong> <span id="modalDob"></span></p>
                        <p><strong>Religion:</strong> <span id="modalReligion"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Parent Information</h6>
                        <p><strong>Father Name:</strong> <span id="modalFatherName"></span></p>
                        <p><strong>Mother Name:</strong> <span id="modalMotherName"></span></p>
                        <p><strong>Mobile:</strong> <span id="modalMobile"></span></p>
                        <p><strong>Address:</strong> <span id="modalAddress"></span></p>
                        <p><strong>City:</strong> <span id="modalCity"></span></p>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <h6>Application Details</h6>
                        <p><strong>Application No:</strong> <span id="modalAppNumber"></span></p>
                        <p><strong>Registration Date:</strong> <span id="modalRegDate"></span></p>
                    </div>
                    <div class="col-md-6">
                        <h6>Update Status</h6>
                        <form method="post" action="{% url 'pending_enquiry' %}">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="update_status">
                            <input type="hidden" name="registration_id" id="modalRegistrationId">
                            <div class="form-group mb-3">
                                <select name="status" id="modalStatus" class="form-control">
                                    <option value="pending">Pending</option>
                                    <option value="approved">Approved</option>
                                    <option value="rejected">Rejected</option>
                                </select>
                            </div>
                            <div class="form-group mb-3">
                                <textarea name="remarks" placeholder="Add remarks (optional)" class="form-control" rows="3"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Update Status</button>
                            <button type="button" class="btn btn-secondary" onclick="closeRegistrationModal()">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
}
.modal-dialog {
    position: relative;
    margin: 0;
    max-width: 800px;
    width: 90%;
}
.modal-content {
    background: white;
    border-radius: 8px;
    padding: 0;
}
.modal-header {
    padding: 15px 20px;
    border-bottom: 1px solid #ddd;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
.modal-body {
    padding: 20px;
}
.btn-close {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
}

/* Quick action buttons styling */
.btn-group-sm .btn {
    padding: 0.2rem 0.4rem;
    font-size: 0.75rem;
    line-height: 1.2;
}

.btn-group-sm .btn i {
    font-size: 0.7rem;
}

/* Status column alignment */
td .d-flex {
    align-items: center;
    gap: 0.25rem;
}

/* Ensure badges don't wrap */
.badge {
    white-space: nowrap;
}
</style>

<script>
function openRegistrationModal(id, name, studentClass, gender, fatherName, motherName, mobile, address, city, dob, religion, appNumber, regDate, status) {
    document.getElementById('modalRegistrationId').value = id;
    document.getElementById('modalName').textContent = name;
    document.getElementById('modalClass').textContent = studentClass;
    document.getElementById('modalGender').textContent = gender;
    document.getElementById('modalFatherName').textContent = fatherName;
    document.getElementById('modalMotherName').textContent = motherName;
    document.getElementById('modalMobile').textContent = mobile;
    document.getElementById('modalAddress').textContent = address;
    document.getElementById('modalCity').textContent = city;
    document.getElementById('modalDob').textContent = dob;
    document.getElementById('modalReligion').textContent = religion;
    document.getElementById('modalAppNumber').textContent = appNumber;
    document.getElementById('modalRegDate').textContent = regDate;
    document.getElementById('modalStatus').value = status;
    document.getElementById('registrationModal').style.display = 'block';
}

function openEnquiryModal(id, name, email, phone, subject, enquiry, date, status) {
    console.log('Opening modal for enquiry ID:', id, 'with status:', status);
    document.getElementById('modalEnquiryId').value = id;
    document.getElementById('modalEnquiryName').textContent = name;
    document.getElementById('modalEnquiryEmail').textContent = email;
    document.getElementById('modalEnquiryPhone').textContent = phone;
    document.getElementById('modalEnquirySubject').textContent = subject;
    document.getElementById('modalEnquiryMessage').textContent = enquiry;
    document.getElementById('modalEnquiryDate').textContent = date;
    document.getElementById('modalEnquiryStatus').value = status || 'new';
    console.log('Modal status set to:', document.getElementById('modalEnquiryStatus').value);
    document.getElementById('enquiryModal').style.display = 'block';
}

function closeEnquiryModal() {
    document.getElementById('enquiryModal').style.display = 'none';
}

function closeRegistrationModal() {
    document.getElementById('registrationModal').style.display = 'none';
}

// Quick status update functions
function quickUpdateEnquiryStatus(enquiryId, newStatus) {
    if (confirm(`Are you sure you want to update this enquiry status to ${newStatus.toUpperCase()}?`)) {
        fetch('/api/update-enquiry-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                enquiry_id: enquiryId,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the status.');
        });
    }
}

function quickUpdateRegistrationStatus(registrationId, newStatus) {
    if (confirm(`Are you sure you want to update this registration status to ${newStatus.toUpperCase()}?`)) {
        fetch('/api/update-registration-status/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                registration_id: registrationId,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while updating the status.');
        });
    }
}

window.onclick = function(event) {
    var registrationModal = document.getElementById('registrationModal');
    var enquiryModal = document.getElementById('enquiryModal');
    if (event.target == registrationModal) {
        closeRegistrationModal();
    }
    if (event.target == enquiryModal) {
        closeEnquiryModal();
    }
}
</script>

{% endblock %}